<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Banco Imperial | Premium Banking & Store</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        /* ========================================
        CORE VARIABLES & THEME
        ========================================
        */
        :root {
            --primary: #6c5ce7;
            --primary-dark: #4834d4;
            --secondary: #a29bfe;
            --accent: #00cec9;
            --success: #00b894;
            --danger: #d63031;
            --warning: #fdcb6e;
            
            --bg-body: #f4f6f9;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --border: #dfe6e9;
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(108, 92, 231, 0.1);
            --shadow-lg: 0 16px 48px rgba(108, 92, 231, 0.15);
            
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            
            --font-main: 'Inter', sans-serif;
            --font-head: 'Poppins', sans-serif;
        }

        /* DARK THEME OVERRIDES */
        body.dark-mode {
            --bg-body: #0f1014;
            --bg-card: #181920;
            --bg-sidebar: #131419;
            --text-main: #dfe6e9;
            --text-muted: #b2bec3;
            --border: #2d3436;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.4);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.5);
        }

        /* ========================================
        RESET & BASE STYLES
        ========================================
        */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-main);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            font-size: 14px;
            height: 100vh;
        }

        h1, h2, h3, h4, h5 { font-family: var(--font-head); font-weight: 700; }
        a { text-decoration: none; color: inherit; }
        ul { list-style: none; }
        button { cursor: pointer; border: none; font-family: inherit; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        /* ========================================
        UTILITY CLASSES
        ========================================
        */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .text-center { text-align: center; }
        .text-primary { color: var(--primary); }
        .text-danger { color: var(--danger); }
        .text-success { color: var(--success); }
        .w-full { width: 100%; }
        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-danger { background: var(--danger); color: white; }
        
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .input-group { margin-bottom: 15px; position: relative; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-muted); font-size: 0.85rem; }
        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-body);
            color: var(--text-main);
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        .input-field:focus { border-color: var(--primary); }

        /* ========================================
        LOGIN / REGISTER SCREEN
        ========================================
        */
        #auth-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-body) 0%, var(--bg-card) 100%);
            z-index: 9999;
            padding: 20px;
        }
        .auth-box {
            width: 100%; max-width: 400px;
            text-align: center;
        }
        .auth-logo { font-size: 3rem; margin-bottom: 10px; color: var(--primary); animation: float 3s ease-in-out infinite; }
        .auth-toggle { margin-top: 20px; font-size: 0.9rem; cursor: pointer; color: var(--primary); text-decoration: underline; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* ========================================
        APP LAYOUT
        ========================================
        */
        #app-container { display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        #sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: all 0.3s;
            z-index: 100;
        }
        .brand {
            display: flex; align-items: center; gap: 10px;
            font-size: 1.2rem; font-weight: 700; color: var(--primary);
            margin-bottom: 40px;
        }
        .nav-item {
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; gap: 12px;
            font-weight: 500;
        }
        .nav-item:hover, .nav-item.active { background: rgba(108, 92, 231, 0.1); color: var(--primary); }
        .nav-item i { width: 20px; text-align: center; }

        .user-mini {
            margin-top: auto;
            padding: 15px;
            background: var(--bg-body);
            border-radius: var(--radius-sm);
            display: flex; align-items: center; gap: 10px;
        }
        .user-mini img { width: 40px; height: 40px; border-radius: 50%; background: var(--border); }
        .user-mini div { overflow: hidden; }
        .user-mini h4 { font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* MAIN CONTENT */
        #main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: var(--bg-body);
            position: relative;
        }
        .section-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .page-title h2 { font-size: 1.8rem; }
        .page-title p { color: var(--text-muted); }

        /* DASHBOARD WIDGETS */
        .balance-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 30px;
            border-radius: var(--radius-md);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }
        .balance-card::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 200px; height: 200px; background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .balance-amount { font-size: 2.5rem; font-weight: 700; margin: 10px 0; }
        .balance-actions { display: flex; gap: 15px; margin-top: 20px; }
        .action-btn {
            background: rgba(255,255,255,0.2);
            border: none; color: white; padding: 10px 20px;
            border-radius: var(--radius-sm); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            font-size: 0.8rem; cursor: pointer; transition: background 0.2s;
        }
        .action-btn:hover { background: rgba(255,255,255,0.3); }

        /* STORE GRID */
        .store-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }
        .product-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column;
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .product-img {
            height: 180px;
            background: var(--bg-body);
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: var(--text-muted);
            position: relative;
        }
        .product-badge {
            position: absolute; top: 10px; right: 10px;
            background: var(--accent); color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700;
        }
        .product-info { padding: 15px; flex: 1; display: flex; flex-direction: column; }
        .product-cat { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .product-title { font-weight: 600; margin: 5px 0; font-size: 1.1rem; }
        .product-price { font-size: 1.2rem; color: var(--primary); font-weight: 700; margin-top: auto; }
        .add-cart-btn {
            width: 100%; margin-top: 10px;
            padding: 10px; background: var(--text-main); color: var(--bg-card);
            border-radius: var(--radius-sm); font-weight: 600;
        }
        .add-cart-btn:hover { background: var(--primary); color: white; }

        /* TRANSACTION LIST */
        .transaction-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 0; border-bottom: 1px solid var(--border);
        }
        .t-icon {
            width: 45px; height: 45px; border-radius: 12px;
            background: rgba(108, 92, 231, 0.1); color: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; margin-right: 15px;
        }
        .t-info h4 { font-size: 0.95rem; margin-bottom: 4px; }
        .t-info span { font-size: 0.8rem; color: var(--text-muted); }
        .t-amount { font-weight: 700; }
        .t-amount.plus { color: var(--success); }
        .t-amount.minus { color: var(--danger); }

        /* TOAST NOTIFICATIONS */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--bg-card);
            border-left: 5px solid var(--primary);
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            animation: slideIn 0.3s ease;
            display: flex; align-items: center; justify-content: space-between;
        }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            #app-container { flex-direction: column; }
            #sidebar {
                width: 100%; height: auto; position: fixed; bottom: 0; left: 0;
                flex-direction: row; justify-content: space-around;
                padding: 10px; border-right: none; border-top: 1px solid var(--border);
                background: var(--bg-card);
            }
            .brand, .user-mini { display: none; }
            .nav-item { flex-direction: column; gap: 4px; font-size: 0.7rem; padding: 8px; margin: 0; }
            .nav-item span { display: block; }
            #main-content { padding: 15px; margin-bottom: 70px; }
            .balance-card { padding: 20px; }
            .balance-amount { font-size: 2rem; }
            .hide-mobile { display: none; }
        }
        
        /* CHAT BUBBLE */
        .chat-bubble {
            background: var(--bg-body); padding: 10px 15px; border-radius: 15px;
            margin-bottom: 10px; max-width: 80%; font-size: 0.9rem;
        }
        .chat-bubble.bot { background: rgba(108, 92, 231, 0.1); color: var(--primary); align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-bubble.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        
        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            z-index: 5000; display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--bg-card); width: 90%; max-width: 500px;
            padding: 30px; border-radius: var(--radius-md);
            animation: scaleUp 0.3s ease;
        }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* COLE NO FINAL DA TAG <STYLE> */
.boleto-item {
    padding: 15px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-body);
}
.boleto-info h4 { font-size: 1rem; margin-bottom: 5px; }
.boleto-info span { font-size: 0.8rem; display: block; color: var(--text-muted); }
.status-badge {
    padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase;
}
.status-pendente { background: rgba(253, 203, 110, 0.2); color: var(--warning); }
.status-pago { background: rgba(0, 184, 148, 0.2); color: var(--success); }
.status-cancelado { background: rgba(214, 48, 49, 0.2); color: var(--danger); }
.status-vencido { background: #2d3436; color: white; }
        
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="auth-box card">
            <div class="auth-logo"><i class="fas fa-crown"></i></div>
            <h2 id="auth-title">Banco Imperial</h2>
            <p class="text-muted mb-2">Acesso Exclusivo</p>
            
            <form id="auth-form">
                <div class="input-group text-left">
                    <label>Nome Completo (Apenas Cadastro)</label>
                    <input type="text" id="auth-name" class="input-field hidden" placeholder="Seu nome real">
                </div>
                <div class="input-group text-left">
                    <label>CPF (Apenas números)</label>
                    <input type="text" id="auth-cpf" class="input-field" placeholder="000.000.000-00" maxlength="14">
                </div>
                <div class="input-group text-left">
                    <label>Senha</label>
                    <input type="password" id="auth-pass" class="input-field" placeholder="******">
                </div>
                <button type="submit" class="btn btn-primary w-full">ACESSAR CONTA</button>
            </form>
            
            <div class="auth-toggle" onclick="toggleAuthMode()">Não tem conta? Crie agora.</div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        
        <nav id="sidebar">
            <div class="brand">
                <i class="fas fa-crown"></i> BANCO IMPERIAL
            </div>
            
            <div class="nav-item active" onclick="navigate('home')">
                <i class="fas fa-home"></i> <span>Início</span>
            </div>
            <div class="nav-item" onclick="navigate('pix')">
                <i class="fas fa-qrcode"></i> <span>Área Pix</span>
            </div>
            <div class="nav-item" onclick="navigate('store')">
                <i class="fas fa-shopping-bag"></i> <span>Mercado</span>
            </div>
            <div class="nav-item" onclick="navigate('boletos')">
                <i class="fas fa-file-invoice-dollar"></i> <span>Boletos</span>
            </div>
            <div class="nav-item" onclick="navigate('invest')">
                <i class="fas fa-chart-line"></i> <span>Investir</span>
            </div>
            <div class="nav-item" onclick="navigate('cards')">
                <i class="fas fa-credit-card"></i> <span>Cartões</span>
            </div>
            <div class="nav-item" onclick="navigate('help')">
                <i class="fas fa-headset"></i> <span>Ajuda IA</span>
            </div>
            <div class="nav-item hidden" id="admin-link" onclick="navigate('admin')">
                <i class="fas fa-shield-alt"></i> <span>Admin</span>
            </div>
            
            <div class="user-mini">
                <img src="https://ui-avatars.com/api/?name=User&background=6c5ce7&color=fff" id="user-avatar" alt="User">
                <div>
                    <h4 id="user-name-display">Carregando...</h4>
                    <small id="user-cpf-display" class="text-muted">...</small>
                </div>
            </div>
            <div class="nav-item text-danger mt-2" onclick="auth.logout()">
                <i class="fas fa-sign-out-alt"></i> <span>Sair</span>
            </div>
        </nav>

        <main id="main-content">
            
            <header class="section-header">
                <div class="page-title">
                    <h2 id="page-heading">Visão Geral</h2>
                    <p id="current-date">Carregando data...</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="btn btn-outline" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn btn-primary" onclick="cart.open()">
                        <i class="fas fa-shopping-cart"></i> <span id="cart-count">0</span>
                    </button>
                </div>
            </header>

            <section id="home" class="page-section">
                <div class="balance-card">
                    <p>Saldo Disponível</p>
                    <div class="balance-amount" id="main-balance">R$ 0,00</div>
                    <div class="flex justify-between items-center">
                        <span>Poupança: <strong id="savings-balance">R$ 0,00</strong></span>
                        <span>Cofrinho: <strong id="piggy-balance">R$ 0,00</strong></span>
                    </div>
                    <div class="balance-actions">
                        <button class="action-btn" onclick="navigate('pix')"><i class="fas fa-paper-plane"></i> Pix</button>
                        <button class="action-btn" onclick="openModal('deposit-modal')"><i class="fas fa-piggy-bank"></i> Cofrinho</button>
                        <button class="action-btn" onclick="navigate('store')"><i class="fas fa-shopping-bag"></i> Comprar</button>
                        <button class="action-btn" onclick="navigate('pix')"><i class="fas fa-hand-holding-usd"></i> Cobrar</button>
                    </div>
                </div>

                <h3>Últimas Transações</h3>
                <div class="card mt-2">
                    <div id="transaction-list">
                        <div class="text-center text-muted py-3">Carregando histórico...</div>
                    </div>
                </div>
            </section>

            <section id="pix" class="page-section hidden">
                <div class="grid-2-col" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="card">
                        <h3><i class="fas fa-paper-plane text-primary"></i> Enviar Pix</h3>
                        <form id="pix-send-form" class="mt-2">
                            <div class="input-group">
                                <label>Chave Pix (CPF)</label>
                                <input type="text" id="pix-dest-cpf" class="input-field" placeholder="000.000.000-00">
                            </div>
                            <div class="input-group">
                                <label>Valor (R$)</label>
                                <input type="number" id="pix-amount" class="input-field" placeholder="0.00" step="0.01">
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Transferir Agora</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3><i class="fas fa-qrcode text-primary"></i> Receber Pix</h3>
                        <div class="text-center mt-2">
                            <p class="text-muted">Sua chave Pix é seu CPF</p>
                            <div class="bg-light p-3 rounded mt-2 border" style="font-size: 1.2rem; font-family: monospace;">
                                <span id="my-pix-key">...</span>
                                <button class="btn-sm btn-outline ml-2" onclick="copyPixKey()"><i class="fas fa-copy"></i></button>
                            </div>
                            <div class="mt-4">
                                <i class="fas fa-qrcode" style="font-size: 8rem; color: var(--text-main);"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="store" class="page-section hidden">
                <div class="flex gap-2 mb-2 overflow-auto" id="store-cats">
                    <button class="btn btn-primary btn-sm" onclick="store.filter('all')">Tudo</button>
                    <button class="btn btn-outline btn-sm" onclick="store.filter('Tecnologia')">Tecnologia</button>
                    <button class="btn btn-outline btn-sm" onclick="store.filter('Roupas')">Roupas</button>
                    <button class="btn btn-outline btn-sm" onclick="store.filter('VIP')">VIP/RP</button>
                </div>
                
                <div id="store-container" class="store-grid">
                    </div>
            </section>

            <section id="invest" class="page-section hidden">
                <div class="card text-center">
                    <i class="fas fa-chart-line text-danger" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <h2>High Risk Trading</h2>
                    <p class="text-muted mb-2">Risco extremo: 85% de chance de PERDA / 15% de chance de LUCRO (2x).</p>
                    
                    <div class="input-group" style="max-width: 300px; margin: 20px auto;">
                        <label>Valor do Investimento</label>
                        <input type="number" id="invest-amount" class="input-field" placeholder="Min: R$ 50,00">
                    </div>
                    <button class="btn btn-danger" onclick="bank.invest()">APOSTAR NO MERCADO</button>
                </div>
                <div class="card mt-2">
                    <h3>Histórico de Investimentos</h3>
                    <div id="invest-history"></div>
                </div>
            </section>

            <section id="boletos" class="page-section hidden">
    <div class="section-header">
        <div class="page-title">
            <h2><i class="fas fa-file-invoice"></i> Central de Boletos</h2>
            <p class="text-muted">Gerencie suas faturas e cobranças</p>
        </div>
        <button id="btn-novo-boleto" class="btn btn-primary hidden" onclick="boletoSystem.toggleForm()">
            <i class="fas fa-plus"></i> Novo Boleto
        </button>
    </div>

    <div id="form-criar-boleto" class="card mb-2 hidden" style="border-left: 5px solid var(--primary);">
        <h3>Emitir Novo Boleto</h3>
        <form id="form-boleto" class="mt-2">
            <div class="grid-2-col flex gap-2">
                <div class="input-group w-full">
                    <label>CPF do Pagador (Destino)</label>
                    <input type="text" id="bol-cpf" class="input-field" placeholder="000.000.000-00" maxlength="14">
                </div>
                <div class="input-group w-full">
                    <label>Valor (R$)</label>
                    <input type="number" id="bol-valor" class="input-field" placeholder="0.00">
                </div>
            </div>
            <div class="input-group">
                <label>Descrição / Motivo</label>
                <input type="text" id="bol-desc" class="input-field" placeholder="Ex: Multa de Trânsito / Compra VIP">
            </div>
            <div class="grid-2-col flex gap-2">
                <div class="input-group w-full">
                    <label>Vencimento</label>
                    <input type="date" id="bol-venc" class="input-field">
                </div>
                <div class="input-group w-full">
                    <label>Tipo de Emissão</label>
                    <select id="bol-tipo" class="input-field">
                        <option value="individual">Individual (CPF Específico)</option>
                        <option value="global">GLOBAL (Todos os Usuários)</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-success w-full" onclick="boletoSystem.criar()">EMITIR BOLETO</button>
        </form>
    </div>

    <div class="grid-2-col" style="display: grid; grid-template-columns: 1fr; gap: 20px;">
        
        <div class="card">
            <h3 class="text-warning"><i class="fas fa-clock"></i> Pendentes</h3>
            <div id="lista-boletos-pendentes" class="mt-2">
                <p class="text-muted text-center">Carregando...</p>
            </div>
        </div>

        <div class="card">
            <h3 class="text-success"><i class="fas fa-check-double"></i> Histórico / Pagos</h3>
            <div id="lista-boletos-historico" class="mt-2">
                <p class="text-muted text-center">Nenhum histórico.</p>
            </div>
        </div>
    </div>
</section>
            
            <section id="help" class="page-section hidden">
                <div class="card" style="height: 60vh; display: flex; flex-direction: column;">
                    <div id="chat-window" style="flex: 1; overflow-y: auto; padding: 10px; border-bottom: 1px solid var(--border);">
                        <div class="chat-bubble bot">Olá! Sou a IA do Banco Imperial. Como posso ajudar com Pix, Loja ou Segurança?</div>
                    </div>
                    <div class="flex gap-1 mt-2">
                        <input type="text" id="chat-input" class="input-field" placeholder="Digite sua dúvida...">
                        <button class="btn btn-primary" onclick="helpAI.send()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </section>

            <section id="admin" class="page-section hidden">
                <h2>Painel Administrativo</h2>
                <div class="grid-2-col flex gap-2 mb-2">
                     <button class="btn btn-primary" onclick="admin.renderProductForm()">Novo Produto</button>
                     <button class="btn btn-outline" onclick="admin.viewLogs()">Logs Globais</button>
                </div>
                
                <div class="card" id="admin-panel-content">
                    <h3>Gerenciar Produtos da Loja</h3>
                    <form id="add-product-form" class="mt-2">
                        <div class="input-group"><label>Nome</label><input type="text" id="prod-name" class="input-field"></div>
                        <div class="input-group"><label>Preço</label><input type="number" id="prod-price" class="input-field"></div>
                        <div class="input-group"><label>Categoria</label><input type="text" id="prod-cat" class="input-field"></div>
                        <div class="input-group"><label>Imagem (URL)</label><input type="text" id="prod-img" class="input-field"></div>
                        <button type="button" class="btn btn-success" onclick="admin.addProduct()">Salvar Produto</button>
                    </form>
                </div>
            </section>
            
            <section id="cards" class="page-section hidden">
                <div class="card" style="background: linear-gradient(45deg, #2d3436, #000); color: #fff; height: 200px; max-width: 350px; border-radius: 15px; padding: 20px; position: relative;">
                    <div class="flex justify-between items-center">
                        <span>IMPERIAL BLACK</span>
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div style="margin-top: 40px; font-size: 1.4rem; letter-spacing: 2px; font-family: monospace;">
                        **** **** **** <span id="card-last4">8829</span>
                    </div>
                    <div class="flex justify-between items-center" style="position: absolute; bottom: 20px; left: 20px; right: 20px;">
                        <div>
                            <span style="font-size: 0.6rem; display: block; opacity: 0.7;">TITULAR</span>
                            <span style="font-size: 0.9rem;" id="card-holder">NOME USUARIO</span>
                        </div>
                        <i class="fab fa-cc-mastercard" style="font-size: 2rem;"></i>
                    </div>
                </div>
                <div class="mt-2">
                     <button class="btn btn-outline" onclick="toast('Cartão bloqueado temporariamente', 'success')">Bloquear</button>
                     <button class="btn btn-outline" onclick="toast('Novo cartão virtual gerado', 'success')">Gerar Virtual</button>
                </div>
            </section>

        </main>
    </div>

    <div id="deposit-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeModal('deposit-modal')">
        <div class="modal-content">
            <h3><i class="fas fa-piggy-bank"></i> Meu Cofrinho</h3>
            <p class="text-muted">Guarde dinheiro longe do saldo principal.</p>
            <br>
            <div class="flex gap-2 mb-2">
                <button class="btn btn-outline w-full" onclick="bank.togglePiggyMode('deposit')">Guardar</button>
                <button class="btn btn-outline w-full" onclick="bank.togglePiggyMode('withdraw')">Resgatar</button>
            </div>
            <div class="input-group">
                <label>Valor</label>
                <input type="number" id="piggy-amount" class="input-field">
            </div>
            <button class="btn btn-primary w-full" onclick="bank.handlePiggy()">Confirmar</button>
        </div>
    </div>

    <div id="cart-modal" class="modal-overlay hidden" onclick="if(event.target === this) cart.close()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2">
                <h3>Seu Carrinho</h3>
                <button class="btn-sm btn-danger" onclick="cart.clear()"><i class="fas fa-trash"></i></button>
            </div>
            <div id="cart-items" style="max-height: 300px; overflow-y: auto;">
                </div>
            <hr class="mt-2 mb-2">
            <div class="flex justify-between items-center">
                <strong>Total:</strong>
                <strong id="cart-total" class="text-primary" style="font-size: 1.3rem;">R$ 0,00</strong>
            </div>
            <button class="btn btn-primary w-full mt-2" onclick="store.checkout()">FINALIZAR COMPRA (SALDO)</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        /* ========================================
        FIREBASE CONFIGURATION
        ========================================
        */
        const firebaseConfig = {
            apiKey: "AIzaSyDWat0SS6tRICcLAOmNy843MUoicfTfD8I",
            authDomain: "banco-imperial-default-rtdb.firebaseapp.com",
            databaseURL: "https://banco-imperial-default-rtdb.firebaseio.com",
            projectId: "banco-imperial-default-rtdb",
            storageBucket: "banco-imperial-default-rtdb.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        /* ========================================
        GLOBAL STATE
        ========================================
        */
        let currentUser = null;
        let cartItems = [];
        let isRegistering = false;

        /* ========================================
        UTILS
        ========================================
        */
        const $ = (id) => document.getElementById(id);
        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getTimestamp = () => new Date().toISOString();

        function toast(msg, type = 'success') {
            const container = $('toast-container');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            el.innerHTML = `<span>${msg}</span> <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>`;
            container.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function closeModal(id) { $(id).classList.add('hidden'); }
        function openModal(id) { $(id).classList.remove('hidden'); }

        /* ========================================
        THEME & UI
        ========================================
        */
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            if(theme === 'dark') document.body.classList.add('dark-mode');
            
            // Set Date
            const opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            $('current-date').innerText = new Date().toLocaleDateString('pt-BR', opts);
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('theme', theme);
            // Save preference to Firebase if logged in
            if(currentUser) db.ref(`users/${currentUser.cpf}/theme`).set(theme);
        }

        function navigate(sectionId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            $(sectionId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Highlight nav
            const navMap = { 'home':0, 'pix':1, 'store':2, 'invest':3, 'cards':4, 'help':5, 'boletos':6 };            
                if(navMap[sectionId] !== undefined) document.querySelectorAll('.nav-item')[navMap[sectionId]].classList.add('active');
            $('page-heading').innerText = sectionId === 'home' ? 'Visão Geral' : 
                                          sectionId === 'pix' ? 'Área Pix' : 
                                          sectionId === 'store' ? 'Mercado Imperial' :
                                          sectionId === 'invest' ? 'Investimentos' :
                                          sectionId === 'admin' ? 'Administração' : 'Ajuda';
        }

        /* ========================================
        AUTHENTICATION LOGIC
        ========================================
        */
        function toggleAuthMode() {
            isRegistering = !isRegistering;
            $('auth-title').innerText = isRegistering ? 'Criar Conta' : 'Banco Imperial';
            $('auth-name').classList.toggle('hidden');
            document.querySelector('.auth-toggle').innerText = isRegistering ? 'Já tem conta? Faça login.' : 'Não tem conta? Crie agora.';
        }

        const auth = {
            init: () => {
                $('auth-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const cpf = $('auth-cpf').value.replace(/\D/g, '');
                    const pass = $('auth-pass').value;
                    const name = $('auth-name').value;

                    if(cpf.length !== 11) return toast('CPF inválido', 'error');
                    if(!pass) return toast('Digite a senha', 'error');

                    if(isRegistering) {
                        if(!name) return toast('Nome obrigatório', 'error');
                        auth.register(name, cpf, pass);
                    } else {
                        auth.login(cpf, pass);
                    }
                });
            },

            login: async (cpf, pass) => {
                const snap = await db.ref(`users/${cpf}`).get();
                if(snap.exists()) {
                    const data = snap.val();
                    if(data.password === pass) {
                        auth.setSession(data);
                    } else {
                        toast('Senha incorreta', 'error');
                    }
                } else {
                    toast('Usuário não encontrado', 'error');
                }
            },

            register: async (name, cpf, pass) => {
                const snap = await db.ref(`users/${cpf}`).get();
                if(snap.exists()) return toast('CPF já cadastrado', 'error');

                const newUser = {
                    name: name,
                    cpf: cpf,
                    password: pass,
                    balance: 0,
                    savings: 0,
                    piggyBank: 0,
                    role: (pass === '172244' || pass === 'ryan_imperial') ? 'admin' : 'user', // Backdoor for demo
                    createdAt: getTimestamp()
                };

                await db.ref(`users/${cpf}`).set(newUser);
                toast('Conta criada com sucesso!', 'success');
                auth.setSession(newUser);
            },

            setSession: (user) => {
                currentUser = user;
                $('auth-container').classList.add('hidden');
                $('app-container').classList.remove('hidden');
                
                // UI Updates
                $('user-name-display').innerText = user.name;
                $('card-holder').innerText = user.name.toUpperCase();
                $('user-cpf-display').innerText = user.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                $('my-pix-key').innerText = user.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
                $('user-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=6c5ce7&color=fff`;

                // Listeners
                bank.listenToBalance();
                bank.loadHistory();
                store.loadProducts();
                // Adicione esta linha dentro de auth.setSession
boletoSystem.init();


                // Admin Check
                if(user.role === 'admin' || user.password === 'ryan_imperial') {
                    $('admin-link').classList.remove('hidden');
                }

                toast(`Bem-vindo, ${user.name.split(' ')[0]}`, 'success');
            },

            logout: () => {
                location.reload();
            }
        };

        /* ========================================
        BANKING LOGIC (Pix, Cofrinho, Invest)
        ========================================
        */
        let piggyMode = 'deposit'; // or withdraw

        const bank = {
            listenToBalance: () => {
                db.ref(`users/${currentUser.cpf}`).on('value', (snap) => {
                    if(!snap.exists()) return;
                    const data = snap.val();
                    currentUser = data; // Keep local sync
                    
                    // Animate numbers
                    $('main-balance').innerText = formatCurrency(data.balance);
                    $('savings-balance').innerText = formatCurrency(data.savings);
                    $('piggy-balance').innerText = formatCurrency(data.piggyBank);
                });
            },

            loadHistory: () => {
                db.ref(`transactions/${currentUser.cpf}`).limitToLast(10).on('value', (snap) => {
                    const list = $('transaction-list');
                    list.innerHTML = '';
                    if(!snap.exists()) {
                        list.innerHTML = '<div class="text-center text-muted py-3">Sem transações.</div>';
                        return;
                    }

                    const txs = [];
                    snap.forEach(c => txs.push(c.val()));
                    txs.reverse().forEach(tx => {
                        const isPlus = tx.type === 'in';
                        const html = `
                            <div class="transaction-item">
                                <div class="flex items-center">
                                    <div class="t-icon">${isPlus ? '<i class="fas fa-arrow-down"></i>' : '<i class="fas fa-arrow-up"></i>'}</div>
                                    <div class="t-info">
                                        <h4>${tx.title}</h4>
                                        <span>${new Date(tx.date).toLocaleDateString()}</span>
                                    </div>
                                </div>
                                <div class="t-amount ${isPlus ? 'plus' : 'minus'}">
                                    ${isPlus ? '+' : '-'} ${formatCurrency(tx.amount)}
                                </div>
                            </div>
                        `;
                        list.innerHTML += html;
                    });
                });
            },

            sendPix: async () => {
                const destCpf = $('pix-dest-cpf').value.replace(/\D/g, '');
                const amount = parseFloat($('pix-amount').value);

                if(!destCpf || destCpf.length !== 11) return toast('CPF destinatário inválido', 'error');
                if(isNaN(amount) || amount <= 0) return toast('Valor inválido', 'error');
                if(amount > currentUser.balance) return toast('Saldo insuficiente', 'error');
                if(destCpf === currentUser.cpf) return toast('Não pode enviar para si mesmo', 'error');

                // Check dest
                const destSnap = await db.ref(`users/${destCpf}`).get();
                if(!destSnap.exists()) return toast('Chave Pix não encontrada', 'error');

                // Transaction Atomic Logic would be better with cloud functions, but using client-side transactions here:
                
                // 1. Deduct Sender
                const newSenderBal = currentUser.balance - amount;
                await db.ref(`users/${currentUser.cpf}`).update({ balance: newSenderBal });

                // 2. Add Receiver
                const destData = destSnap.val();
                await db.ref(`users/${destCpf}`).update({ balance: destData.balance + amount });

                // 3. Log Sender
                bank.logTransaction(currentUser.cpf, 'out', amount, `Envio Pix para ${destData.name}`);

                // 4. Log Receiver
                bank.logTransaction(destCpf, 'in', amount, `Pix recebido de ${currentUser.name}`);

                toast('Pix enviado com sucesso!', 'success');
                $('pix-send-form').reset();
            },

            togglePiggyMode: (mode) => {
                piggyMode = mode;
                toast(mode === 'deposit' ? 'Modo: Guardar' : 'Modo: Resgatar', 'success');
            },

            handlePiggy: async () => {
                const amount = parseFloat($('piggy-amount').value);
                if(isNaN(amount) || amount <= 0) return toast('Valor inválido', 'error');

                if(piggyMode === 'deposit') {
                    if(amount > currentUser.balance) return toast('Saldo insuficiente', 'error');
                    await db.ref(`users/${currentUser.cpf}`).update({
                        balance: currentUser.balance - amount,
                        piggyBank: (currentUser.piggyBank || 0) + amount
                    });
                    bank.logTransaction(currentUser.cpf, 'out', amount, 'Guardado no Cofrinho');
                } else {
                    if(amount > currentUser.piggyBank) return toast('Saldo no cofrinho insuficiente', 'error');
                    await db.ref(`users/${currentUser.cpf}`).update({
                        balance: currentUser.balance + amount,
                        piggyBank: currentUser.piggyBank - amount
                    });
                    bank.logTransaction(currentUser.cpf, 'in', amount, 'Resgate do Cofrinho');
                }
                closeModal('deposit-modal');
                toast('Cofrinho atualizado!', 'success');
            },

            invest: async () => {
                const amount = parseFloat($('invest-amount').value);
                if(isNaN(amount) || amount < 50) return toast('Mínimo R$ 50,00', 'error');
                if(amount > currentUser.balance) return toast('Saldo insuficiente', 'error');

                // Logic: 15% win
                const win = Math.random() < 0.15;
                let newBalance = currentUser.balance - amount; // deduct wager
                let resultMsg = "";

                if(win) {
                    const profit = amount * 2;
                    newBalance += profit;
                    resultMsg = `<span class="text-success">WIN (+${formatCurrency(profit)})</span>`;
                    bank.logTransaction(currentUser.cpf, 'in', profit - amount, 'Lucro Investimento');
                } else {
                    resultMsg = `<span class="text-danger">LOSS (-${formatCurrency(amount)})</span>`;
                    bank.logTransaction(currentUser.cpf, 'out', amount, 'Perda Investimento');
                }

                await db.ref(`users/${currentUser.cpf}`).update({ balance: newBalance });
                
                const history = $('invest-history');
                history.innerHTML = `<div class="p-2 border-bottom flex justify-between"><span>${new Date().toLocaleTimeString()}</span> ${resultMsg}</div>` + history.innerHTML;
                toast(win ? 'VOCÊ GANHOU!' : 'Você perdeu.', win ? 'success' : 'error');
            },

            logTransaction: (cpf, type, amount, title) => {
                db.ref(`transactions/${cpf}`).push({
                    type, amount, title, date: getTimestamp()
                });
            }
        };

        // Pix Form Listener
        $('pix-send-form').addEventListener('submit', (e) => {
            e.preventDefault();
            bank.sendPix();
        });

        function copyPixKey() {
            navigator.clipboard.writeText(currentUser.cpf);
            toast('Chave Pix copiada!', 'success');
        }

        /* ========================================
        STORE LOGIC
        ========================================
        */
        const store = {
            products: [],

            loadProducts: () => {
                db.ref('products').on('value', (snap) => {
                    const grid = $('store-container');
                    grid.innerHTML = '';
                    store.products = [];
                    
                    if(!snap.exists()) {
                        // Seed default products if empty
                        if(currentUser.role === 'admin') store.seedProducts();
                        grid.innerHTML = '<p class="text-center w-full">Nenhum produto encontrado.</p>';
                        return;
                    }

                    snap.forEach(child => {
                        const p = child.val();
                        p.key = child.key;
                        store.products.push(p);
                        store.renderProduct(p);
                    });
                });
            },

            seedProducts: () => {
                // Default items
                const items = [
                    { name: 'iPhone 15 Pro', price: 8500, category: 'Tecnologia', img: 'fa-mobile-alt' },
                    { name: 'VIP Gold (30d)', price: 50, category: 'VIP', img: 'fa-crown' },
                    { name: 'Notebook Gamer', price: 12000, category: 'Tecnologia', img: 'fa-laptop' },
                    { name: 'Tênis Jordan', price: 1500, category: 'Roupas', img: 'fa-shoe-prints' }
                ];
                items.forEach(i => db.ref('products').push(i));
            },

            renderProduct: (p) => {
                const html = `
                    <div class="product-card" data-cat="${p.category}">
                        <div class="product-img">
                            <i class="fas ${p.img || 'fa-box'}"></i>
                            <span class="product-badge">${p.category}</span>
                        </div>
                        <div class="product-info">
                            <span class="product-cat">${p.category}</span>
                            <div class="product-title">${p.name}</div>
                            <div class="product-price">${formatCurrency(p.price)}</div>
                            <button class="add-cart-btn" onclick="cart.add('${p.key}')">
                                Adicionar
                            </button>
                        </div>
                    </div>
                `;
                $('store-container').innerHTML += html;
            },

            filter: (cat) => {
                const cards = document.querySelectorAll('.product-card');
                cards.forEach(c => {
                    if(cat === 'all' || c.dataset.cat === cat) c.style.display = 'flex';
                    else c.style.display = 'none';
                });
            },

            checkout: async () => {
                const total = cartItems.reduce((acc, item) => acc + (item.price * item.qty), 0);
                if(total === 0) return toast('Carrinho vazio', 'error');
                if(total > currentUser.balance) return toast('Saldo insuficiente', 'error');

                // Process Payment
                await db.ref(`users/${currentUser.cpf}`).update({
                    balance: currentUser.balance - total
                });

                // Log Order
                const orderId = generateId();
                const order = {
                    id: orderId,
                    items: cartItems,
                    total: total,
                    date: getTimestamp(),
                    status: 'Concluído'
                };
                
                db.ref(`orders/${currentUser.cpf}`).push(order);
                bank.logTransaction(currentUser.cpf, 'out', total, `Compra Mercado #${orderId}`);

                // Clear
                cart.clear();
                cart.close();
                toast('Compra realizada com sucesso!', 'success');
            }
        };

        const cart = {
            add: (key) => {
                const prod = store.products.find(p => p.key === key);
                const existing = cartItems.find(i => i.key === key);
                
                if(existing) existing.qty++;
                else cartItems.push({ ...prod, qty: 1 });
                
                cart.updateUI();
                toast(`${prod.name} adicionado!`, 'success');
            },
            
            remove: (key) => {
                cartItems = cartItems.filter(i => i.key !== key);
                cart.updateUI();
            },

            clear: () => {
                cartItems = [];
                cart.updateUI();
            },

            updateUI: () => {
                const count = cartItems.reduce((acc, i) => acc + i.qty, 0);
                $('cart-count').innerText = count;
                
                const list = $('cart-items');
                list.innerHTML = '';
                let total = 0;

                cartItems.forEach(i => {
                    const sub = i.price * i.qty;
                    total += sub;
                    list.innerHTML += `
                        <div class="flex justify-between items-center mb-2 border-bottom pb-2">
                            <div>
                                <strong>${i.name}</strong><br>
                                <small>${i.qty}x ${formatCurrency(i.price)}</small>
                            </div>
                            <div class="text-right">
                                <div>${formatCurrency(sub)}</div>
                                <button class="text-danger" onclick="cart.remove('${i.key}')" style="background:none;">Remover</button>
                            </div>
                        </div>
                    `;
                });
                $('cart-total').innerText = formatCurrency(total);
            },

            open: () => openModal('cart-modal'),
            close: () => closeModal('cart-modal')
        };

        /* ========================================
        ADMIN LOGIC
        ========================================
        */
        const admin = {
            addProduct: () => {
                const name = $('prod-name').value;
                const price = parseFloat($('prod-price').value);
                const cat = $('prod-cat').value;
                const img = $('prod-img').value; // expects icon class or url logic

                if(!name || !price) return toast('Dados inválidos', 'error');

                db.ref('products').push({
                    name, price, category: cat || 'Geral', img: img || 'fa-box'
                });
                
                toast('Produto criado', 'success');
                $('add-product-form').reset();
            },
            renderProductForm: () => {
                $('admin-panel-content').classList.remove('hidden');
            },
            viewLogs: () => {
                // Simplified log view
                toast('Logs disponíveis no console do Firebase', 'success');
            }
        };

        /* ========================================
        AI HELP LOGIC
        ========================================
        */
        const helpAI = {
            send: () => {
                const input = $('chat-input');
                const text = input.value.toLowerCase();
                if(!text) return;

                // Add User Bubble
                helpAI.addBubble(input.value, 'user');
                input.value = '';

                // Simulate processing
                setTimeout(() => {
                    let response = "Desculpe, não entendi. Tente perguntar sobre 'pix', 'saldo', 'loja' ou 'segurança'.";
                    
                    if(text.includes('pix')) response = "O PIX no Banco Imperial é instantâneo. Vá até a aba 'Área Pix', digite o CPF do destinatário e o valor. Lembre-se: transferências são irreversíveis.";
                    else if(text.includes('saldo') || text.includes('dinheiro')) response = "Seu saldo é atualizado em tempo real. Você pode ver seu saldo total, poupança e cofrinho na tela inicial.";
                    else if(text.includes('loja') || text.includes('comprar')) response = "Nossa loja debita diretamente do seu saldo. Basta adicionar ao carrinho e finalizar. Entregamos itens digitais na hora.";
                    else if(text.includes('cofrinho')) response = "O Cofrinho serve para separar dinheiro do saldo principal, evitando gastos acidentais.";
                    else if(text.includes('senha') || text.includes('roubo')) response = "Se sua conta foi comprometida, contate um Admin imediatamente. Nunca passamos senhas por email.";
                    
                    helpAI.addBubble(response, 'bot');
                }, 800);
            },
            
            addBubble: (txt, type) => {
                const win = $('chat-window');
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${type}`;
                bubble.innerText = txt;
                win.appendChild(bubble);
                win.scrollTop = win.scrollHeight;
            }
        };

        // Initialize
        window.addEventListener('load', () => {
            initTheme();
            auth.init();
        });

/* ========================================
   SISTEMA DE BOLETOS (INJECTED)
   ========================================
*/
const boletoSystem = {
    init: () => {
        // Verifica permissões para mostrar botão de criar
        if (currentUser.role === 'admin' || currentUser.cpf === 'DONO_DO_RP') {
            const btn = document.getElementById('btn-novo-boleto');
            if(btn) btn.classList.remove('hidden');
        }
        boletoSystem.listar();
    },

    toggleForm: () => {
        const form = document.getElementById('form-criar-boleto');
        if(form) form.classList.toggle('hidden');
    },

    criar: async () => {
        // 1. Validar Permissão
        if (currentUser.role !== 'admin' && currentUser.password !== '172244') {
            toast('Acesso negado: Apenas Admins criam boletos.', 'error');
            return;
        }

        // 2. Coletar Dados
        const cpfDestino = document.getElementById('bol-cpf').value.replace(/\D/g, '');
        const valor = parseFloat(document.getElementById('bol-valor').value);
        const descricao = document.getElementById('bol-desc').value;
        const vencimento = document.getElementById('bol-venc').value;
        const tipo = document.getElementById('bol-tipo').value; // individual ou global

        // 3. Validações Básicas
        if (!valor || valor <= 0) return toast('Valor inválido.', 'error');
        if (!descricao) return toast('Descrição obrigatória.', 'error');
        if (!vencimento) return toast('Data de vencimento obrigatória.', 'error');

        // Lógica Global vs Individual
        try {

            if (tipo === 'global') {
                if (currentUser.password !== '172244' && currentUser.role !== 'admin') {
                    return toast('Apenas Dono do RP pode emitir boletos globais.', 'error');
                }

                const snap = await db.ref('users').once('value');
                const updates = {};
                let count = 0;
                
                snap.forEach(userSnap => {
                    const u = userSnap.val();
                    
                    // CORREÇÃO: Verifica se o usuário e o CPF existem antes de criar o boleto
                    if (u && u.cpf) {
                        const newId = db.ref('boletos').push().key;
                        const boletoData = {
                            id: newId,
                            cpfDestino: u.cpf,
                            valor: valor,
                            descricao: `[GLOBAL] ${descricao}`,
                            dataCriacao: getTimestamp(),
                            dataVencimento: vencimento,
                            status: 'pendente',
                            criadoPor: currentUser.name,
                            tipo: 'global'
                        };
                        updates[`boletos/${newId}`] = boletoData;
                        count++;
                    }
                });

                if (count > 0) {
                    await db.ref().update(updates);
                    boletoSystem.logAudit('CRIACAO_GLOBAL', `Boleto global de R$${valor} para ${count} usuários.`);
                    toast(`${count} boletos globais enviados!`, 'success');
                } else {
                    toast('Nenhum usuário válido encontrado para emissão.', 'error');
                }

            }


                // Loop perigoso em client-side, mas necessário conforme requisito sem backend
                // Pega todos usuários para criar boleto individual para cada um
                const snap = await db.ref('users').once('value');
                const updates = {};
                
                snap.forEach(userSnap => {
                    const u = userSnap.val();
                    const newId = db.ref('boletos').push().key;
                    const boletoData = {
                        id: newId,
                        cpfDestino: u.cpf,
                        valor: valor,
                        descricao: `[GLOBAL] ${descricao}`,
                        dataCriacao: getTimestamp(),
                        dataVencimento: vencimento,
                        status: 'pendente',
                        criadoPor: currentUser.name,
                        tipo: 'global'
                    };
                    updates[`boletos/${newId}`] = boletoData;
                });

                await db.ref().update(updates);
                boletoSystem.logAudit('CRIACAO_GLOBAL', `Boleto global de R$${valor} criado por ${currentUser.name}`);
                toast('Boletos globais enviados com sucesso!', 'success');

            } else {
                // Individual
                if (cpfDestino.length !== 11) return toast('CPF inválido.', 'error');
                
                // Verifica se usuário existe
                const userCheck = await db.ref(`users/${cpfDestino}`).get();
                if (!userCheck.exists()) return toast('Usuário destino não encontrado.', 'error');

                const newId = db.ref('boletos').push().key;
                const boletoData = {
                    id: newId,
                    cpfDestino: cpfDestino,
                    valor: valor,
                    descricao: descricao,
                    dataCriacao: getTimestamp(),
                    dataVencimento: vencimento,
                    status: 'pendente',
                    criadoPor: currentUser.name,
                    tipo: 'individual'
                };

                await db.ref(`boletos/${newId}`).set(boletoData);
                boletoSystem.logAudit('CRIACAO', `Boleto para ${cpfDestino} valor R$${valor}`);
                toast('Boleto enviado com sucesso!', 'success');
            }

            document.getElementById('form-boleto').reset();
            boletoSystem.toggleForm();

        } catch (err) {
            console.error(err);
            toast('Erro ao criar boleto: ' + err.message, 'error');
        }
    },

    pagar: async (boletoId, valorBoleto) => {
        if (!confirm(`Confirmar pagamento de R$ ${valorBoleto}?`)) return;

        try {
            const boletoRef = db.ref(`boletos/${boletoId}`);
            const boletoSnap = await boletoRef.get();
            const boleto = boletoSnap.val();

            // Validações de Segurança
            if (!boleto) return toast('Boleto não existe.', 'error');
            if (boleto.status !== 'pendente') return toast('Boleto já pago ou cancelado.', 'error');
            if (currentUser.balance < valorBoleto) return toast('Saldo insuficiente.', 'error');

            // 1. Debitar Usuário
            const novoSaldoUser = currentUser.balance - valorBoleto;
            
            // ATUALIZAÇÃO ATÔMICA
            const updates = {};
            updates[`users/${currentUser.cpf}/balance`] = novoSaldoUser;
            updates[`boletos/${boletoId}/status`] = 'pago';
            updates[`boletos/${boletoId}/dataPagamento`] = getTimestamp();

            await db.ref().update(updates);

            // 2. Logs
            bank.logTransaction(currentUser.cpf, 'out', valorBoleto, `Pagamento Boleto: ${boleto.descricao}`);
            boletoSystem.logAudit('PAGAMENTO', `Boleto ${boletoId} pago por ${currentUser.cpf}`);

            toast('Boleto pago com sucesso!', 'success');

        } catch (err) {
            toast('Erro no processamento: ' + err.message, 'error');
        }
    },

    cancelar: async (boletoId) => {
        if (currentUser.role !== 'admin') return toast('Apenas admins podem cancelar.', 'error');
        if (!confirm('Deseja realmente cancelar este boleto?')) return;

        try {
            await db.ref(`boletos/${boletoId}`).update({
                status: 'cancelado',
                canceladoPor: currentUser.name,
                dataCancelamento: getTimestamp()
            });
            boletoSystem.logAudit('CANCELAMENTO', `Boleto ${boletoId} cancelado por admin.`);
            toast('Boleto cancelado.', 'success');
        } catch (err) {
            toast('Erro ao cancelar.', 'error');
        }
    },

    listar: () => {
        // Escuta em tempo real
        db.ref('boletos').on('value', (snapshot) => {
            const listaPendentes = document.getElementById('lista-boletos-pendentes');
            const listaHistorico = document.getElementById('lista-boletos-historico');
            
            if (!listaPendentes || !listaHistorico) return; // Segurança se a aba não estiver carregada

            listaPendentes.innerHTML = '';
            listaHistorico.innerHTML = '';

            if (!snapshot.exists()) {
                listaPendentes.innerHTML = '<p class="text-muted text-center">Nenhum boleto.</p>';
                return;
            }

            snapshot.forEach((child) => {
                const b = child.val();
                const isMine = b.cpfDestino === currentUser.cpf;
                const isAdmin = currentUser.role === 'admin';

                // Filtro: Mostra se for meu OU se eu for admin
                if (isMine || isAdmin) {
                    const statusClass = `status-${b.status.toLowerCase()}`;
                    const icon = b.status === 'pendente' ? 'fa-exclamation-circle' : 'fa-check-circle';
                    
                    // Botão de Ação (Pagar ou Cancelar)
                    let actionBtn = '';
                    if (b.status === 'pendente') {
                        if (isMine) {
                            actionBtn = `<button class="btn btn-success btn-sm" onclick="boletoSystem.pagar('${b.id}', ${b.valor})"><i class="fas fa-barcode"></i> Pagar</button>`;
                        }
                        if (isAdmin) {
                            actionBtn += ` <button class="btn btn-danger btn-sm" onclick="boletoSystem.cancelar('${b.id}')"><i class="fas fa-ban"></i></button>`;
                        }
                    }

                    const html = `
                        <div class="boleto-item">
                            <div class="boleto-info">
                                <h4>${b.descricao}</h4>
                                <span><strong>Valor:</strong> ${formatCurrency(b.valor)}</span>
                                <span><strong>Vence:</strong> ${b.dataVencimento.split('-').reverse().join('/')}</span>
                                <span class="text-muted" style="font-size:0.7rem">Destino: ${b.cpfDestino}</span>
                            </div>
                            <div class="text-right flex flex-col items-center gap-1">
                                <span class="status-badge ${statusClass}">${b.status}</span>
                                <div class="mt-2">${actionBtn}</div>
                            </div>
                        </div>
                    `;

                    if (b.status === 'pendente') {
                        listaPendentes.innerHTML += html;
                    } else {
                        listaHistorico.innerHTML += html;
                    }
                }
            });
        });
    },

    logAudit: (acao, detalhe) => {
        db.ref('auditorias/boletos').push({
            acao,
            detalhe,
            autor: currentUser.cpf,
            timestamp: getTimestamp()
        });
    }
};
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ‘‘ BANCO IMPERIAL ðŸ‘‘</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --imperial-purple: #6a0dad;
            --imperial-purple-dark: #4b0082;
            --imperial-purple-light: #8a2be2;
            --imperial-gold: #ffd700;
            --imperial-white: #ffffff;
            --imperial-black: #0a0a0a;
            --imperial-gray: #f5f5f5;
            --imperial-gray-dark: #333333;
            --imperial-success: #28a745;
            --imperial-danger: #dc3545;
            --imperial-warning: #ffc107;
            --imperial-info: #17a2b8;
            --shadow-lg: 0 10px 30px rgba(106, 13, 173, 0.3);
            --shadow-xl: 0 20px 60px rgba(106, 13, 173, 0.5);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        .dark-theme {
            --imperial-purple: #8a2be2;
            --imperial-purple-dark: #6a0dad;
            --imperial-purple-light: #9b4dff;
            --imperial-white: #121212;
            --imperial-black: #ffffff;
            --imperial-gray: #1a1a1a;
            --imperial-gray-dark: #e0e0e0;
            --glass-bg: rgba(26, 26, 26, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--imperial-gray) 0%, #e6e6fa 100%);
            color: var(--imperial-gray-dark);
            min-height: 100vh;
            transition: var(--transition);
            padding: 20px;
        }

        .dark-theme body {
            background: linear-gradient(135deg, var(--imperial-black) 0%, #2d2d4d 100%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--imperial-purple) 0%, var(--imperial-purple-dark) 100%);
            color: white;
            padding: 25px 40px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            font-size: 2.8rem;
            color: var(--imperial-gold);
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }

        .logo-text {
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: 2px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .theme-toggle {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 50px;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        /* Cards */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 25px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-xl);
        }

        .card-title {
            color: var(--imperial-purple);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid var(--imperial-purple-light);
            padding-bottom: 10px;
        }

        .dark-theme .card-title {
            color: var(--imperial-purple-light);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--imperial-purple) 0%, var(--imperial-purple-dark) 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 6px 20px rgba(106, 13, 173, 0.4);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(106, 13, 173, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--imperial-success) 0%, #1e7e34 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--imperial-danger) 0%, #bd2130 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--imperial-warning) 0%, #d39e00 100%);
        }

        /* Forms */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--imperial-gray-dark);
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border-radius: 12px;
            border: 2px solid #ddd;
            background: var(--imperial-white);
            color: var(--imperial-gray-dark);
            font-size: 1.1rem;
            transition: var(--transition);
        }

        .dark-theme .form-control {
            background: #2a2a2a;
            border-color: #444;
            color: var(--imperial-gray-dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--imperial-purple);
            box-shadow: 0 0 0 3px rgba(106, 13, 173, 0.1);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Balance Cards */
        .balance-card {
            background: linear-gradient(135deg, var(--imperial-purple) 0%, #7b1fa2 100%);
            color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1%, transparent 1%);
            background-size: 20px 20px;
            transform: rotate(30deg);
        }

        .balance-amount {
            font-size: 3.5rem;
            font-weight: 800;
            margin: 15px 0;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .product-card {
            background: var(--imperial-white);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 2px solid #eee;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .dark-theme .product-card {
            background: #2a2a2a;
            border-color: #444;
        }

        .product-card:hover {
            border-color: var(--imperial-purple);
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .product-price {
            color: var(--imperial-success);
            font-size: 1.8rem;
            font-weight: 800;
            margin: 15px 0;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            background: var(--imperial-white);
        }

        .dark-theme .table-responsive {
            background: #2a2a2a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: linear-gradient(135deg, var(--imperial-purple) 0%, var(--imperial-purple-dark) 100%);
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 700;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid #eee;
            color: var(--imperial-gray-dark);
        }

        .dark-theme td {
            border-color: #444;
            color: var(--imperial-gray-dark);
        }

        tr:hover {
            background: rgba(106, 13, 173, 0.05);
        }

        .dark-theme tr:hover {
            background: rgba(138, 43, 226, 0.1);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            background: var(--imperial-white);
            padding: 10px;
            border-radius: 50px;
            margin-bottom: 30px;
            border: 1px solid var(--glass-border);
            flex-wrap: wrap;
        }

        .dark-theme .tabs {
            background: #2a2a2a;
        }

        .tab {
            padding: 15px 30px;
            border-radius: 50px;
            background: transparent;
            border: none;
            color: var(--imperial-gray-dark);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            flex: 1;
            text-align: center;
            min-width: 120px;
        }

        .tab.active {
            background: linear-gradient(135deg, var(--imperial-purple) 0%, var(--imperial-purple-dark) 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(106, 13, 173, 0.4);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--imperial-white);
            border-radius: var(--border-radius);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--glass-border);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-theme .modal-content {
            background: var(--imperial-gray);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            color: var(--imperial-purple);
            font-size: 1.8rem;
            font-weight: 800;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--imperial-gray-dark);
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(106, 13, 173, 0.1);
            color: var(--imperial-purple);
        }

        /* Alerts */
        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: alertSlideIn 0.3s ease-out;
        }

        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.15) 0%, rgba(40, 167, 69, 0.05) 100%);
            border: 2px solid var(--imperial-success);
            color: var(--imperial-success);
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.15) 0%, rgba(220, 53, 69, 0.05) 100%);
            border: 2px solid var(--imperial-danger);
            color: var(--imperial-danger);
        }

        .alert-warning {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 193, 7, 0.05) 100%);
            border: 2px solid var(--imperial-warning);
            color: var(--imperial-warning);
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.15) 0%, rgba(23, 162, 184, 0.05) 100%);
            border: 2px solid var(--imperial-info);
            color: var(--imperial-info);
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            gap: 20px;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(106, 13, 173, 0.1);
            border-top: 6px solid var(--imperial-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .logo-text {
                font-size: 1.8rem;
            }
            
            .balance-amount {
                font-size: 2.5rem;
            }
            
            .tabs {
                flex-direction: column;
                border-radius: var(--border-radius);
            }
            
            .tab {
                border-radius: var(--border-radius);
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        :focus {
            outline: 3px solid var(--imperial-purple-light);
            outline-offset: 3px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .slide-up {
            animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--imperial-gray);
            border-radius: 6px;
        }

        .dark-theme ::-webkit-scrollbar-track {
            background: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--imperial-purple) 0%, var(--imperial-purple-dark) 100%);
            border-radius: 6px;
            border: 3px solid var(--imperial-gray);
        }

        .dark-theme ::-webkit-scrollbar-thumb {
            border-color: #2a2a2a;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--imperial-purple-light) 0%, var(--imperial-purple) 100%);
        }

        /* Status Indicators */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-success {
            background: rgba(40, 167, 69, 0.15);
            color: var(--imperial-success);
        }

        .status-danger {
            background: rgba(220, 53, 69, 0.15);
            color: var(--imperial-danger);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.15);
            color: var(--imperial-warning);
        }

        .status-pending {
            background: rgba(23, 162, 184, 0.15);
            color: var(--imperial-info);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            margin-left: 10px;
        }

        .badge-purple {
            background: linear-gradient(135deg, var(--imperial-purple) 0%, var(--imperial-purple-dark) 100%);
            color: white;
        }

        .badge-gold {
            background: linear-gradient(135deg, var(--imperial-gold) 0%, #ff9500 100%);
            color: var(--imperial-black);
        }

        /* Progress Bars */
        .progress {
            height: 12px;
            background: rgba(106, 13, 173, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--imperial-purple) 0%, var(--imperial-purple-light) 100%);
            border-radius: 6px;
            transition: width 0.6s ease;
        }

        /* Icons */
        .icon-large {
            font-size: 3rem;
            color: var(--imperial-purple);
            margin-bottom: 20px;
        }

        .dark-theme .icon-large {
            color: var(--imperial-purple-light);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: var(--imperial-black);
            color: var(--imperial-white);
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: var(--shadow-lg);
        }

        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--imperial-black) transparent transparent transparent;
        }

        /* Confetti Animation */
        .confetti {
            position: fixed;
            width: 15px;
            height: 15px;
            background: var(--imperial-purple);
            top: 0;
            opacity: 0;
            z-index: 9999;
            pointer-events: none;
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        /* High Contrast Support */
        @media (prefers-contrast: high) {
            :root {
                --imperial-purple: #0000ff;
                --imperial-purple-dark: #00008b;
                --imperial-gold: #ff0000;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Tela Inicial -->
        <div id="initialScreen" class="fade-in">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">ðŸ‘‘</div>
                    <div class="logo-text">BANCO IMPERIAL</div>
                </div>
                <button class="theme-toggle" id="themeToggle">
                    <i class="fas fa-sun"></i>
                    <span>Modo Claro</span>
                </button>
            </div>

            <div class="card" style="max-width: 500px; margin: 100px auto;">
                <h2 class="card-title">
                    <i class="fas fa-crown"></i>
                    Sistema BancÃ¡rio Mundial
                </h2>
                
                <div style="text-align: center; margin: 40px 0;">
                    <div class="icon-large">ðŸ‘‘</div>
                    <h3 style="color: var(--imperial-gray-dark); margin-bottom: 10px;">
                        Banco Imperial Global
                    </h3>
                    <p style="color: #666; margin-bottom: 40px;">
                        Sistema financeiro completo em produÃ§Ã£o
                    </p>
                </div>

                <div style="display: flex; flex-direction: column; gap: 20px;">
                    <button class="btn" onclick="showLogin()">
                        <i class="fas fa-sign-in-alt"></i>
                        ENTRAR
                    </button>
                    <button class="btn btn-secondary" onclick="showCreateAccount()">
                        <i class="fas fa-user-plus"></i>
                        CRIAR CONTA
                    </button>
                </div>

                <div style="margin-top: 40px; padding: 20px; background: rgba(106, 13, 173, 0.05); border-radius: 12px;">
                    <p style="color: #666; font-size: 0.9rem; text-align: center;">
                        <i class="fas fa-shield-alt"></i>
                        Sistema em produÃ§Ã£o â€¢ Dados reais protegidos â€¢ CompatÃ­vel com dados existentes
                    </p>
                </div>
            </div>
        </div>

        <!-- Dashboard Principal (Oculto inicialmente) -->
        <div id="dashboard" style="display: none;">
            <div class="header">
                <div class="logo">
                    <div class="logo-icon">ðŸ‘‘</div>
                    <div class="logo-text">BANCO IMPERIAL</div>
                    <div class="badge badge-purple" id="userTypeBadge">CLIENTE</div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="text-align: right;">
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">Bem-vindo,</div>
                        <div style="font-weight: 700; font-size: 1.2rem;" id="userName"></div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6);" id="userCPF"></div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="theme-toggle" id="dashboardThemeToggle">
                            <i class="fas fa-sun"></i>
                        </button>
                        <button class="theme-toggle" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sair
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabs de NavegaÃ§Ã£o -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">
                    <i class="fas fa-home"></i>
                    VisÃ£o Geral
                </button>
                <button class="tab" onclick="showTab('pix')">
                    <i class="fas fa-bolt"></i>
                    PIX
                </button>
                <button class="tab" onclick="showTab('boletos')">
                    <i class="fas fa-barcode"></i>
                    Boletos
                </button>
                <button class="tab" onclick="showTab('market')">
                    <i class="fas fa-shopping-cart"></i>
                    Mercado Imperial
                </button>
                <button class="tab" onclick="showTab('transfer')">
                    <i class="fas fa-exchange-alt"></i>
                    TransferÃªncias
                </button>
                <button class="tab" onclick="showTab('history')">
                    <i class="fas fa-history"></i>
                    HistÃ³rico
                </button>
                <button class="tab" onclick="showTab('admin')" id="adminTab" style="display: none;">
                    <i class="fas fa-shield-alt"></i>
                    AdministraÃ§Ã£o
                </button>
            </div>

            <!-- Alerts Container -->
            <div id="alertsContainer"></div>

            <!-- ConteÃºdo das Tabs -->
            <div id="tabContent">
                <!-- VisÃ£o Geral -->
                <div id="overviewTab" class="tab-content">
                    <div class="dashboard-grid">
                        <div class="balance-card">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-size: 1rem; opacity: 0.9;">Saldo DisponÃ­vel</div>
                                    <div class="balance-amount" id="mainBalance">R$ 0,00</div>
                                    <div style="display: flex; gap: 20px; margin-top: 20px;">
                                        <div>
                                            <div style="font-size: 0.9rem; opacity: 0.8;">PoupanÃ§a</div>
                                            <div style="font-size: 1.5rem; font-weight: 700;" id="savingsBalance">R$ 0,00</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.9rem; opacity: 0.8;">Cofrinho</div>
                                            <div style="font-size: 1.5rem; font-weight: 700;" id="piggyBalance">R$ 0,00</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="font-size: 2rem;">ðŸ‘‘</div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Renda Mensal
                            </h3>
                            <div class="progress">
                                <div class="progress-bar" id="incomeProgress" style="width: 65%"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                                <span>Atual: <strong id="currentIncome">R$ 0,00</strong></span>
                                <span>Meta: <strong>R$ 10.000,00</strong></span>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-shield-alt"></i>
                                SeguranÃ§a
                            </h3>
                            <div style="margin: 20px 0;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>ForÃ§a da Senha</span>
                                    <span class="status status-success">Forte</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span>Ãšltimo Login</span>
                                    <span id="lastLogin">Carregando...</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>VerificaÃ§Ã£o em 2 etapas</span>
                                    <span class="status status-warning">Inativa</span>
                                </div>
                            </div>
                            <button class="btn btn-secondary" style="width: 100%;">
                                <i class="fas fa-lock"></i>
                                ReforÃ§ar SeguranÃ§a
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-clock"></i>
                            TransaÃ§Ãµes Recentes
                        </h3>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>DescriÃ§Ã£o</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTransactions">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-file-invoice-dollar"></i>
                                Boletos Pendentes
                            </h3>
                            <div style="text-align: center; padding: 40px 20px;" id="pendingBoletos">
                                <div style="font-size: 3rem; color: #ddd; margin-bottom: 20px;">
                                    <i class="fas fa-barcode"></i>
                                </div>
                                <p style="color: #666;">Carregando boletos...</p>
                            </div>
                            <button class="btn" onclick="showTab('boletos')" style="width: 100%;">
                                <i class="fas fa-eye"></i>
                                Ver Todos os Boletos
                            </button>
                        </div>

                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-gift"></i>
                                Ofertas Especiais
                            </h3>
                            <div style="text-align: center; padding: 30px 20px;">
                                <div style="font-size: 2.5rem; color: var(--imperial-gold); margin-bottom: 15px;">
                                    ðŸ‘‘
                                </div>
                                <h4 style="color: var(--imperial-gray-dark); margin-bottom: 10px;">
                                    Cliente Imperial
                                </h4>
                                <p style="color: #666; font-size: 0.9rem;">
                                    Taxas reduzidas e benefÃ­cios exclusivos
                                </p>
                            </div>
                            <button class="btn btn-warning" style="width: 100%;">
                                <i class="fas fa-crown"></i>
                                Ativar BenefÃ­cios
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PIX -->
                <div id="pixTab" class="tab-content" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-bolt"></i>
                            TransferÃªncia PIX
                        </h3>
                        
                        <div class="form-group">
                            <label class="form-label">Chave PIX (CPF)</label>
                            <input type="text" class="form-control" id="pixKey" 
                                   placeholder="Digite o CPF do destinatÃ¡rio" 
                                   maxlength="14"
                                   oninput="formatCPF(this)">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control" id="pixAmount" 
                                   placeholder="0,00" step="0.01" min="0.01">
                        </div>

                        <div class="form-group">
                            <label class="form-label">DescriÃ§Ã£o (opcional)</label>
                            <input type="text" class="form-control" id="pixDescription" 
                                   placeholder="Ex: Pagamento de serviÃ§os">
                        </div>

                        <div style="background: rgba(106, 13, 173, 0.05); padding: 20px; border-radius: 12px; margin: 25px 0;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-info-circle" style="color: var(--imperial-purple);"></i>
                                <strong>Resumo da TransferÃªncia</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Valor:</span>
                                <strong id="pixSummaryAmount">R$ 0,00</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Taxa:</span>
                                <strong>R$ 0,00</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; border-top: 2px solid #ddd; padding-top: 8px; margin-top: 8px;">
                                <span>Total:</span>
                                <strong id="pixSummaryTotal">R$ 0,00</strong>
                            </div>
                        </div>

                        <button class="btn" onclick="executePIX()" style="width: 100%;">
                            <i class="fas fa-paper-plane"></i>
                            Realizar TransferÃªncia PIX
                        </button>
                    </div>

                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i>
                            HistÃ³rico PIX
                        </h3>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>DestinatÃ¡rio</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="pixHistory">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Boletos -->
                <div id="boletosTab" class="tab-content" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-barcode"></i>
                            Boletos Governamentais
                        </h3>
                        <p style="color: #666; margin-bottom: 25px;">
                            Governo Federal - Brookasil â€¢ Sistema de cobranÃ§a oficial
                        </p>

                        <div id="boletosList">
                            <!-- Preenchido por JavaScript -->
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-secondary" onclick="generateNewBoleto()">
                                <i class="fas fa-plus"></i>
                                Gerar Novo Boleto
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-file-contract"></i>
                            DÃ­vida Ativa
                        </h3>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>CÃ³digo</th>
                                        <th>Valor Original</th>
                                        <th>Valor Atualizado</th>
                                        <th>Dias em Atraso</th>
                                        <th>AÃ§Ãµes</th>
                                    </tr>
                                </thead>
                                <tbody id="debtTable">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Mercado Imperial -->
                <div id="marketTab" class="tab-content" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-store"></i>
                            Mercado Imperial
                        </h3>
                        <p style="color: #666; margin-bottom: 25px;">
                            Produtos premium â€¢ Empresas â€¢ ImÃ³veis â€¢ Ativos estratÃ©gicos
                        </p>

                        <div class="tabs" style="margin-bottom: 25px;">
                            <button class="tab active" onclick="showMarketCategory('all')">
                                Todos
                            </button>
                            <button class="tab" onclick="showMarketCategory('toys')">
                                Brinquedos
                            </button>
                            <button class="tab" onclick="showMarketCategory('food')">
                                Alimentos
                            </button>
                            <button class="tab" onclick="showMarketCategory('tech')">
                                Tecnologia
                            </button>
                            <button class="tab" onclick="showMarketCategory('clothing')">
                                Roupas
                            </button>
                            <button class="tab" onclick="showMarketCategory('shoes')">
                                TÃªnis
                            </button>
                            <button class="tab" onclick="showMarketCategory('vehicles')">
                                VeÃ­culos
                            </button>
                            <button class="tab" onclick="showMarketCategory('properties')">
                                ImÃ³veis
                            </button>
                            <button class="tab" onclick="showMarketCategory('businesses')">
                                Empresas
                            </button>
                        </div>

                        <div id="marketProducts" class="products-grid">
                            <!-- Preenchido por JavaScript -->
                        </div>

                        <div class="card" style="margin-top: 30px;">
                            <h4 class="card-title">
                                <i class="fas fa-shopping-cart"></i>
                                Carrinho de Compras
                            </h4>
                            <div id="cartItems">
                                <!-- Preenchido por JavaScript -->
                            </div>
                            <div style="border-top: 2px solid #ddd; padding-top: 20px; margin-top: 20px;">
                                <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 700;">
                                    <span>Total:</span>
                                    <span id="cartTotal">R$ 0,00</span>
                                </div>
                                <button class="btn btn-success" onclick="checkoutCart()" style="width: 100%; margin-top: 20px;">
                                    <i class="fas fa-check"></i>
                                    Finalizar Compra
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TransferÃªncias -->
                <div id="transferTab" class="tab-content" style="display: none;">
                    <div class="dashboard-grid">
                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-exchange-alt"></i>
                                TransferÃªncia entre Contas
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">CPF do DestinatÃ¡rio</label>
                                <input type="text" class="form-control" id="transferCPF" 
                                       placeholder="000.000.000-00"
                                       oninput="formatCPF(this)">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Valor (R$)</label>
                                <input type="number" class="form-control" id="transferAmount" 
                                       placeholder="0,00" step="0.01" min="0.01">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Tipo de TransferÃªncia</label>
                                <select class="form-control" id="transferType">
                                    <option value="normal">Normal (D+1)</option>
                                    <option value="fast">RÃ¡pida (InstantÃ¢nea)</option>
                                    <option value="government">Governo Federal</option>
                                </select>
                            </div>

                            <button class="btn" onclick="executeTransfer()" style="width: 100%;">
                                <i class="fas fa-paper-plane"></i>
                                Realizar TransferÃªncia
                            </button>
                        </div>

                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-university"></i>
                                Conta PoupanÃ§a
                            </h3>
                            
                            <div style="text-align: center; margin: 30px 0;">
                                <div class="balance-amount" id="savingsDisplay">R$ 0,00</div>
                                <div style="color: #666; margin-top: 10px;">
                                    Rendimento: 0,5% ao mÃªs
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Valor para Movimentar</label>
                                <input type="number" class="form-control" id="savingsAmount" 
                                       placeholder="0,00" step="0.01">
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="depositToSavings()" style="flex: 1;">
                                    <i class="fas fa-arrow-down"></i>
                                    Depositar
                                </button>
                                <button class="btn btn-danger" onclick="withdrawFromSavings()" style="flex: 1;">
                                    <i class="fas fa-arrow-up"></i>
                                    Sacar
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">
                                <i class="fas fa-piggy-bank"></i>
                                Cofrinho Digital
                            </h3>
                            
                            <div style="text-align: center; margin: 30px 0;">
                                <div class="balance-amount" id="piggyDisplay">R$ 0,00</div>
                                <div style="color: #666; margin-top: 10px;">
                                    Meta: R$ 1.000,00
                                </div>
                                <div class="progress" style="margin: 20px 0;">
                                    <div class="progress-bar" id="piggyProgress" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Valor para Guardar</label>
                                <input type="number" class="form-control" id="piggyAmount" 
                                       placeholder="0,00" step="0.01">
                            </div>

                            <button class="btn" onclick="addToPiggy()" style="width: 100%;">
                                <i class="fas fa-plus"></i>
                                Adicionar ao Cofrinho
                            </button>
                        </div>
                    </div>
                </div>

                <!-- HistÃ³rico -->
                <div id="historyTab" class="tab-content" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i>
                            HistÃ³rico Financeiro Completo
                        </h3>
                        
                        <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                            <input type="date" class="form-control" id="startDate" style="flex: 1;">
                            <input type="date" class="form-control" id="endDate" style="flex: 1;">
                            <select class="form-control" id="filterType" style="flex: 1;">
                                <option value="all">Todos os Tipos</option>
                                <option value="pix">PIX</option>
                                <option value="boleto">Boleto</option>
                                <option value="transfer">TransferÃªncia</option>
                                <option value="purchase">Compra</option>
                                <option value="government">Governo</option>
                            </select>
                            <button class="btn" onclick="filterHistory()">
                                <i class="fas fa-filter"></i>
                                Filtrar
                            </button>
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Tipo</th>
                                        <th>DescriÃ§Ã£o</th>
                                        <th>Valor</th>
                                        <th>Saldo PÃ³s</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="fullHistory">
                                    <!-- Preenchido por JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <div style="display: flex; justify-content: center; margin-top: 30px; gap: 15px;">
                            <button class="btn btn-secondary" onclick="exportHistory('pdf')">
                                <i class="fas fa-file-pdf"></i>
                                Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="exportHistory('csv')">
                                <i class="fas fa-file-csv"></i>
                                Exportar CSV
                            </button>
                            <button class="btn btn-secondary" onclick="printHistory()">
                                <i class="fas fa-print"></i>
                                Imprimir
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AdministraÃ§Ã£o -->
                <div id="adminTabContent" class="tab-content" style="display: none;">
                    <div class="card">
                        <h3 class="card-title">
                            <i class="fas fa-shield-alt"></i>
                            Painel de AdministraÃ§Ã£o
                        </h3>
                        
                        <div class="dashboard-grid">
                            <div class="card">
                                <h4 class="card-title">
                                    <i class="fas fa-users"></i>
                                    Controle de UsuÃ¡rios
                                </h4>
                                <div id="usersList">
                                    <!-- Preenchido por JavaScript -->
                                </div>
                                <button class="btn btn-secondary" onclick="refreshUsers()" style="width: 100%; margin-top: 20px;">
                                    <i class="fas fa-sync"></i>
                                    Atualizar Lista
                                </button>
                            </div>

                            <div class="card">
                                <h4 class="card-title">
                                    <i class="fas fa-chart-bar"></i>
                                    MÃ©tricas do Sistema
                                </h4>
                                <div id="systemMetrics">
                                    <!-- Preenchido por JavaScript -->
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 25px;">
                            <h4 class="card-title">
                                <i class="fas fa-cogs"></i>
                                Ferramentas Administrativas
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                                <button class="btn btn-warning" onclick="runAudit()">
                                    <i class="fas fa-search"></i>
                                    Executar Auditoria
                                </button>
                                <button class="btn btn-danger" onclick="checkFraud()">
                                    <i class="fas fa-user-shield"></i>
                                    Verificar Fraudes
                                </button>
                                <button class="btn" onclick="updateInterestRates()">
                                    <i class="fas fa-percentage"></i>
                                    Atualizar Juros
                                </button>
                                <button class="btn btn-secondary" onclick="viewLogs()">
                                    <i class="fas fa-clipboard-list"></i>
                                    Ver Logs
                                </button>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 25px;">
                            <h4 class="card-title">
                                <i class="fas fa-globe"></i>
                                PIX Global
                            </h4>
                            <div class="form-group">
                                <label class="form-label">Valor para Distribuir (R$)</label>
                                <input type="number" class="form-control" id="globalPixAmount" 
                                       placeholder="0,00" step="0.01" min="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">DestinatÃ¡rio (CPF ou "todos")</label>
                                <input type="text" class="form-control" id="globalPixTarget" 
                                       placeholder="CPF especÃ­fico ou 'todos'">
                            </div>
                            <button class="btn btn-success" onclick="executeGlobalPIX()">
                                <i class="fas fa-bolt"></i>
                                Executar PIX Global
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-sign-in-alt"></i>
                    Entrar no Sistema
                </h3>
                <button class="modal-close" onclick="hideModal('loginModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">CPF</label>
                <input type="text" class="form-control" id="loginCPF" 
                       placeholder="000.000.000-00"
                       oninput="formatCPF(this)"
                       maxlength="14">
            </div>

            <div class="form-group">
                <label class="form-label">Senha</label>
                <input type="password" class="form-control" id="loginPassword" 
                       placeholder="Digite sua senha">
                <div style="text-align: right; margin-top: 8px;">
                    <button type="button" class="btn-text" onclick="togglePassword('loginPassword')" style="font-size: 0.9rem;">
                        <i class="fas fa-eye"></i>
                        Mostrar Senha
                    </button>
                </div>
            </div>

            <div id="loginAttempts" style="display: none; margin: 15px 0; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 8px; color: var(--imperial-danger);">
                <i class="fas fa-exclamation-triangle"></i>
                Tentativas restantes: <span id="attemptsCount">3</span>
            </div>

            <button class="btn" onclick="login()" style="width: 100%; margin-top: 10px;">
                <i class="fas fa-key"></i>
                ENTRAR
            </button>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #ddd;">
                <p style="color: #666; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i>
                    Contas soberanas especiais:
                </p>
            </div>
        </div>
    </div>

    <div id="createAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-plus"></i>
                    Criar Nova Conta
                </h3>
                <button class="modal-close" onclick="hideModal('createAccountModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="form-group">
                <label class="form-label">CPF *</label>
                <input type="text" class="form-control" id="newCPF" 
                       placeholder="000.000.000-00"
                       oninput="formatCPF(this)"
                       maxlength="14">
                <small style="color: #666;">SerÃ¡ usado para login e chave PIX</small>
            </div>

            <div class="form-group">
                <label class="form-label">Nome Completo *</label>
                <input type="text" class="form-control" id="newName" 
                       placeholder="Digite seu nome completo">
            </div>

            <div class="form-group">
                <label class="form-label">Senha *</label>
                <input type="password" class="form-control" id="newPassword" 
                       placeholder="Crie uma senha forte">
                <div class="progress" style="margin-top: 10px;">
                    <div class="progress-bar" id="passwordStrength" style="width: 0%"></div>
                </div>
                <small style="color: #666;">MÃ­nimo 8 caracteres, com nÃºmeros e letras</small>
            </div>

            <div class="form-group">
                <label class="form-label">Confirmar Senha *</label>
                <input type="password" class="form-control" id="confirmPassword" 
                       placeholder="Digite a senha novamente">
            </div>

            <div style="background: rgba(106, 13, 173, 0.05); padding: 20px; border-radius: 12px; margin: 25px 0;">
                <h4 style="color: var(--imperial-purple); margin-bottom: 10px;">
                    <i class="fas fa-file-contract"></i>
                    Termos da Conta
                </h4>
                <div style="max-height: 150px; overflow-y: auto; margin-bottom: 15px;">
                    <p style="font-size: 0.85rem; color: #666; line-height: 1.5;">
                        Ao criar uma conta no Banco Imperial, vocÃª concorda com nossos termos de serviÃ§o, 
                        polÃ­ticas de privacidade e regulamentos financeiros. Todas as transaÃ§Ãµes sÃ£o registradas 
                        e auditÃ¡veis. O sistema opera em tempo real com dados permanentes.
                    </p>
                </div>
                <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="acceptTerms" style="margin-top: 3px;">
                    <span style="font-size: 0.9rem; color: #666;">
                        Concordo com os termos e condiÃ§Ãµes do Banco Imperial
                    </span>
                </label>
            </div>

            <button class="btn" onclick="createAccount()" style="width: 100%;">
                <i class="fas fa-check"></i>
                CRIAR CONTA
            </button>

            <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9rem;">
                <i class="fas fa-shield-alt"></i>
                Sistema em produÃ§Ã£o â€¢ CompatÃ­vel com dados existentes
            </p>
        </div>
    </div>

    <!-- Boleto Details Modal -->
    <div id="boletoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-barcode"></i>
                    Boleto Governamental
                </h3>
                <button class="modal-close" onclick="hideModal('boletoModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="boletoDetails">
                <!-- Preenchido por JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmationTitle"></h3>
                <button class="modal-close" onclick="hideModal('confirmationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="text-align: center; padding: 30px 20px;">
                <div class="icon-large" id="confirmationIcon"></div>
                <h4 id="confirmationMessage" style="margin: 20px 0; color: var(--imperial-gray-dark);"></h4>
                <div id="confirmationDetails" style="background: rgba(106, 13, 173, 0.05); padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;"></div>
            </div>

            <div style="display: flex; gap: 15px;">
                <button class="btn btn-secondary" onclick="hideModal('confirmationModal')" style="flex: 1;">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn" id="confirmActionButton" onclick="confirmAction()" style="flex: 1;">
                    <i class="fas fa-check"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal" style="display: none;">
        <div class="modal-content" style="background: transparent; box-shadow: none; border: none;">
            <div class="loading">
                <div class="loading-spinner"></div>
                <h3 style="color: white; margin-top: 20px;" id="loadingText">Processando...</h3>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURAÃ‡ÃƒO FIREBASE (FIXA - NÃƒO ALTERAR)
        // ============================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDWat0SS6tRICcLAOmNy843MUoicfTfD8I",
            databaseURL: "https://banco-imperial-default-rtdb.firebaseio.com",
            projectId: "banco-imperial"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ============================================================================
        // ESTADO GLOBAL DO SISTEMA
        // ============================================================================
        let currentUser = null;
        let userData = null;
        let userType = 'client';
        let currentTab = 'overview';
        let pendingAction = null;
        let actionData = null;
        let loginAttempts = {};
        let cart = [];
        let products = [];

        // ============================================================================
        // CONSTANTES DO SISTEMA
        // ============================================================================
        const SPECIAL_ACCOUNTS = {
            '172244': { type: 'owner_rp', name: 'ðŸ‘‘ DONO DO RP' },
            'ryan_imperial': { type: 'owner_bank', name: 'ðŸ¦ DONO DO BANCO' },
            'BRK.2026': { type: 'government', name: 'ðŸ›ï¸ GOVERNO FEDERAL' }
        };

        const GOVERNMENT_ACCOUNT = '00000000191';

        // ============================================================================
        // INICIALIZAÃ‡ÃƒO DO SISTEMA
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar tema salvo
            const savedTheme = localStorage.getItem('bankTheme') || 'light';
            setTheme(savedTheme);

            // Verificar sessÃ£o ativa
            const session = localStorage.getItem('bankSession');
            if (session) {
                try {
                    const sessionData = JSON.parse(session);
                    if (sessionData.expires > Date.now()) {
                        currentUser = sessionData.cpf;
                        loadUserData();
                    } else {
                        localStorage.removeItem('bankSession');
                        showAlert('SessÃ£o expirada. FaÃ§a login novamente.', 'warning');
                    }
                } catch (e) {
                    localStorage.removeItem('bankSession');
                }
            }

            // Configurar listeners
            setupEventListeners();
            
            // Carregar produtos
            loadProducts();
            
            // Inicializar contadores de tentativas
            initLoginAttempts();
        });

        // ============================================================================
        // FUNÃ‡Ã•ES DE TEMA
        // ============================================================================
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i><span>Modo Escuro</span>';
                document.getElementById('dashboardThemeToggle').innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                document.body.classList.remove('dark-theme');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i><span>Modo Claro</span>';
                document.getElementById('dashboardThemeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            localStorage.setItem('bankTheme', theme);
        }

        document.getElementById('themeToggle').addEventListener('click', function() {
            const current = localStorage.getItem('bankTheme') || 'light';
            setTheme(current === 'light' ? 'dark' : 'light');
        });

        document.getElementById('dashboardThemeToggle').addEventListener('click', function() {
            const current = localStorage.getItem('bankTheme') || 'light';
            setTheme(current === 'light' ? 'dark' : 'light');
        });

        // ============================================================================
        // FUNÃ‡Ã•ES DE NAVEGAÃ‡ÃƒO
        // ============================================================================
        function showLogin() {
            document.getElementById('initialScreen').style.display = 'none';
            showModal('loginModal');
        }

        function showCreateAccount() {
            document.getElementById('initialScreen').style.display = 'none';
            showModal('createAccountModal');
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
    // Mostrar tela inicial novamente
    if (modalId === 'loginModal' || modalId === 'createAccountModal') {
        document.getElementById('initialScreen').style.display = 'block';
    }
        }

        function showTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remover classe active de todas as tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            if (tabName === 'admin') {
                document.getElementById('adminTabContent').style.display = 'block';
                document.querySelector('[onclick="showTab(\'admin\')"]').classList.add('active');
                if (userType === 'owner_rp' || userType === 'owner_bank') {
                    loadAdminPanel();
                }
            } else {
                document.getElementById(tabName + 'Tab').style.display = 'block';
                document.querySelector('[onclick="showTab(\'' + tabName + '\')"]').classList.add('active');
                
                // Atualizar conteÃºdo da tab
                switch(tabName) {
                    case 'overview':
                        updateOverview();
                        break;
                    case 'pix':
                        loadPIXHistory();
                        break;
                    case 'boletos':
                        loadBoletos();
                        break;
                    case 'market':
                        loadMarketProducts('all');
                        break;
                    case 'history':
                        loadFullHistory();
                        break;
                }
            }
            
            currentTab = tabName;
        }

        // ============================================================================
        // FUNÃ‡Ã•ES DE FORMATO
        // ============================================================================
        function formatCPF(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            if (value.length > 9) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else if (value.length > 6) {
                value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
            } else if (value.length > 3) {
                value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
            }
            input.value = value;
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatDate(date) {
            return new Date(date).toLocaleString('pt-BR');
        }

        // ============================================================================
        // FUNÃ‡Ã•ES DE LOGIN E CONTA
        // ============================================================================
        function initLoginAttempts() {
            loginAttempts = JSON.parse(localStorage.getItem('loginAttempts') || '{}');
        }

        function saveLoginAttempts() {
            localStorage.setItem('loginAttempts', JSON.stringify(loginAttempts));
        }

        function login() {
            const cpf = document.getElementById('loginCPF').value.replace(/\D/g, '');
            const password = document.getElementById('loginPassword').value;
            
            if (!cpf || cpf.length !== 11) {
                showAlert('CPF invÃ¡lido. Digite 11 nÃºmeros.', 'danger');
                return;
            }
            
            if (!password) {
                showAlert('Digite sua senha.', 'danger');
                return;
            }

            // Verificar bloqueio
            if (loginAttempts[cpf] && loginAttempts[cpf].attempts >= 5) {
                const blockTime = loginAttempts[cpf].blockedUntil;
                if (blockTime > Date.now()) {
                    const minutes = Math.ceil((blockTime - Date.now()) / 60000);
                    showAlert(`Conta bloqueada por ${minutes} minutos devido a muitas tentativas falhas.`, 'danger');
                    return;
                }
            }

            showLoading('Verificando credenciais...');

            // Verificar contas especiais primeiro
            if (SPECIAL_ACCOUNTS[password]) {
                const specialAccount = SPECIAL_ACCOUNTS[password];
                if (specialAccount.type === 'owner_rp' || specialAccount.type === 'owner_bank' || specialAccount.type === 'government') {
                    // Login especial
                    currentUser = cpf;
                    userType = specialAccount.type;
                    
                    // Verificar se jÃ¡ existe conta no Firebase
                    database.ref('/users/' + cpf).once('value')
                        .then(snapshot => {
                            if (snapshot.exists()) {
                                userData = snapshot.val();
                            } else {
                                // Criar conta especial se nÃ£o existir
                                userData = {
                                    cpf: cpf,
                                    name: specialAccount.name,
                                    saldo: 999999999.99,
                                    poupanca: 999999999.99,
                                    cofrinho: 999999999.99,
                                    type: specialAccount.type,
                                    created: Date.now(),
                                    lastLogin: Date.now()
                                };
                                
                                database.ref('/users/' + cpf).update(userData);
                            }
                            
                            completeLogin();
                        })
                        .catch(error => {
                            hideLoading();
                            showAlert('Erro ao verificar conta: ' + error.message, 'danger');
                        });
                    
                    return;
                }
            }

            // Login normal
            database.ref('/users/' + cpf).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        hideLoading();
                        recordLoginAttempt(cpf, false);
                        showAlert('Conta nÃ£o encontrada. Crie uma conta primeiro.', 'danger');
                        return;
                    }
                    
                    const user = snapshot.val();
                    
                    if (user.password !== password) {
                        hideLoading();
                        recordLoginAttempt(cpf, false);
                        showAlert('Senha incorreta.', 'danger');
                        return;
                    }
                    
                    // Login bem sucedido
                    currentUser = cpf;
                    userData = user;
                    userType = user.type || 'client';
                    
                    recordLoginAttempt(cpf, true);
                    completeLogin();
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao fazer login: ' + error.message, 'danger');
                });
        }

        function recordLoginAttempt(cpf, success) {
            if (!loginAttempts[cpf]) {
                loginAttempts[cpf] = {
                    attempts: 0,
                    lastAttempt: Date.now(),
                    blockedUntil: 0
                };
            }
            
            if (success) {
                loginAttempts[cpf].attempts = 0;
                loginAttempts[cpf].blockedUntil = 0;
            } else {
                loginAttempts[cpf].attempts++;
                loginAttempts[cpf].lastAttempt = Date.now();
                
                if (loginAttempts[cpf].attempts >= 5) {
                    loginAttempts[cpf].blockedUntil = Date.now() + 30 * 60 * 1000; // 30 minutos
                    showAlert('Conta bloqueada por 30 minutos devido a muitas tentativas falhas.', 'danger');
                }
                
                // Atualizar display de tentativas
                const attemptsDisplay = document.getElementById('loginAttempts');
                const attemptsCount = document.getElementById('attemptsCount');
                if (attemptsDisplay && attemptsCount) {
                    attemptsDisplay.style.display = 'block';
                    attemptsCount.textContent = 5 - loginAttempts[cpf].attempts;
                }
            }
            
            saveLoginAttempts();
            
            // Registrar log no Firebase
            database.ref('/logs').push({
                type: 'login_attempt',
                cpf: cpf,
                success: success,
                attempts: loginAttempts[cpf].attempts,
                timestamp: Date.now(),
                ip: 'web_client'
            });
        }

        function completeLogin() {
            // Atualizar Ãºltimo login
            userData.lastLogin = Date.now();
            database.ref('/users/' + currentUser).update({
                lastLogin: userData.lastLogin
            });
            
            // Criar sessÃ£o
            const sessionData = {
                cpf: currentUser,
                expires: Date.now() + 24 * 60 * 60 * 1000 // 24 horas
            };
            localStorage.setItem('bankSession', JSON.stringify(sessionData));
            
            // Registrar log de sucesso
            database.ref('/logs').push({
                type: 'login_success',
                cpf: currentUser,
                userType: userType,
                timestamp: Date.now(),
                ip: 'web_client'
            });
            
            // Atualizar UI
            hideLoading();
            hideModal('loginModal');
            document.getElementById('initialScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            // Configurar perfil do usuÃ¡rio
            document.getElementById('userName').textContent = userData.name || 'Cliente Imperial';
            document.getElementById('userCPF').textContent = currentUser.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            
            // Atualizar badge do tipo de usuÃ¡rio
            const badge = document.getElementById('userTypeBadge');
            if (userType === 'owner_rp') {
                badge.textContent = 'ðŸ‘‘ DONO DO RP';
                badge.className = 'badge badge-gold';
            } else if (userType === 'owner_bank') {
                badge.textContent = 'ðŸ¦ DONO DO BANCO';
                badge.className = 'badge badge-purple';
            } else if (userType === 'government') {
                badge.textContent = 'ðŸ›ï¸ GOVERNO';
                badge.className = 'badge badge-purple';
            } else {
                badge.textContent = 'CLIENTE';
                badge.className = 'badge badge-purple';
            }
            
            // Mostrar/ocultar tab de admin
            if (userType === 'owner_rp' || userType === 'owner_bank') {
                document.getElementById('adminTab').style.display = 'block';
            }
            
            // Carregar dados iniciais
            updateOverview();
            loadPIXHistory();
            loadBoletos();
            loadMarketProducts('all');
            
            // Limpar campos de login
            document.getElementById('loginCPF').value = '';
            document.getElementById('loginPassword').value = '';
            
            showAlert('Login realizado com sucesso!', 'success');
        }
                
        
function createAccount() {
    const cpf = document.getElementById('newCPF').value.replace(/\D/g, '');
    const name = document.getElementById('newName').value.trim();
    const password = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const acceptTerms = document.getElementById('acceptTerms').checked;
    
    // ValidaÃ§Ãµes
    if (!cpf || cpf.length !== 11) {
        showAlert('CPF invÃ¡lido. Digite 11 nÃºmeros.', 'danger');
        return;
    }
    
    if (!name || name.length < 3) {
        showAlert('Digite um nome vÃ¡lido (mÃ­nimo 3 caracteres).', 'danger');
        return;
    }
    
    if (!password || password.length < 8) {
        showAlert('A senha deve ter no mÃ­nimo 8 caracteres.', 'danger');
        return;
    }
    
    if (password !== confirmPassword) {
        showAlert('As senhas nÃ£o coincidem.', 'danger');
        return;
    }
    
    if (!acceptTerms) {
        showAlert('VocÃª precisa aceitar os termos e condiÃ§Ãµes.', 'warning');
        return;
    }
    
    showLoading('Criando conta...');
    
    // PRIMEIRO: Verificar se CPF jÃ¡ existe
    database.ref('/users/' + cpf).once('value')
        .then(snapshot => {
            if (snapshot.exists()) {
                hideLoading();
                showAlert('CPF jÃ¡ cadastrado. Use a opÃ§Ã£o "Entrar".', 'warning');
                return;
            }
            
            // CPF nÃ£o existe, criar nova conta
            const newUser = {
                cpf: cpf,
                name: name,
                password: password,
                saldo: 0,
                poupanca: 0,
                cofrinho: 0,
                type: 'client',
                created: Date.now(),
                lastLogin: Date.now()
            };
            
            // CRIAR NO /users - usando set() em vez de transaction()
            return database.ref('/users/' + cpf).set(newUser);
        })
        .then(() => {
            // Conta criada com sucesso no /users
            console.log('Conta criada com sucesso em /users/' + cpf);
            
            // Agora criar logs e extrato
            const timestamp = Date.now();
            const updates = {};
            
            // Log de criaÃ§Ã£o de conta
            updates['/logs/' + database.ref().push().key] = {
                type: 'account_created',
                cpf: cpf,
                name: name,
                timestamp: timestamp,
                ip: 'web_client'
            };
            
            // Extrato inicial
            updates['/extratos/' + cpf + '/' + database.ref().push().key] = {
                type: 'account_creation',
                description: 'Abertura de conta',
                amount: 0,
                balance: 0,
                timestamp: timestamp,
                status: 'completed'
            };
            
            // Aplicar updates dos logs e extrato
            return database.ref().update(updates);
        })
        .then(() => {
            hideLoading();
            showAlert('Conta criada com sucesso! FaÃ§a login para continuar.', 'success');
            
            // Limpar formulÃ¡rio
            document.getElementById('newCPF').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('acceptTerms').checked = false;
            
            hideModal('createAccountModal');
            showLogin();
        })
        .catch(error => {
            hideLoading();
            console.error('Erro completo:', error);
            
            if (error.message && error.message.includes('permission')) {
                showAlert('Erro de permissÃ£o no Firebase. Verifique as regras.', 'danger');
            } else {
                showAlert('Erro ao criar conta: ' + error.message, 'danger');
            }
        });
        }
         
        function logout() {
            if (currentUser) {
                // Registrar log de logout
                database.ref('/logs').push({
                    type: 'logout',
                    cpf: currentUser,
                    timestamp: Date.now(),
                    ip: 'web_client'
                });
            }
            
            // Limpar sessÃ£o
            localStorage.removeItem('bankSession');
            currentUser = null;
            userData = null;
            userType = 'client';
            cart = [];
            
            // Resetar UI
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('initialScreen').style.display = 'block';
            
            showAlert('Logout realizado com sucesso.', 'success');
        }

        // ============================================================================
        // FUNÃ‡Ã•ES DE CARREGAMENTO DE DADOS
        // ============================================================================
        function loadUserData() {
            if (!currentUser) return;
            
            database.ref('/users/' + currentUser).on('value', snapshot => {
                if (snapshot.exists()) {
                    userData = snapshot.val();
                    updateBalances();
                    updateRecentTransactions();
                }
            });
        }

        function updateOverview() {
            updateBalances();
            updateRecentTransactions();
            updatePendingBoletos();
            updateLastLogin();
        }

        function updateBalances() {
            if (!userData) return;
            
            document.getElementById('mainBalance').textContent = formatCurrency(userData.saldo || 0);
            document.getElementById('savingsBalance').textContent = formatCurrency(userData.poupanca || 0);
            document.getElementById('piggyBalance').textContent = formatCurrency(userData.cofrinho || 0);
            document.getElementById('savingsDisplay').textContent = formatCurrency(userData.poupanca || 0);
            document.getElementById('piggyDisplay').textContent = formatCurrency(userData.cofrinho || 0);
            
            // Atualizar progresso do cofrinho
            const piggyProgress = ((userData.cofrinho || 0) / 1000) * 100;
            document.getElementById('piggyProgress').style.width = Math.min(piggyProgress, 100) + '%';
            
            // Atualizar renda atual
            const currentIncome = userData.saldo || 0;
            document.getElementById('currentIncome').textContent = formatCurrency(currentIncome);
            const incomeProgress = (currentIncome / 10000) * 100;
            document.getElementById('incomeProgress').style.width = Math.min(incomeProgress, 100) + '%';
        }

        function updateRecentTransactions() {
            if (!currentUser) return;
            
            database.ref('/extratos/' + currentUser)
                .orderByChild('timestamp')
                .limitToLast(5)
                .once('value')
                .then(snapshot => {
                    const tbody = document.getElementById('recentTransactions');
                    tbody.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px;">
                                    Nenhuma transaÃ§Ã£o recente
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    const transactions = [];
                    snapshot.forEach(child => {
                        transactions.unshift(child.val());
                    });
                    
                    transactions.forEach(trans => {
                        const row = document.createElement('tr');
                        
                        let statusClass = 'status-pending';
                        if (trans.status === 'completed') statusClass = 'status-success';
                        if (trans.status === 'failed') statusClass = 'status-danger';
                        if (trans.status === 'pending') statusClass = 'status-warning';
                        
                        row.innerHTML = `
                            <td>${formatDate(trans.timestamp)}</td>
                            <td>${trans.description || 'TransaÃ§Ã£o'}</td>
                            <td style="color: ${trans.amount >= 0 ? 'var(--imperial-success)' : 'var(--imperial-danger)'}; font-weight: 700;">
                                ${formatCurrency(trans.amount)}
                            </td>
                            <td><span class="status ${statusClass}">${trans.status || 'pending'}</span></td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar transaÃ§Ãµes:', error);
                });
        }

        function updatePendingBoletos() {
            if (!currentUser) return;
            
            database.ref('/boletos/' + currentUser)
                .orderByChild('status')
                .equalTo('pending')
                .once('value')
                .then(snapshot => {
                    const container = document.getElementById('pendingBoletos');
                    
                    if (!snapshot.exists() || snapshot.numChildren() === 0) {
                        container.innerHTML = `
                            <div style="font-size: 3rem; color: #ddd; margin-bottom: 20px;">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <p style="color: var(--imperial-success); font-weight: 700;">
                                Nenhum boleto pendente
                            </p>
                        `;
                        return;
                    }
                    
                    let total = 0;
                    snapshot.forEach(child => {
                        const boleto = child.val();
                        total += boleto.valorAtualizado || boleto.valorOriginal || 0;
                    });
                    
                    container.innerHTML = `
                        <div style="font-size: 2.5rem; color: var(--imperial-warning); margin-bottom: 15px;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h4 style="color: var(--imperial-warning); margin-bottom: 10px;">
                            ${snapshot.numChildren()} Boleto(s) Pendente(s)
                        </h4>
                        <p style="color: #666; font-size: 0.9rem;">
                            Total: <strong>${formatCurrency(total)}</strong>
                        </p>
                        <div class="progress" style="margin: 15px 0;">
                            <div class="progress-bar" style="width: 100%; background: linear-gradient(90deg, var(--imperial-warning) 0%, #ff9500 100%);"></div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Erro ao carregar boletos pendentes:', error);
                });
        }

        function updateLastLogin() {
            if (!userData || !userData.lastLogin) return;
            
            const lastLogin = new Date(userData.lastLogin);
            const now = new Date();
            const diff = Math.floor((now - lastLogin) / 1000);
            
            let text = '';
            if (diff < 60) {
                text = 'Agora mesmo';
            } else if (diff < 3600) {
                text = `${Math.floor(diff / 60)} minutos atrÃ¡s`;
            } else if (diff < 86400) {
                text = `${Math.floor(diff / 3600)} horas atrÃ¡s`;
            } else {
                text = lastLogin.toLocaleDateString('pt-BR');
            }
            
            document.getElementById('lastLogin').textContent = text;
        }

        // ============================================================================
        // SISTEMA PIX
        // ============================================================================
        function executePIX() {
            const pixKey = document.getElementById('pixKey').value.replace(/\D/g, '');
            const amount = parseFloat(document.getElementById('pixAmount').value);
            const description = document.getElementById('pixDescription').value.trim();
            
            if (!pixKey || pixKey.length !== 11) {
                showAlert('Chave PIX (CPF) invÃ¡lida.', 'danger');
                return;
            }
            
            if (!amount || amount <= 0) {
                showAlert('Digite um valor vÃ¡lido para a transferÃªncia.', 'danger');
                return;
            }
            
            if (!currentUser || !userData) {
                showAlert('SessÃ£o expirada. FaÃ§a login novamente.', 'danger');
                return;
            }
            
            if (userData.saldo < amount) {
                showAlert('Saldo insuficiente para realizar a transferÃªncia.', 'danger');
                return;
            }
            
            // Verificar se Ã© transferÃªncia para o governo
            if (pixKey === GOVERNMENT_ACCOUNT) {
                showConfirmation(
                    'TransferÃªncia para Governo Federal',
                    'fa-university',
                    `Confirmar transferÃªncia de ${formatCurrency(amount)} para o Governo Federal?`,
                    `Esta Ã© uma transferÃªncia oficial para o Governo Federal - Brookasil.`,
                    () => processPIX(pixKey, amount, description)
                );
            } else {
                showConfirmation(
                    'Confirmar TransferÃªncia PIX',
                    'fa-bolt',
                    `Transferir ${formatCurrency(amount)} para CPF ${pixKey.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}?`,
                    `DescriÃ§Ã£o: ${description || 'Sem descriÃ§Ã£o'}`,
                    () => processPIX(pixKey, amount, description)
                );
            }
        }

        function processPIX(pixKey, amount, description) {
            showLoading('Processando transferÃªncia PIX...');
            
            // Verificar se destinatÃ¡rio existe
            database.ref('/users/' + pixKey).once('value')
                .then(snapshot => {
                    if (!snapshot.exists() && pixKey !== GOVERNMENT_ACCOUNT) {
                        hideLoading();
                        showAlert('DestinatÃ¡rio nÃ£o encontrado.', 'danger');
                        return;
                    }
                    
                    // Processar transferÃªncia
                    const transactionData = {
                        from: currentUser,
                        to: pixKey,
                        amount: amount,
                        description: description || 'TransferÃªncia PIX',
                        type: 'pix',
                        timestamp: Date.now(),
                        status: 'processing'
                    };
                    
                    // Usar transaction para garantir atomicidade
                    const updates = {};
                    const transactionId = database.ref().push().key;
                    
                    // Atualizar saldo do remetente
                    updates['/users/' + currentUser + '/saldo'] = userData.saldo - amount;
                    
                    // Atualizar saldo do destinatÃ¡rio (se nÃ£o for governo)
                    if (pixKey !== GOVERNMENT_ACCOUNT) {
                        database.ref('/users/' + pixKey).once('value')
                            .then(destSnapshot => {
                                const destData = destSnapshot.val();
                                updates['/users/' + pixKey + '/saldo'] = (destData.saldo || 0) + amount;
                                completePIX(updates, transactionData, transactionId);
                            });
                    } else {
                        // Para governo, apenas registrar
                        completePIX(updates, transactionData, transactionId);
                    }
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao processar transferÃªncia: ' + error.message, 'danger');
                });
        }

        function completePIX(updates, transactionData, transactionId) {
            // Adicionar transaÃ§Ã£o ao histÃ³rico
            updates['/transactions/' + transactionId] = transactionData;
            
            // Adicionar ao extrato do remetente
            updates['/extratos/' + currentUser + '/' + transactionId] = {
                type: 'pix_out',
                description: `PIX para ${transactionData.to}`,
                amount: -transactionData.amount,
                balance: userData.saldo - transactionData.amount,
                timestamp: transactionData.timestamp,
                status: 'completed'
            };
            
            // Adicionar ao extrato do destinatÃ¡rio (se nÃ£o for governo)
            if (transactionData.to !== GOVERNMENT_ACCOUNT) {
                updates['/extratos/' + transactionData.to + '/' + transactionId] = {
                    type: 'pix_in',
                    description: `PIX de ${currentUser}`,
                    amount: transactionData.amount,
                    balance: 0, // SerÃ¡ calculado
                    timestamp: transactionData.timestamp,
                    status: 'completed'
                };
            }
            
            // Registrar log antifraude
            updates['/antifraude/' + transactionId] = {
                type: 'pix',
                from: currentUser,
                to: transactionData.to,
                amount: transactionData.amount,
                timestamp: transactionData.timestamp,
                riskLevel: 'low'
            };
            
            // Aplicar todas as atualizaÃ§Ãµes
            database.ref().update(updates)
                .then(() => {
                    transactionData.status = 'completed';
                    database.ref('/transactions/' + transactionId).update({ status: 'completed' });
                    
                    hideLoading();
                    showAlert('TransferÃªncia PIX realizada com sucesso!', 'success');
                    
                    // Atualizar saldo local
                    userData.saldo -= transactionData.amount;
                    updateBalances();
                    
                    // Atualizar histÃ³rico PIX
                    loadPIXHistory();
                    
                    // Limpar formulÃ¡rio
                    document.getElementById('pixKey').value = '';
                    document.getElementById('pixAmount').value = '';
                    document.getElementById('pixDescription').value = '';
                    
                    // Criar confetti
                    createConfetti();
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao processar transferÃªncia: ' + error.message, 'danger');
                });
        }

        function loadPIXHistory() {
            if (!currentUser) return;
            
            database.ref('/extratos/' + currentUser)
                .orderByChild('timestamp')
                .limitToLast(20)
                .once('value')
                .then(snapshot => {
                    const tbody = document.getElementById('pixHistory');
                    tbody.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px;">
                                    Nenhuma transaÃ§Ã£o PIX encontrada
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    const transactions = [];
                    snapshot.forEach(child => {
                        const trans = child.val();
                        if (trans.type.includes('pix')) {
                            transactions.unshift(trans);
                        }
                    });
                    
                    if (transactions.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px;">
                                    Nenhuma transaÃ§Ã£o PIX encontrada
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    transactions.forEach(trans => {
                        const row = document.createElement('tr');
                        
                        const isOutgoing = trans.amount < 0;
                        const statusClass = trans.status === 'completed' ? 'status-success' : 
                                           trans.status === 'pending' ? 'status-warning' : 'status-danger';
                        
                        row.innerHTML = `
                            <td>${formatDate(trans.timestamp)}</td>
                            <td>${isOutgoing ? 'Enviado' : 'Recebido'}</td>
                            <td style="color: ${isOutgoing ? 'var(--imperial-danger)' : 'var(--imperial-success)'}; font-weight: 700;">
                                ${formatCurrency(Math.abs(trans.amount))}
                            </td>
                            <td><span class="status ${statusClass}">${trans.status}</span></td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar histÃ³rico PIX:', error);
                });
        }

        // ============================================================================
        // SISTEMA DE BOLETOS
        // ============================================================================
        function loadBoletos() {
            if (!currentUser) return;
            
            database.ref('/boletos/' + currentUser)
                .orderByChild('dataCriacao')
                .once('value')
                .then(snapshot => {
                    const container = document.getElementById('boletosList');
                    const debtTable = document.getElementById('debtTable');
                    
                    container.innerHTML = '';
                    debtTable.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-barcode" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                                <p>Nenhum boleto encontrado</p>
                            </div>
                        `;
                        
                        debtTable.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px;">
                                    Nenhuma dÃ­vida ativa
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    let hasPending = false;
                    let hasDebt = false;
                    
                    snapshot.forEach(child => {
                        const boleto = child.val();
                        const boletoId = child.key;
                        
                        // Atualizar juros se estiver atrasado
                        updateBoletoInterest(boletoId, boleto);
                        
                        // Card do boleto
                        const card = createBoletoCard(boletoId, boleto);
                        container.appendChild(card);
                        
                        // Adicionar Ã  tabela de dÃ­vida se estiver pendente
                        if (boleto.status === 'pending') {
                            hasPending = true;
                            const row = createDebtTableRow(boletoId, boleto);
                            debtTable.appendChild(row);
                        }
                        
                        if (boleto.status === 'pending' && boleto.diasEmAtraso > 0) {
                            hasDebt = true;
                        }
                    });
                    
                    if (!hasPending) {
                        container.innerHTML += `
                            <div style="text-align: center; padding: 20px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; margin-top: 20px;">
                                <i class="fas fa-check-circle" style="color: var(--imperial-success);"></i>
                                <span style="color: var(--imperial-success); font-weight: 700;">
                                    Todos os boletos estÃ£o em dia!
                                </span>
                            </div>
                        `;
                    }
                    
                    if (!hasDebt) {
                        debtTable.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 40px;">
                                    Nenhuma dÃ­vida ativa
                                </td>
                            </tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar boletos:', error);
                });
        }

        function createBoletoCard(boletoId, boleto) {
            const card = document.createElement('div');
            card.className = 'product-card';
            
            const isOverdue = boleto.diasEmAtraso > 0;
            const statusColor = isOverdue ? 'var(--imperial-danger)' : 
                                boleto.status === 'paid' ? 'var(--imperial-success)' : 'var(--imperial-warning)';
            
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div>
                        <h4 style="color: var(--imperial-gray-dark); margin-bottom: 5px;">
                            ${boleto.titulo || 'Governo Federal - Brookasil'}
                        </h4>
                        <div style="font-size: 0.9rem; color: #666;">
                            Vencimento: ${new Date(boleto.dataVencimento).toLocaleDateString('pt-BR')}
                        </div>
                    </div>
                    <div>
                        <span class="status" style="background: ${statusColor}20; color: ${statusColor};">
                            ${isOverdue ? 'ATRASADO' : boleto.status === 'paid' ? 'PAGO' : 'PENDENTE'}
                        </span>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">Valor Original:</span>
                        <strong>${formatCurrency(boleto.valorOriginal)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #666;">Valor Atual:</span>
                        <strong style="color: ${isOverdue ? 'var(--imperial-danger)' : 'var(--imperial-gray-dark)'}">
                            ${formatCurrency(boleto.valorAtualizado || boleto.valorOriginal)}
                        </strong>
                    </div>
                    ${isOverdue ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--imperial-danger);">Dias em Atraso:</span>
                            <strong style="color: var(--imperial-danger);">${boleto.diasEmAtraso}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--imperial-danger);">Juros Acumulados:</span>
                            <strong style="color: var(--imperial-danger);">
                                ${formatCurrency((boleto.valorAtualizado || boleto.valorOriginal) - boleto.valorOriginal)}
                            </strong>
                        </div>
                    ` : ''}
                </div>
                
                <div style="display: flex; gap: 10px;">
                    ${boleto.status === 'pending' ? `
                        <button class="btn btn-success" onclick="payBoleto('${boletoId}')" style="flex: 1;">
                            <i class="fas fa-check"></i>
                            Pagar
                        </button>
                    ` : ''}
                    <button class="btn btn-secondary" onclick="viewBoletoDetails('${boletoId}')" style="flex: 1;">
                        <i class="fas fa-eye"></i>
                        Detalhes
                    </button>
                </div>
            `;
            
            return card;
        }

        function createDebtTableRow(boletoId, boleto) {
            const row = document.createElement('tr');
            const isOverdue = boleto.diasEmAtraso > 0;
            
            row.innerHTML = `
                <td>${boletoId.substring(0, 8)}</td>
                <td>${formatCurrency(boleto.valorOriginal)}</td>
                <td style="color: ${isOverdue ? 'var(--imperial-danger)' : 'inherit'}">
                    ${formatCurrency(boleto.valorAtualizado || boleto.valorOriginal)}
                </td>
                <td>
                    <span class="status ${isOverdue ? 'status-danger' : 'status-warning'}">
                        ${boleto.diasEmAtraso || 0} dias
                    </span>
                </td>
                <td>
                    <button class="btn" onclick="payBoleto('${boletoId}')">
                        <i class="fas fa-check"></i>
                        Quitar
                    </button>
                </td>
            `;
            
            return row;
        }

        function updateBoletoInterest(boletoId, boleto) {
            if (boleto.status === 'paid') return;
            
            const now = Date.now();
            const dueDate = boleto.dataVencimento;
            const daysLate = Math.max(0, Math.floor((now - dueDate) / (1000 * 60 * 60 * 24)));
            
            if (daysLate > (boleto.diasEmAtraso || 0)) {
                // Calcular juros atualizados
                const dailyInterest = boleto.jurosDiarios || 0.01; // 1% ao dia
                const compoundInterest = boleto.jurosCompostos || true;
                let updatedValue = boleto.valorOriginal;
                
                if (compoundInterest) {
                    updatedValue = boleto.valorOriginal * Math.pow(1 + dailyInterest, daysLate);
                } else {
                    updatedValue = boleto.valorOriginal * (1 + (dailyInterest * daysLate));
                }
                
                // Adicionar multa inicial se houver atraso
                if (daysLate > 0 && boleto.multaInicial) {
                    updatedValue += boleto.multaInicial;
                }
                
                // Atualizar no Firebase
                const updates = {
                    diasEmAtraso: daysLate,
                    valorAtualizado: updatedValue
                };
                
                database.ref('/boletos/' + currentUser + '/' + boletoId).update(updates);
                
                // Registrar log de atualizaÃ§Ã£o
                database.ref('/logs').push({
                    type: 'boleto_interest_update',
                    boletoId: boletoId,
                    cpf: currentUser,
                    daysLate: daysLate,
                    newValue: updatedValue,
                    timestamp: now
                });
            }
        }

        function generateNewBoleto() {
            const valorOriginal = Math.floor(Math.random() * 10000) + 100; // R$ 100 a R$ 10.100
            const now = Date.now();
            const vencimento = now + (Math.floor(Math.random() * 30) + 1) * 24 * 60 * 60 * 1000; // 1 a 30 dias
            const jurosDiarios = 0.01; // 1% ao dia
            const multaInicial = valorOriginal * 0.02; // 2% de multa
            
            const newBoleto = {
                titulo: "Governo Federal - Brookasil",
                valorOriginal: valorOriginal,
                valorAtualizado: valorOriginal,
                multaInicial: multaInicial,
                jurosDiarios: jurosDiarios,
                jurosCompostos: true,
                dataCriacao: now,
                dataVencimento: vencimento,
                diasEmAtraso: 0,
                status: 'pending',
                destino: 'governoFederal',
                codigoBarras: generateBarcode(),
                linhaDigitavel: generateLineDigits()
            };
            
            showConfirmation(
                'Gerar Novo Boleto',
                'fa-barcode',
                `Gerar boleto no valor de ${formatCurrency(valorOriginal)}?`,
                `Vencimento: ${new Date(vencimento).toLocaleDateString('pt-BR')}<br>
                 Juros diÃ¡rios: 1%<br>
                 Multa por atraso: 2%`,
                () => saveNewBoleto(newBoleto)
            );
        }

        function saveNewBoleto(boleto) {
            showLoading('Gerando boleto...');
            
            const boletoId = database.ref().push().key;
            
            database.ref('/boletos/' + currentUser + '/' + boletoId).set(boleto)
                .then(() => {
                    // Registrar log
                    database.ref('/logs').push({
                        type: 'boleto_generated',
                        boletoId: boletoId,
                        cpf: currentUser,
                        amount: boleto.valorOriginal,
                        dueDate: boleto.dataVencimento,
                        timestamp: Date.now()
                    });
                    
                    // Adicionar ao histÃ³rico
                    database.ref('/extratos/' + currentUser + '/' + boletoId).set({
                        type: 'boleto_generated',
                        description: 'Boleto gerado - Governo Federal',
                        amount: -boleto.valorOriginal,
                        balance: userData.saldo,
                        timestamp: boleto.dataCriacao,
                        status: 'pending'
                    });
                    
                    hideLoading();
                    showAlert('Boleto gerado com sucesso!', 'success');
                    loadBoletos();
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao gerar boleto: ' + error.message, 'danger');
                });
        }

        function payBoleto(boletoId) {
            database.ref('/boletos/' + currentUser + '/' + boletoId).once('value')
                .then(snapshot => {
                    const boleto = snapshot.val();
                    
                    if (!boleto) {
                        showAlert('Boleto nÃ£o encontrado.', 'danger');
                        return;
                    }
                    
                    if (boleto.status === 'paid') {
                        showAlert('Este boleto jÃ¡ foi pago.', 'warning');
                        return;
                    }
                    
                    const amount = boleto.valorAtualizado || boleto.valorOriginal;
                    
                    if (userData.saldo < amount) {
                        showAlert('Saldo insuficiente para pagar o boleto.', 'danger');
                        return;
                    }
                    
                    showConfirmation(
                        'Pagamento de Boleto',
                        'fa-barcode',
                        `Pagar boleto no valor de ${formatCurrency(amount)}?`,
                        `TÃ­tulo: ${boleto.titulo}<br>
                         Vencimento: ${new Date(boleto.dataVencimento).toLocaleDateString('pt-BR')}<br>
                         ${boleto.diasEmAtraso > 0 ? `Dias em atraso: ${boleto.diasEmAtraso}<br>` : ''}
                         CÃ³digo: ${boletoId.substring(0, 8)}`,
                        () => processBoletoPayment(boletoId, boleto, amount)
                    );
                })
                .catch(error => {
                    showAlert('Erro ao carregar boleto: ' + error.message, 'danger');
                });
        }

        function processBoletoPayment(boletoId, boleto, amount) {
            showLoading('Processando pagamento...');
            
            const updates = {};
            const now = Date.now();
            const transactionId = database.ref().push().key;
            
            // Atualizar saldo do usuÃ¡rio
            updates['/users/' + currentUser + '/saldo'] = userData.saldo - amount;
            
            // Atualizar status do boleto
            updates['/boletos/' + currentUser + '/' + boletoId + '/status'] = 'paid';
            updates['/boletos/' + currentUser + '/' + boletoId + '/dataPagamento'] = now;
            
            // Transferir para conta do governo
            database.ref('/users/' + GOVERNMENT_ACCOUNT).transaction(current => {
                if (current === null) {
                    return {
                        cpf: GOVERNMENT_ACCOUNT,
                        name: 'Governo Federal - Brookasil',
                        saldo: amount,
                        type: 'government',
                        created: now
                    };
                } else {
                    current.saldo = (current.saldo || 0) + amount;
                    return current;
                }
            });
            
            // Registrar transaÃ§Ã£o
            updates['/transactions/' + transactionId] = {
                type: 'boleto_payment',
                from: currentUser,
                to: GOVERNMENT_ACCOUNT,
                amount: amount,
                boletoId: boletoId,
                timestamp: now,
                status: 'completed'
            };
            
            // Adicionar ao extrato do usuÃ¡rio
            updates['/extratos/' + currentUser + '/' + transactionId] = {
                type: 'boleto_payment',
                description: `Pagamento boleto - ${boleto.titulo}`,
                amount: -amount,
                balance: userData.saldo - amount,
                timestamp: now,
                status: 'completed'
            };
            
            // Adicionar ao extrato do governo
            updates['/extratos/' + GOVERNMENT_ACCOUNT + '/' + transactionId] = {
                type: 'boleto_received',
                description: `Recebimento boleto de ${currentUser}`,
                amount: amount,
                timestamp: now,
                status: 'completed'
            };
            
            // Registrar log
            updates['/logs/' + transactionId] = {
                type: 'boleto_paid',
                boletoId: boletoId,
                cpf: currentUser,
                amount: amount,
                timestamp: now,
                ip: 'web_client'
            };
            
            // Aplicar atualizaÃ§Ãµes
            database.ref().update(updates)
                .then(() => {
                    // Atualizar saldo local
                    userData.saldo -= amount;
                    updateBalances();
                    
                    hideLoading();
                    showAlert('Boleto pago com sucesso!', 'success');
                    loadBoletos();
                    
                    // Criar confetti
                    createConfetti();
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao processar pagamento: ' + error.message, 'danger');
                });
        }

        function viewBoletoDetails(boletoId) {
            database.ref('/boletos/' + currentUser + '/' + boletoId).once('value')
                .then(snapshot => {
                    const boleto = snapshot.val();
                    
                    document.getElementById('boletoDetails').innerHTML = `
                        <div style="margin-bottom: 25px;">
                            <h4 style="color: var(--imperial-purple); margin-bottom: 15px;">
                                ${boleto.titulo}
                            </h4>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                                <div style="font-family: monospace; font-size: 1.2rem; letter-spacing: 2px; text-align: center; margin-bottom: 10px;">
                                    ${boleto.codigoBarras || generateBarcode()}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; text-align: center;">
                                    CÃ³digo de barras
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Valor Original</div>
                                    <div style="font-size: 1.2rem; font-weight: 700;">${formatCurrency(boleto.valorOriginal)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Valor Atual</div>
                                    <div style="font-size: 1.2rem; font-weight: 700; color: ${boleto.diasEmAtraso > 0 ? 'var(--imperial-danger)' : 'inherit'}">
                                        ${formatCurrency(boleto.valorAtualizado || boleto.valorOriginal)}
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Data de Vencimento</div>
                                    <div style="font-size: 1.1rem;">${new Date(boleto.dataVencimento).toLocaleDateString('pt-BR')}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9rem; color: #666;">Status</div>
                                    <div>
                                        <span class="status ${boleto.status === 'paid' ? 'status-success' : boleto.diasEmAtraso > 0 ? 'status-danger' : 'status-warning'}">
                                            ${boleto.status === 'paid' ? 'PAGO' : boleto.diasEmAtraso > 0 ? 'ATRASADO' : 'PENDENTE'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            ${boleto.diasEmAtraso > 0 ? `
                                <div style="background: rgba(220, 53, 69, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                        <i class="fas fa-exclamation-triangle" style="color: var(--imperial-danger);"></i>
                                        <strong style="color: var(--imperial-danger);">BOLETO EM ATRASO</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Dias em atraso:</span>
                                        <strong>${boleto.diasEmAtraso}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Juros acumulados:</span>
                                        <strong>${formatCurrency((boleto.valorAtualizado || boleto.valorOriginal) - boleto.valorOriginal)}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Multa:</span>
                                        <strong>${formatCurrency(boleto.multaInicial || 0)}</strong>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div style="border-top: 1px solid #ddd; padding-top: 20px;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">Linha DigitÃ¡vel</div>
                                <div style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; letter-spacing: 1px;">
                                    ${boleto.linhaDigitavel || generateLineDigits()}
                                </div>
                            </div>
                        </div>
                        
                        ${boleto.status === 'pending' ? `
                            <button class="btn btn-success" onclick="payBoleto('${boletoId}'); hideModal('boletoModal');" style="width: 100%;">
                                <i class="fas fa-check"></i>
                                Pagar Boleto
                            </button>
                        ` : ''}
                    `;
                    
                    showModal('boletoModal');
                })
                .catch(error => {
                    showAlert('Erro ao carregar detalhes do boleto.', 'danger');
                });
        }

        function generateBarcode() {
            let barcode = '';
            for (let i = 0; i < 44; i++) {
                barcode += Math.floor(Math.random() * 10);
            }
            return barcode;
        }

        function generateLineDigits() {
            let line = '';
            for (let i = 0; i < 47; i++) {
                if (i > 0 && i % 5 === 0) line += ' ';
                line += Math.floor(Math.random() * 10);
            }
            return line;
        }

        // ============================================================================
        // MERCADO IMPERIAL
        // ============================================================================
        function loadProducts() {
            products = [
                // Brinquedos
                { id: 'toy1', name: 'Carrinho Hot Wheels Premium', price: 249.90, category: 'toys' },
                { id: 'toy2', name: 'LEGO City Mega Pack', price: 1299.99, category: 'toys' },
                { id: 'toy3', name: 'LEGO Technic Supercar', price: 2999.90, category: 'toys' },
                { id: 'toy4', name: 'Boneca Barbie Signature', price: 1499.99, category: 'toys' },
                { id: 'toy5', name: 'Boneco Marvel Legends', price: 899.90, category: 'toys' },
                { id: 'toy6', name: 'Playmobil City Life', price: 799.99, category: 'toys' },
                { id: 'toy7', name: 'Drone Infantil Mini', price: 1199.90, category: 'toys' },
                { id: 'toy8', name: 'Console PortÃ¡til Infantil', price: 2499.99, category: 'toys' },
                
                // Alimentos
                { id: 'food1', name: 'Arroz Premium 5kg', price: 129.90, category: 'food' },
                { id: 'food2', name: 'FeijÃ£o OrgÃ¢nico 1kg', price: 39.99, category: 'food' },
                { id: 'food3', name: 'Carne Picanha Angus 1kg', price: 299.90, category: 'food' },
                { id: 'food4', name: 'SalmÃ£o Importado 1kg', price: 349.99, category: 'food' },
                { id: 'food5', name: 'Pizza Artesanal Gourmet', price: 119.90, category: 'food' },
                { id: 'food6', name: 'Combo Fast-Food Luxo', price: 159.99, category: 'food' },
                { id: 'food7', name: 'Refrigerante Importado 2L', price: 29.90, category: 'food' },
                { id: 'food8', name: 'EnergÃ©tico Red Bull', price: 24.99, category: 'food' },
                { id: 'food9', name: 'Vinho Italiano Reserva', price: 399.90, category: 'food' },
                { id: 'food10', name: 'Champagne MoÃ«t & Chandon', price: 799.99, category: 'food' },
                
                // Tecnologia
                { id: 'tech1', name: 'iPhone 15 Pro 256GB', price: 14499.90, category: 'tech' },
                { id: 'tech2', name: 'iPhone 15 Pro Max 1TB', price: 19999.99, category: 'tech' },
                { id: 'tech3', name: 'Samsung Galaxy S24 Ultra', price: 15999.90, category: 'tech' },
                { id: 'tech4', name: 'MacBook Pro M3 Max', price: 39999.99, category: 'tech' },
                { id: 'tech5', name: 'Notebook Gamer RTX 4090', price: 44999.90, category: 'tech' },
                { id: 'tech6', name: 'Apple Watch Ultra', price: 7999.99, category: 'tech' },
                { id: 'tech7', name: 'AirPods Pro 2Âª GeraÃ§Ã£o', price: 3999.90, category: 'tech' },
                { id: 'tech8', name: 'Smart TV OLED 75"', price: 24999.99, category: 'tech' },
                { id: 'tech9', name: 'PlayStation 5 Pro', price: 18999.90, category: 'tech' },
                { id: 'tech10', name: 'Xbox Series X', price: 16999.99, category: 'tech' },
                
                // Roupas
                { id: 'cloth1', name: 'Camiseta Gucci Original', price: 3999.90, category: 'clothing' },
                { id: 'cloth2', name: 'Camisa Polo Ralph Lauren', price: 1499.99, category: 'clothing' },
                { id: 'cloth3', name: 'Jaqueta Balenciaga', price: 9999.90, category: 'clothing' },
                { id: 'cloth4', name: 'CalÃ§a Prada', price: 7499.99, category: 'clothing' },
                { id: 'cloth5', name: 'Vestido Dolce & Gabbana', price: 12999.90, category: 'clothing' },
                { id: 'cloth6', name: 'BonÃ© New Era Exclusive', price: 1999.90, category: 'clothing' },
                { id: 'cloth7', name: 'Ã“culos Ray-Ban Aviator', price: 3499.99, category: 'clothing' },
                { id: 'cloth8', name: 'RelÃ³gio Rolex Submariner', price: 99999.90, category: 'clothing' },
                
                // TÃªnis
                { id: 'shoe1', name: 'Air Jordan 1 Mid', price: 4999.90, category: 'shoes' },
                { id: 'shoe2', name: 'Air Jordan 1 High OG', price: 6999.99, category: 'shoes' },
                { id: 'shoe3', name: 'Air Jordan 4 Retro', price: 8999.90, category: 'shoes' },
                { id: 'shoe4', name: 'Air Jordan 11 Retro', price: 9999.99, category: 'shoes' },
                { id: 'shoe5', name: 'Nike Air Force 1 Limited', price: 4499.90, category: 'shoes' },
                { id: 'shoe6', name: 'Adidas Yeezy Boost 350', price: 9999.99, category: 'shoes' },
                { id: 'shoe7', name: 'Balenciaga Triple S', price: 13999.90, category: 'shoes' },
                
                // VeÃ­culos
                { id: 'vehicle1', name: 'Fiat Mobi 2023', price: 299990.90, category: 'vehicles' },
                { id: 'vehicle2', name: 'Chevrolet Onix 2022', price: 389990.99, category: 'vehicles' },
                { id: 'vehicle3', name: 'Toyota Corolla 2021', price: 549990.90, category: 'vehicles' },
                { id: 'vehicle4', name: 'Jeep Compass 2022', price: 699990.99, category: 'vehicles' },
                { id: 'vehicle5', name: 'BMW X5 2021', price: 1499999.90, category: 'vehicles' },
                { id: 'vehicle6', name: 'Porsche Cayenne 2022', price: 2999999.99, category: 'vehicles' },
                { id: 'vehicle7', name: 'Lamborghini HuracÃ¡n', price: 5999999.90, category: 'vehicles' },
                { id: 'vehicle8', name: 'Bugatti Chiron', price: 15999999.99, category: 'vehicles' },
                
                // ImÃ³veis
                { id: 'prop1', name: 'Apartamento Luxo', price: 1499999.90, category: 'properties' },
                { id: 'prop2', name: 'Casa Alto PadrÃ£o', price: 2999999.99, category: 'properties' },
                { id: 'prop3', name: 'MansÃ£o de Luxo', price: 6999999.90, category: 'properties' },
                { id: 'prop4', name: 'Cobertura Triplex', price: 9999999.99, category: 'properties' },
                { id: 'prop5', name: 'Fazenda RP', price: 14999999.90, category: 'properties' },
                { id: 'prop6', name: 'Ilha Particular RP', price: 49999999.99, category: 'properties' },
                
                // Empresas
                { id: 'biz1', name: 'Padaria RP', price: 1299999.90, category: 'businesses' },
                { id: 'biz2', name: 'Mercado RP', price: 2999999.99, category: 'businesses' },
                { id: 'biz3', name: 'Restaurante Premium', price: 4999999.90, category: 'businesses' },
                { id: 'biz4', name: 'Posto de Gasolina RP', price: 6999999.99, category: 'businesses' },
                { id: 'biz5', name: 'Construtora RP', price: 12999999.90, category: 'businesses' },
                { id: 'biz6', name: 'Hospital Privado RP', price: 19999999.99, category: 'businesses' },
                { id: 'biz7', name: 'Banco Regional RP', price: 39999999.90, category: 'businesses' },
                { id: 'biz8', name: 'Banco Nacional RP', price: 99999999.99, category: 'businesses' }
            ];
        }

        function loadMarketProducts(category) {
            const container = document.getElementById('marketProducts');
            container.innerHTML = '';
            
            // Atualizar tabs
            document.querySelectorAll('#marketTab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[onclick="showMarketCategory('${category}')"]`).classList.add('active');
            
            const filteredProducts = category === 'all' 
                ? products 
                : products.filter(p => p.category === category);
            
            filteredProducts.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                card.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--imperial-gray-dark); margin-bottom: 10px;">
                            ${product.name}
                        </h4>
                        <div class="product-price">
                            ${formatCurrency(product.price)}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="addToCart('${product.id}')" style="flex: 1;">
                            <i class="fas fa-cart-plus"></i>
                            Comprar
                        </button>
                        <button class="btn btn-secondary" onclick="viewProduct('${product.id}')" style="flex: 1;">
                            <i class="fas fa-eye"></i>
                            Detalhes
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            updateCartDisplay();
        }

        function showMarketCategory(category) {
            loadMarketProducts(category);
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            // Verificar se jÃ¡ estÃ¡ no carrinho
            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            
            updateCartDisplay();
            showAlert(`${product.name} adicionado ao carrinho!`, 'success');
        }

        function updateCartDisplay() {
            const container = document.getElementById('cartItems');
            const totalElement = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #666;">
                        <i class="fas fa-shopping-cart" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                        <p>Carrinho vazio</p>
                    </div>
                `;
                totalElement.textContent = formatCurrency(0);
                return;
            }
            
            let total = 0;
            container.innerHTML = '';
            
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'product-card';
                itemElement.style.marginBottom = '10px';
                itemElement.style.padding = '15px';
                
                itemElement.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 700; color: var(--imperial-gray-dark);">
                                ${item.name}
                            </div>
                            <div style="font-size: 0.9rem; color: #666;">
                                ${item.quantity} Ã— ${formatCurrency(item.price)}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: var(--imperial-purple);">
                                ${formatCurrency(itemTotal)}
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="btn-text" onclick="updateCartQuantity(${index}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span style="min-width: 30px; text-align: center;">${item.quantity}</span>
                                <button class="btn-text" onclick="updateCartQuantity(${index}, ${item.quantity + 1})">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn-text" onclick="removeFromCart(${index})" style="color: var(--imperial-danger); margin-left: 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(itemElement);
            });
            
            totalElement.textContent = formatCurrency(total);
        }

        function updateCartQuantity(index, newQuantity) {
            if (newQuantity < 1) {
                cart.splice(index, 1);
            } else {
                cart[index].quantity = newQuantity;
            }
            updateCartDisplay();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
            showAlert('Item removido do carrinho.', 'warning');
        }

        function checkoutCart() {
            if (cart.length === 0) {
                showAlert('Carrinho vazio.', 'warning');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (userData.saldo < total) {
                showAlert('Saldo insuficiente para finalizar a compra.', 'danger');
                return;
            }
            
            showConfirmation(
                'Finalizar Compra',
                'fa-shopping-cart',
                `Confirmar compra no valor de ${formatCurrency(total)}?`,
                `Itens: ${cart.length}<br>
                 Valor total: ${formatCurrency(total)}<br>
                 Saldo atual: ${formatCurrency(userData.saldo)}<br>
                 Saldo apÃ³s: ${formatCurrency(userData.saldo - total)}`,
                () => processCheckout(total)
            );
        }

        function processCheckout(total) {
            showLoading('Processando compra...');
            
            const updates = {};
            const now = Date.now();
            const orderId = database.ref().push().key;
            
            // Atualizar saldo do usuÃ¡rio
            updates['/users/' + currentUser + '/saldo'] = userData.saldo - total;
            
            // Criar pedido
            const order = {
                userId: currentUser,
                items: cart,
                total: total,
                status: 'completed',
                timestamp: now,
                orderId: orderId
            };
            
            updates['/orders/' + orderId] = order;
            
            // Adicionar ao histÃ³rico
            updates['/extratos/' + currentUser + '/' + orderId] = {
                type: 'market_purchase',
                description: `Compra no Mercado Imperial - ${cart.length} itens`,
                amount: -total,
                balance: userData.saldo - total,
                timestamp: now,
                status: 'completed'
            };
            
            // Registrar log
            updates['/logs/' + orderId] = {
                type: 'market_purchase',
                userId: currentUser,
                orderId: orderId,
                total: total,
                items: cart.length,
                timestamp: now,
                ip: 'web_client'
            };
            
            // Aplicar atualizaÃ§Ãµes
            database.ref().update(updates)
                .then(() => {
                    // Atualizar saldo local
                    userData.saldo -= total;
                    updateBalances();
                    
                    // Limpar carrinho
                    cart = [];
                    updateCartDisplay();
                    
                    hideLoading();
                    showAlert('Compra realizada com sucesso!', 'success');
                    
                    // Criar confetti
                    createConfetti();
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao processar compra: ' + error.message, 'danger');
                });
        }

        function viewProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            showConfirmation(
                'Detalhes do Produto',
                'fa-tag',
                product.name,
                `PreÃ§o: ${formatCurrency(product.price)}<br>
                 Categoria: ${product.category}<br>
                 ID: ${productId}<br><br>
                 Produto disponÃ­vel no Mercado Imperial.`,
                () => addToCart(productId)
            );
            
            // Mudar texto do botÃ£o de confirmaÃ§Ã£o
            document.getElementById('confirmActionButton').innerHTML = '<i class="fas fa-cart-plus"></i> Adicionar ao Carrinho';
        }

        // ============================================================================
        // TRANSFERÃŠNCIAS E POUPANÃ‡A
        // ============================================================================
        function executeTransfer() {
            const transferCPF = document.getElementById('transferCPF').value.replace(/\D/g, '');
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const transferType = document.getElementById('transferType').value;
            
            if (!transferCPF || transferCPF.length !== 11) {
                showAlert('CPF do destinatÃ¡rio invÃ¡lido.', 'danger');
                return;
            }
            
            if (!amount || amount <= 0) {
                showAlert('Digite um valor vÃ¡lido para a transferÃªncia.', 'danger');
                return;
            }
            
            if (!currentUser || !userData) {
                showAlert('SessÃ£o expirada. FaÃ§a login novamente.', 'danger');
                return;
            }
            
            if (userData.saldo < amount) {
                showAlert('Saldo insuficiente para realizar a transferÃªncia.', 'danger');
                return;
            }
            
            if (transferCPF === currentUser) {
                showAlert('NÃ£o Ã© possÃ­vel transferir para sua prÃ³pria conta.', 'warning');
                return;
            }
            
            showConfirmation(
                'Confirmar TransferÃªncia',
                'fa-exchange-alt',
                `Transferir ${formatCurrency(amount)} para CPF ${transferCPF.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}?`,
                `Tipo: ${transferType === 'government' ? 'Governo Federal' : transferType === 'fast' ? 'RÃ¡pida (InstantÃ¢nea)' : 'Normal (D+1)'}`,
                () => processTransfer(transferCPF, amount, transferType)
            );
        }

        function processTransfer(transferCPF, amount, transferType) {
            showLoading('Processando transferÃªncia...');
            
            // Verificar se destinatÃ¡rio existe
            database.ref('/users/' + transferCPF).once('value')
                .then(snapshot => {
                    if (!snapshot.exists() && transferType !== 'government') {
                        hideLoading();
                        showAlert('DestinatÃ¡rio nÃ£o encontrado.', 'danger');
                        return;
                    }
                    
                    const updates = {};
                    const now = Date.now();
                    const transactionId = database.ref().push().key;
                    
                    // Para transferÃªncias governamentais
                    const targetCPF = transferType === 'government' ? GOVERNMENT_ACCOUNT : transferCPF;
                    
                    // Atualizar saldo do remetente
                    updates['/users/' + currentUser + '/saldo'] = userData.saldo - amount;
                    
                    // Atualizar saldo do destinatÃ¡rio
                    if (transferType !== 'government') {
                        const destData = snapshot.val();
                        updates['/users/' + targetCPF + '/saldo'] = (destData.saldo || 0) + amount;
                    } else {
                        // Para governo, verificar se conta existe
                        database.ref('/users/' + GOVERNMENT_ACCOUNT).transaction(current => {
                            if (current === null) {
                                return {
                                    cpf: GOVERNMENT_ACCOUNT,
                                    name: 'Governo Federal - Brookasil',
                                    saldo: amount,
                                    type: 'government',
                                    created: now
                                };
                            } else {
                                current.saldo = (current.saldo || 0) + amount;
                                return current;
                            }
                        });
                    }
                    
                    // Registrar transaÃ§Ã£o
                    updates['/transactions/' + transactionId] = {
                        type: 'transfer_' + transferType,
                        from: currentUser,
                        to: targetCPF,
                        amount: amount,
                        timestamp: now,
                        status: 'completed'
                    };
                    
                    // Adicionar ao extrato
                    updates['/extratos/' + currentUser + '/' + transactionId] = {
                        type: 'transfer_out',
                        description: `TransferÃªncia para ${targetCPF}`,
                        amount: -amount,
                        balance: userData.saldo - amount,
                        timestamp: now,
                        status: 'completed'
                    };
                    
                    // Adicionar ao extrato do destinatÃ¡rio
                    if (transferType !== 'government') {
                        updates['/extratos/' + targetCPF + '/' + transactionId] = {
                            type: 'transfer_in',
                            description: `TransferÃªncia de ${currentUser}`,
                            amount: amount,
                            timestamp: now,
                            status: 'completed'
                        };
                    }
                    
                    // Aplicar atualizaÃ§Ãµes
                    database.ref().update(updates)
                        .then(() => {
                            userData.saldo -= amount;
                            updateBalances();
                            
                            hideLoading();
                            showAlert('TransferÃªncia realizada com sucesso!', 'success');
                            
                            // Limpar formulÃ¡rio
                            document.getElementById('transferCPF').value = '';
                            document.getElementById('transferAmount').value = '';
                            
                            createConfetti();
                        })
                        .catch(error => {
                            hideLoading();
                            showAlert('Erro ao processar transferÃªncia: ' + error.message, 'danger');
                        });
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao verificar destinatÃ¡rio: ' + error.message, 'danger');
                });
        }

        function depositToSavings() {
            const amount = parseFloat(document.getElementById('savingsAmount').value);
            
            if (!amount || amount <= 0) {
                showAlert('Digite um valor vÃ¡lido para depÃ³sito.', 'danger');
                return;
            }
            
            if (userData.saldo < amount) {
                showAlert('Saldo insuficiente para depÃ³sito.', 'danger');
                return;
            }
            
            showConfirmation(
                'DepÃ³sito na PoupanÃ§a',
                'fa-arrow-down',
                `Depositar ${formatCurrency(amount)} na poupanÃ§a?`,
                `Saldo atual: ${formatCurrency(userData.saldo)}<br>
                 PoupanÃ§a atual: ${formatCurrency(userData.poupanca || 0)}<br>
                 Saldo apÃ³s: ${formatCurrency(userData.saldo - amount)}<br>
                 PoupanÃ§a apÃ³s: ${formatCurrency((userData.poupanca || 0) + amount)}`,
                () => processSavingsTransaction(amount, 'deposit')
            );
        }

        function withdrawFromSavings() {
            const amount = parseFloat(document.getElementById('savingsAmount').value);
            const savings = userData.poupanca || 0;
            
            if (!amount || amount <= 0) {
                showAlert('Digite um valor vÃ¡lido para saque.', 'danger');
                return;
            }
            
            if (savings < amount) {
                showAlert('Saldo insuficiente na poupanÃ§a.', 'danger');
                return;
            }
            
            showConfirmation(
                'Saque da PoupanÃ§a',
                'fa-arrow-up',
                `Sacar ${formatCurrency(amount)} da poupanÃ§a?`,
                `PoupanÃ§a atual: ${formatCurrency(savings)}<br>
                 Saldo atual: ${formatCurrency(userData.saldo)}<br>
                 PoupanÃ§a apÃ³s: ${formatCurrency(savings - amount)}<br>
                 Saldo apÃ³s: ${formatCurrency(userData.saldo + amount)}`,
                () => processSavingsTransaction(amount, 'withdraw')
            );
        }

        function processSavingsTransaction(amount, type) {
            showLoading('Processando transaÃ§Ã£o...');
            
            const updates = {};
            const now = Date.now();
            const transactionId = database.ref().push().key;
            const isDeposit = type === 'deposit';
            
            // Atualizar saldos
            if (isDeposit) {
                updates['/users/' + currentUser + '/saldo'] = userData.saldo - amount;
                updates['/users/' + currentUser + '/poupanca'] = (userData.poupanca || 0) + amount;
            } else {
                updates['/users/' + currentUser + '/saldo'] = userData.saldo + amount;
                updates['/users/' + currentUser + '/poupanca'] = (userData.poupanca || 0) - amount;
            }
            
            // Registrar transaÃ§Ã£o
            updates['/transactions/' + transactionId] = {
                type: 'savings_' + type,
                userId: currentUser,
                amount: amount,
                timestamp: now,
                status: 'completed'
            };
            
            // Adicionar ao extrato
            updates['/extratos/' + currentUser + '/' + transactionId] = {
                type: 'savings_' + type,
                description: isDeposit ? 'DepÃ³sito na poupanÃ§a' : 'Saque da poupanÃ§a',
                amount: isDeposit ? -amount : amount,
                balance: isDeposit ? userData.saldo - amount : userData.saldo + amount,
                timestamp: now,
                status: 'completed'
            };
            
            // Aplicar atualizaÃ§Ãµes
            database.ref().update(updates)
                .then(() => {
                    // Atualizar dados locais
                    if (isDeposit) {
                        userData.saldo -= amount;
                        userData.poupanca = (userData.poupanca || 0) + amount;
                    } else {
                        userData.saldo += amount;
                        userData.poupanca = (userData.poupanca || 0) - amount;
                    }
                    
                    updateBalances();
                    hideLoading();
                    showAlert(`TransaÃ§Ã£o na poupanÃ§a realizada com sucesso!`, 'success');
                    
                    // Limpar campo
                    document.getElementById('savingsAmount').value = '';
                    
                    createConfetti();
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao processar transaÃ§Ã£o: ' + error.message, 'danger');
                });
        }

        function addToPiggy() {
            const amount = parseFloat(document.getElementById('piggyAmount').value);
            
            if (!amount || amount <= 0) {
                showAlert('Digite um valor vÃ¡lido para o cofrinho.', 'danger');
                return;
            }
            
            if (userData.saldo < amount) {
                showAlert('Saldo insuficiente para adicionar ao cofrinho.', 'danger');
                return;
            }
            
            showConfirmation(
                'Adicionar ao Cofrinho',
                'fa-piggy-bank',
                `Adicionar ${formatCurrency(amount)} ao cofrinho?`,
                `Saldo atual: ${formatCurrency(userData.saldo)}<br>
                 Cofrinho atual: ${formatCurrency(userData.cofrinho || 0)}<br>
                 Saldo apÃ³s: ${formatCurrency(userData.saldo - amount)}<br>
                 Cofrinho apÃ³s: ${formatCurrency((userData.cofrinho || 0) + amount)}`,
                () => processPiggyTransaction(amount)
            );
        }

        function processPiggyTransaction(amount) {
            showLoading('Processando transaÃ§Ã£o...');
            
            const updates = {};
            const now = Date.now();
            const transactionId = database.ref().push().key;
            
            // Atualizar saldos
            updates['/users/' + currentUser + '/saldo'] = userData.saldo - amount;
            updates['/users/' + currentUser + '/cofrinho'] = (userData.cofrinho || 0) + amount;
            
            // Registrar transaÃ§Ã£o
            updates['/transactions/' + transactionId] = {
                type: 'piggy_deposit',
                userId: currentUser,
                amount: amount,
                timestamp: now,
                status: 'completed'
            };
            
            // Adicionar ao extrato
            updates['/extratos/' + currentUser + '/' + transactionId] = {
                type: 'piggy_deposit',
                description: 'DepÃ³sito no cofrinho',
                amount: -amount,
                balance: userData.saldo - amount,
                timestamp: now,
                status: 'completed'
            };
            
            // Aplicar atualizaÃ§Ãµes
            database.ref().update(updates)
                .then(() => {
                    userData.saldo -= amount;
                    userData.cofrinho = (userData.cofrinho || 0) + amount;
                    
                    updateBalances();
                    hideLoading();
                    showAlert('Valor adicionado ao cofrinho com sucesso!', 'success');
                    
                    // Limpar campo
                    document.getElementById('piggyAmount').value = '';
                    
                    createConfetti();
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao processar transaÃ§Ã£o: ' + error.message, 'danger');
                });
        }

        // ============================================================================
        // HISTÃ“RICO COMPLETO
        // ============================================================================
        function loadFullHistory() {
            if (!currentUser) return;
            
            database.ref('/extratos/' + currentUser)
                .orderByChild('timestamp')
                .once('value')
                .then(snapshot => {
                    const tbody = document.getElementById('fullHistory');
                    tbody.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px;">
                                    Nenhuma transaÃ§Ã£o encontrada
                                </td>
                            </tr>
                        `;
                        return;
                    }
                    
                    const transactions = [];
                    snapshot.forEach(child => {
                        transactions.unshift(child.val());
                    });
                    
                    transactions.forEach(trans => {
                        const row = document.createElement('tr');
                        
                        let typeText = '';
                        let typeColor = '';
                        
                        switch(trans.type) {
                            case 'pix_in':
                            case 'transfer_in':
                            case 'savings_withdraw':
                                typeText = 'Entrada';
                                typeColor = 'var(--imperial-success)';
                                break;
                            case 'pix_out':
                            case 'transfer_out':
                            case 'boleto_payment':
                            case 'market_purchase':
                            case 'savings_deposit':
                            case 'piggy_deposit':
                                typeText = 'SaÃ­da';
                                typeColor = 'var(--imperial-danger)';
                                break;
                            case 'account_creation':
                                typeText = 'Conta';
                                typeColor = 'var(--imperial-purple)';
                                break;
                            default:
                                typeText = trans.type;
                                typeColor = 'var(--imperial-info)';
                        }
                        
                        const statusClass = trans.status === 'completed' ? 'status-success' : 
                                           trans.status === 'pending' ? 'status-warning' : 'status-danger';
                        
                        row.innerHTML = `
                            <td>${formatDate(trans.timestamp)}</td>
                            <td><span style="color: ${typeColor}; font-weight: 700;">${typeText}</span></td>
                            <td>${trans.description || 'TransaÃ§Ã£o'}</td>
                            <td style="color: ${trans.amount >= 0 ? 'var(--imperial-success)' : 'var(--imperial-danger)'}; font-weight: 700;">
                                ${formatCurrency(trans.amount)}
                            </td>
                            <td>${trans.balance ? formatCurrency(trans.balance) : '-'}</td>
                            <td><span class="status ${statusClass}">${trans.status || 'completed'}</span></td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar histÃ³rico:', error);
                    showAlert('Erro ao carregar histÃ³rico: ' + error.message, 'danger');
                });
        }

        function filterHistory() {
            // ImplementaÃ§Ã£o simplificada - em produÃ§Ã£o, filtraria no Firebase
            loadFullHistory();
        }

        function exportHistory(format) {
            showAlert(`ExportaÃ§Ã£o em ${format.toUpperCase()} iniciada. Em produÃ§Ã£o, geraria arquivo para download.`, 'info');
        }

        function printHistory() {
            window.print();
        }

        // ============================================================================
        // PAINEL ADMINISTRATIVO
        // ============================================================================
        function loadAdminPanel() {
            if (!(userType === 'owner_rp' || userType === 'owner_bank')) {
                return;
            }
            
            loadUsersList();
            loadSystemMetrics();
        }

        function loadUsersList() {
            database.ref('/users')
                .orderByChild('created')
                .limitToLast(50)
                .once('value')
                .then(snapshot => {
                    const container = document.getElementById('usersList');
                    container.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        container.innerHTML = '<p style="color: #666; text-align: center;">Nenhum usuÃ¡rio encontrado</p>';
                        return;
                    }
                    
                    let userCount = 0;
                    let totalBalance = 0;
                    
                    snapshot.forEach(child => {
                        const user = child.val();
                        userCount++;
                        totalBalance += user.saldo || 0;
                        
                        const userElement = document.createElement('div');
                        userElement.className = 'product-card';
                        userElement.style.padding = '15px';
                        userElement.style.marginBottom = '10px';
                        
                        const userType = user.type || 'client';
                        let typeBadge = '';
                        
                        if (userType === 'owner_rp') {
                            typeBadge = '<span class="badge badge-gold" style="margin-left: 10px;">ðŸ‘‘ DONO RP</span>';
                        } else if (userType === 'owner_bank') {
                            typeBadge = '<span class="badge badge-purple" style="margin-left: 10px;">ðŸ¦ DONO BANCO</span>';
                        } else if (userType === 'government') {
                            typeBadge = '<span class="badge badge-purple" style="margin-left: 10px;">ðŸ›ï¸ GOVERNO</span>';
                        }
                        
                        userElement.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 700; color: var(--imperial-gray-dark);">
                                        ${user.name} ${typeBadge}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">
                                        CPF: ${user.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                        Criado: ${new Date(user.created || Date.now()).toLocaleDateString('pt-BR')}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: var(--imperial-purple);">
                                        ${formatCurrency(user.saldo || 0)}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                        PoupanÃ§a: ${formatCurrency(user.poupanca || 0)}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(userElement);
                    });
                    
                    // Adicionar resumo
                    const summary = document.createElement('div');
                    summary.className = 'product-card';
                    summary.style.padding = '15px';
                    summary.style.marginTop = '20px';
                    summary.style.background = 'rgba(106, 13, 173, 0.05)';
                    
                    summary.innerHTML = `
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>Total de UsuÃ¡rios:</strong> ${userCount}
                            </div>
                            <div>
                                <strong>Saldo Total:</strong> ${formatCurrency(totalBalance)}
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(summary);
                })
                .catch(error => {
                    console.error('Erro ao carregar usuÃ¡rios:', error);
                });
        }

        function loadSystemMetrics() {
            const container = document.getElementById('systemMetrics');
            
            // EstatÃ­sticas bÃ¡sicas (em produÃ§Ã£o, viriam do Firebase)
            const metrics = {
                totalUsers: 'Carregando...',
                activeToday: 'Carregando...',
                totalTransactions: 'Carregando...',
                totalVolume: 'Carregando...',
                systemStatus: 'Operacional'
            };
            
            // Buscar mÃ©tricas reais
            Promise.all([
                database.ref('/users').once('value'),
                database.ref('/transactions').once('value'),
                database.ref('/logs').orderByChild('timestamp').startAt(Date.now() - 24 * 60 * 60 * 1000).once('value')
            ])
            .then(([usersSnap, transSnap, logsSnap]) => {
                metrics.totalUsers = usersSnap.exists() ? usersSnap.numChildren() : 0;
                metrics.activeToday = logsSnap.exists() ? new Set(Array.from(logsSnap.val() || []).filter(log => log.type === 'login_success').map(log => log.cpf)).size : 0;
                metrics.totalTransactions = transSnap.exists() ? transSnap.numChildren() : 0;
                
                let totalVolume = 0;
                if (transSnap.exists()) {
                    transSnap.forEach(child => {
                        const trans = child.val();
                        if (trans.amount) {
                            totalVolume += Math.abs(trans.amount);
                        }
                    });
                }
                metrics.totalVolume = formatCurrency(totalVolume);
                
                updateMetricsDisplay(container, metrics);
            })
            .catch(error => {
                console.error('Erro ao carregar mÃ©tricas:', error);
                updateMetricsDisplay(container, metrics);
            });
        }

        function updateMetricsDisplay(container, metrics) {
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="background: rgba(106, 13, 173, 0.05); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: #666;">UsuÃ¡rios Totais</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--imperial-purple);">${metrics.totalUsers}</div>
                    </div>
                    <div style="background: rgba(40, 167, 69, 0.05); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: #666;">Ativos Hoje</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--imperial-success);">${metrics.activeToday}</div>
                    </div>
                    <div style="background: rgba(255, 193, 7, 0.05); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: #666;">TransaÃ§Ãµes</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--imperial-warning);">${metrics.totalTransactions}</div>
                    </div>
                    <div style="background: rgba(23, 162, 184, 0.05); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: #666;">Volume Total</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--imperial-info);">${metrics.totalVolume}</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(40, 167, 69, 0.1); border-radius: 8px; border-left: 4px solid var(--imperial-success);">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-check-circle" style="color: var(--imperial-success);"></i>
                        <div>
                            <strong>Sistema Operacional</strong>
                            <div style="font-size: 0.9rem; color: #666;">Todos os serviÃ§os funcionando normalmente</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function runAudit() {
            showLoading('Executando auditoria...');
            
            // Simular auditoria
            setTimeout(() => {
                hideLoading();
                showAlert('Auditoria concluÃ­da. Nenhuma irregularidade encontrada.', 'success');
                
                // Registrar log de auditoria
                database.ref('/auditoria').push({
                    type: 'system_audit',
                    executedBy: currentUser,
                    timestamp: Date.now(),
                    result: 'clean',
                    findings: []
                });
            }, 2000);
        }

        function checkFraud() {
            showLoading('Verificando fraudes...');
            
            // Simular verificaÃ§Ã£o
            setTimeout(() => {
                hideLoading();
                showAlert('VerificaÃ§Ã£o de fraude concluÃ­da. Sistema seguro.', 'success');
                
                // Registrar log
                database.ref('/antifraude').push({
                    type: 'fraud_check',
                    executedBy: currentUser,
                    timestamp: Date.now(),
                    result: 'safe',
                    suspiciousActivities: 0
                });
            }, 2000);
        }

        function updateInterestRates() {
            showConfirmation(
                'Atualizar Taxas de Juros',
                'fa-percentage',
                'Atualizar taxas de juros de todos os boletos?',
                'Esta aÃ§Ã£o recalcularÃ¡ os juros de todos os boletos pendentes com base nos dias em atraso.',
                () => {
                    showLoading('Atualizando taxas de juros...');
                    
                    // Em produÃ§Ã£o, percorreria todos os boletos pendentes
                    setTimeout(() => {
                        hideLoading();
                        showAlert('Taxas de juros atualizadas com sucesso!', 'success');
                    }, 1500);
                }
            );
        }

        function viewLogs() {
            showAlert('Em produÃ§Ã£o, exibiria interface de logs avanÃ§ada.', 'info');
        }

        function executeGlobalPIX() {
            const amount = parseFloat(document.getElementById('globalPixAmount').value);
            const target = document.getElementById('globalPixTarget').value.trim();
            
            if (!amount || amount <= 0) {
                showAlert('Digite um valor vÃ¡lido.', 'danger');
                return;
            }
            
            if (!target) {
                showAlert('Digite um CPF ou "todos".', 'danger');
                return;
            }
            
            if (target === 'todos') {
                showConfirmation(
                    'PIX Global para Todos',
                    'fa-bolt',
                    `Distribuir ${formatCurrency(amount)} para TODOS os usuÃ¡rios?`,
                    `Esta aÃ§Ã£o enviarÃ¡ ${formatCurrency(amount)} para cada usuÃ¡rio do sistema.`,
                    () => processGlobalPIX(amount, 'all')
                );
            } else {
                const targetCPF = target.replace(/\D/g, '');
                if (targetCPF.length !== 11) {
                    showAlert('CPF invÃ¡lido.', 'danger');
                    return;
                }
                
                showConfirmation(
                    'PIX Global EspecÃ­fico',
                    'fa-bolt',
                    `Enviar ${formatCurrency(amount)} para CPF ${targetCPF.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4')}?`,
                    `TransferÃªncia global como administrador do sistema.`,
                    () => processGlobalPIX(amount, targetCPF)
                );
            }
        }

        function processGlobalPIX(amount, target) {
            showLoading('Executando PIX Global...');
            
            if (target === 'all') {
                // Em produÃ§Ã£o, enviaria para todos os usuÃ¡rios
                database.ref('/users').once('value')
                    .then(snapshot => {
                        const updates = {};
                        const now = Date.now();
                        
                        snapshot.forEach(child => {
                            const user = child.val();
                            if (user.type !== 'owner_rp' && user.type !== 'owner_bank') {
                                updates['/users/' + user.cpf + '/saldo'] = (user.saldo || 0) + amount;
                                
                                const transactionId = database.ref().push().key;
                                updates['/extratos/' + user.cpf + '/' + transactionId] = {
                                    type: 'global_pix',
                                    description: 'PIX Global do Administrador',
                                    amount: amount,
                                    timestamp: now,
                                    status: 'completed'
                                };
                            }
                        });
                        
                        // Registrar log
                        const logId = database.ref().push().key;
                        updates['/logs/' + logId] = {
                            type: 'global_pix_all',
                            executedBy: currentUser,
                            amount: amount,
                            usersAffected: snapshot.numChildren() - 2, // Excluir contas de admin
                            timestamp: now
                        };
                        
                        return database.ref().update(updates);
                    })
                    .then(() => {
                        hideLoading();
                        showAlert('PIX Global distribuÃ­do com sucesso para todos os usuÃ¡rios!', 'success');
                    })
                    .catch(error => {
                        hideLoading();
                        showAlert('Erro ao executar PIX Global: ' + error.message, 'danger');
                    });
            } else {
                // Para CPF especÃ­fico
                const updates = {};
                const now = Date.now();
                const transactionId = database.ref().push().key;
                
                database.ref('/users/' + target).transaction(current => {
                    if (current === null) {
                        // Criar conta se nÃ£o existir
                        return {
                            cpf: target,
                            name: 'UsuÃ¡rio PIX Global',
                            saldo: amount,
                            created: now
                        };
                    } else {
                        current.saldo = (current.saldo || 0) + amount;
                        return current;
                    }
                })
                .then(() => {
                    // Registrar transaÃ§Ã£o
                    updates['/extratos/' + target + '/' + transactionId] = {
                        type: 'global_pix',
                        description: 'PIX Global do Administrador',
                        amount: amount,
                        timestamp: now,
                        status: 'completed'
                    };
                    
                    // Registrar log
                    updates['/logs/' + transactionId] = {
                        type: 'global_pix_specific',
                        executedBy: currentUser,
                        target: target,
                        amount: amount,
                        timestamp: now
                    };
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    hideLoading();
                    showAlert('PIX Global enviado com sucesso!', 'success');
                })
                .catch(error => {
                    hideLoading();
                    showAlert('Erro ao executar PIX Global: ' + error.message, 'danger');
                });
            }
        }

        // ============================================================================
        // FUNÃ‡Ã•ES UTILITÃRIAS
        // ============================================================================
        function showAlert(message, type) {
            const container = document.getElementById('alertsContainer');
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <div>${message}</div>
                <button class="btn-text" onclick="this.parentElement.remove()" style="margin-left: auto;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(alert);
            
            // Auto-remover apÃ³s 5 segundos
            setTimeout(() => {
                if (alert.parentElement) {
                    alert.remove();
                }
            }, 5000);
        }

        function showConfirmation(title, icon, message, details, callback) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationIcon').className = `icon-large fas ${icon}`;
            document.getElementById('confirmationMessage').innerHTML = message;
            document.getElementById('confirmationDetails').innerHTML = details;
            
            pendingAction = callback;
            showModal('confirmationModal');
        }

        function confirmAction() {
            if (pendingAction) {
                hideModal('confirmationModal');
                pendingAction();
                pendingAction = null;
            }
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.opacity = '1';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                document.body.appendChild(confetti);
                
                // AnimaÃ§Ã£o
                const animation = confetti.animate([
                    { top: '0px', transform: `rotate(${Math.random() * 360}deg)` },
                    { top: '100vh', transform: `rotate(${Math.random() * 720}deg)` }
                ], {
                    duration: 2000 + Math.random() * 1000,
                    easing: 'cubic-bezier(0.215, 0.61, 0.355, 1)'
                });
                
                animation.onfinish = () => confetti.remove();
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = event.target.closest('button');
            
            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Ocultar Senha';
            } else {
                input.type = 'password';
                button.innerHTML = '<i class="fas fa-eye"></i> Mostrar Senha';
            }
        }

        function setupEventListeners() {
            // Atualizar resumo PIX
            document.getElementById('pixAmount').addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                document.getElementById('pixSummaryAmount').textContent = formatCurrency(amount);
                document.getElementById('pixSummaryTotal').textContent = formatCurrency(amount);
            });
            
            // ForÃ§a da senha
            document.getElementById('newPassword').addEventListener('input', function() {
                const password = this.value;
                let strength = 0;
                
                if (password.length >= 8) strength += 25;
                if (/[A-Z]/.test(password)) strength += 25;
                if (/[0-9]/.test(password)) strength += 25;
                if (/[^A-Za-z0-9]/.test(password)) strength += 25;
                
                document.getElementById('passwordStrength').style.width = strength + '%';
                document.getElementById('passwordStrength').style.background = 
                    strength < 50 ? 'var(--imperial-danger)' : 
                    strength < 75 ? 'var(--imperial-warning)' : 'var(--imperial-success)';
            });
        }

        function refreshUsers() {
            if (userType === 'owner_rp' || userType === 'owner_bank') {
                loadUsersList();
                showAlert('Lista de usuÃ¡rios atualizada.', 'success');
            }
        }

        // ============================================================================
        // INICIALIZAÃ‡ÃƒO FINAL
        // ============================================================================
        console.log('Sistema BancÃ¡rio Imperial carregado.');
        console.log('Firebase configurado:', firebaseConfig.databaseURL);
        console.log('Sistema em produÃ§Ã£o - CompatÃ­vel com dados existentes');
    </script>
</body>
    </html>

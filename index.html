<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banco Imperial | Internet Banking Enterprise</title>
    <meta name="description" content="Sistema Bancário Digital de Alta Performance - Banco Imperial">
    <meta name="theme-color" content="#4a148c">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, get, update, push, onValue, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // Configuração Pública (Conforme solicitado)
        const firebaseConfig = {
            databaseURL: "https://banco-imperial-default-rtdb.firebaseio.com",
            apiKey: "AIzaSyDWat0SS6tRICcLAOmNy843MUoicfTfD8I", // Nota: Em prod real, usar regras de segurança backend
        };

        // Inicialização Global
        window.app = initializeApp(firebaseConfig);
        window.db = getDatabase(window.app);
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbUpdate = update;
        window.dbPush = push;
        window.dbOnValue = onValue;
        window.dbQuery = query;
        window.dbOrderByChild = orderByChild;
        window.dbEqualTo = equalTo;
    </script>

    <style>
        /* ================================================================
        CORE STYLES & VARIABLES
        ================================================================ 
        */
        :root {
            /* Palette Imperial */
            --color-primary: #4a148c;
            --color-primary-dark: #2c0060;
            --color-primary-light: #7c43bd;
            --color-accent: #ffd700; /* Ouro */
            --color-accent-hover: #ffea00;
            
            /* Neutrals */
            --color-bg: #f4f6f8;
            --color-surface: #ffffff;
            --color-text-main: #1a1a1a;
            --color-text-secondary: #666666;
            --color-border: #e0e0e0;
            
            /* Feedback */
            --color-success: #00c853;
            --color-error: #d50000;
            --color-warning: #ffab00;
            --color-info: #2962ff;

            /* Spacing & Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(74, 20, 140, 0.15);

            /* Typography */
            --font-sans: 'Inter', sans-serif;
            --font-serif: 'Playfair Display', serif;
        }

        /* Dark Mode Support (Automático) */
        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg: #121212;
                --color-surface: #1e1e1e;
                --color-text-main: #e0e0e0;
                --color-text-secondary: #a0a0a0;
                --color-border: #333333;
            }
        }

        /* Reset */
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body {
            font-family: var(--font-sans);
            background-color: var(--color-bg);
            color: var(--color-text-main);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Acessibilidade */
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
        }
        *:focus-visible { outline: 3px solid var(--color-accent); outline-offset: 2px; }

        /* Utilitários */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 8px; }
        .gap-2 { gap: 16px; }
        .gap-4 { gap: 32px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .w-full { width: 100%; }
        .hidden { display: none !important; }
        .font-bold { font-weight: 700; }
        
        /* Tipografia */
        h1, h2, h3, h4 { color: var(--color-primary); margin-bottom: 0.5em; }
        h1 { font-family: var(--font-serif); font-size: 2.5rem; }
        h2 { font-size: 1.8rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .text-primary { color: var(--color-primary); }
        .text-success { color: var(--color-success); }
        .text-error { color: var(--color-error); }

        /* Componentes: Botões */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 24px; border-radius: var(--radius-md); border: none;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
            font-size: 1rem; gap: 8px;
        }
        .btn-primary {
            background-color: var(--color-primary); color: white;
            box-shadow: 0 4px 6px rgba(74, 20, 140, 0.2);
        }
        .btn-primary:hover { background-color: var(--color-primary-dark); transform: translateY(-1px); }
        .btn-secondary { background-color: transparent; border: 2px solid var(--color-primary); color: var(--color-primary); }
        .btn-secondary:hover { background-color: rgba(74, 20, 140, 0.05); }
        .btn-danger { background-color: var(--color-error); color: white; }
        .btn-accent { background-color: var(--color-accent); color: var(--color-primary-dark); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Componentes: Inputs */
        .input-group { margin-bottom: 16px; text-align: left; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        .input-control {
            width: 100%; padding: 12px; border: 1px solid var(--color-border);
            border-radius: var(--radius-md); font-size: 1rem; background: var(--color-surface);
            color: var(--color-text-main); transition: border-color 0.2s;
        }
        .input-control:focus { border-color: var(--color-primary); }

        /* Cards */
        .card {
            background: var(--color-surface); border-radius: var(--radius-lg);
            padding: 24px; box-shadow: var(--shadow-md); border: 1px solid rgba(0,0,0,0.05);
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; border-bottom: 1px solid var(--color-border); padding-bottom: 12px; }

        /* Layout: Auth */
        #auth-view {
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
            padding: 20px;
        }
        .auth-container { max-width: 450px; width: 100%; animation: slideUp 0.5s ease-out; }
        .brand-logo { 
            font-size: 3rem; color: var(--color-accent); margin-bottom: 10px; display: block; text-align: center; 
        }

        /* Layout: Dashboard */
        #dashboard-view { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
        .sidebar {
            background: var(--color-surface); border-right: 1px solid var(--color-border);
            padding: 24px; display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh;
        }
        .main-content { padding: 32px; overflow-y: auto; }
        .nav-item {
            display: flex; align-items: center; padding: 12px; margin-bottom: 8px;
            color: var(--color-text-secondary); text-decoration: none; border-radius: var(--radius-md);
            transition: all 0.2s; cursor: pointer;
        }
        .nav-item:hover, .nav-item.active { background-color: rgba(74, 20, 140, 0.05); color: var(--color-primary); font-weight: 600; }
        .nav-item i { width: 24px; margin-right: 12px; }

        /* Banco Específico */
        .balance-display { font-size: 2.5rem; font-weight: 700; color: var(--color-text-main); margin: 10px 0; }
        .balance-hidden { filter: blur(8px); cursor: pointer; }
        
        .transaction-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; border-bottom: 1px solid var(--color-border);
        }
        .transaction-item:last-child { border-bottom: none; }
        .tx-icon {
            width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
            justify-content: center; margin-right: 16px; font-size: 1.2rem;
        }
        .tx-in { background-color: #e8f5e9; color: var(--color-success); }
        .tx-out { background-color: #ffebee; color: var(--color-error); }

        /* Loaders & Toasts */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999; display: flex;
            align-items: center; justify-content: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--color-border);
            border-top: 5px solid var(--color-primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 16px;
        }
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            padding: 16px 24px; border-radius: var(--radius-md); background: var(--color-surface);
            box-shadow: var(--shadow-lg); border-left: 4px solid var(--color-primary);
            animation: slideInRight 0.3s ease-out; display: flex; align-items: center; gap: 12px; min-width: 300px;
        }
        .toast.success { border-left-color: var(--color-success); }
        .toast.error { border-left-color: var(--color-error); }

        /* Chatbot */
        .chat-widget {
            position: fixed; bottom: 30px; right: 30px; width: 350px;
            background: var(--color-surface); border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg); display: flex; flex-direction: column;
            overflow: hidden; border: 1px solid var(--color-border); z-index: 5000;
            transition: transform 0.3s;
        }
        .chat-header { background: var(--color-primary); color: white; padding: 15px; display: flex; justify-content: space-between; cursor: pointer; }
        .chat-body { height: 300px; overflow-y: auto; padding: 15px; background: #f9f9f9; display: flex; flex-direction: column; gap: 10px; }
        .chat-footer { padding: 10px; border-top: 1px solid var(--color-border); display: flex; }
        .msg { padding: 8px 12px; border-radius: 12px; max-width: 85%; font-size: 0.9rem; }
        .msg.bot { background: #e0e0e0; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.user { background: var(--color-primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-collapsed { transform: translateY(calc(100% - 50px)); }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

        /* Responsividade */
        @media (max-width: 768px) {
            #dashboard-view { grid-template-columns: 1fr; }
            .sidebar { display: none; /* Implementar mobile menu em prod */ }
            .sidebar.mobile-open { display: flex; position: fixed; z-index: 100; width: 80%; }
        }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="spinner"></div>
        <h3 id="loader-text" class="text-primary">Iniciando Sistemas Bancários...</h3>
    </div>

    <div id="toast-container"></div>

    <div id="app-root">
        </div>

    <div id="ia-container" class="hidden">
        <div id="chat-widget" class="chat-widget chat-collapsed">
            <div class="chat-header" onclick="toggleChat()">
                <span><i class="fas fa-robot"></i> Imperial IA</span>
                <i class="fas fa-chevron-up"></i>
            </div>
            <div class="chat-body" id="chat-messages">
                <div class="msg bot">Olá! Sou a IA do Banco Imperial. Como posso ajudar com sua conta hoje?</div>
            </div>
            <div class="chat-footer">
                <input type="text" id="chat-input" class="input-control" placeholder="Digite sua dúvida..." style="border:none;">
                <button class="btn btn-primary" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <script type="module">
        // ================================================================
        // BANCO IMPERIAL - CORE LOGIC
        // ================================================================

        // VARIÁVEIS DE ESTADO GLOBAL
        let state = {
            user: null, // Dados do usuário logado
            authId: null, // UID do Firebase
            view: 'login', // View atual
            accountsCache: {},
            token: null
        };

        // --- UTILITÁRIOS ---
        
        const Utils = {
            formatCurrency: (value) => {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            },
            formatDate: (timestamp) => {
                return new Date(timestamp).toLocaleString('pt-BR');
            },
            generateAccountNum: () => {
                return Math.floor(100000 + Math.random() * 900000).toString(); // 6 dígitos
            },
            generatePixKey: () => {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },
            sleep: (ms) => new Promise(r => setTimeout(r, ms)),
            
            // Validador CPF (Algoritmo Real simplificado para JS)
            isValidCPF: (cpf) => {
                cpf = cpf.replace(/[^\d]+/g, '');
                if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
                let soma = 0, resto;
                for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
                resto = (soma * 10) % 11;
                if ((resto === 10) || (resto === 11)) resto = 0;
                if (resto !== parseInt(cpf.substring(9, 10))) return false;
                soma = 0;
                for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
                resto = (soma * 10) % 11;
                if ((resto === 10) || (resto === 11)) resto = 0;
                if (resto !== parseInt(cpf.substring(10, 11))) return false;
                return true;
            }
        };

        const UI = {
            showLoader: (msg = "Processando...") => {
                document.getElementById('loader-text').innerText = msg;
                document.getElementById('loader-overlay').classList.remove('hidden');
            },
            hideLoader: () => {
                document.getElementById('loader-overlay').classList.add('hidden');
            },
            toast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                let icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
                toast.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
                
                // Leitura para acessibilidade
                const speech = new SpeechSynthesisUtterance(msg);
                window.speechSynthesis.speak(speech);
            },
            render: (html) => {
                document.getElementById('app-root').innerHTML = html;
                UI.bindEvents();
            },
            bindEvents: () => {
                // Re-bind listeners if needed after render
            }
        };

        // --- SERVIÇOS DO BANCO ---

        class AuthService {
            static async login(cpf, password) {
                UI.showLoader("Autenticando...");
                try {
                    // Busca usuário pelo CPF (Índice deve existir no Firebase, senão scan manual - lento mas funcional para RP)
                    const usersRef = window.dbRef(window.db, 'users');
                    const q = window.dbQuery(usersRef, window.dbOrderByChild('cpf'), window.dbEqualTo(cpf));
                    
                    const snapshot = await window.dbGet(q);
                    
                    if (!snapshot.exists()) {
                        throw new Error("Usuário não encontrado.");
                    }

                    let userData = null;
                    let uid = null;
                    snapshot.forEach(child => {
                        userData = child.val();
                        uid = child.key;
                    });

                    // Validação simples de senha (em prod, usar hash/bcrypt no server)
                    if (userData.password !== password) {
                        // Log tentativa falha
                        LogService.add('AUTH_FAIL', `Tentativa de login falha para CPF ${cpf}`, 'system');
                        throw new Error("Senha incorreta.");
                    }

                    if (userData.status === 'blocked') {
                        throw new Error("CONTA BLOQUEADA PELO ADMINISTRADOR.");
                    }

                    state.user = userData;
                    state.authId = uid;
                    
                    // Log sucesso
                    LogService.add('LOGIN', `Usuário ${userData.name} entrou.`, uid);
                    
                    UI.toast(`Bem-vindo, ${userData.name}!`, 'success');
                    Navigation.navigate('dashboard');

                } catch (e) {
                    UI.toast(e.message, 'error');
                } finally {
                    UI.hideLoader();
                }
            }

            static async register(data) {
                UI.showLoader("Criando conta no Banco Imperial...");
                try {
                    // 1. Validar CPF
                    if (!Utils.isValidCPF(data.cpf)) throw new Error("CPF Inválido.");
                    if (data.password !== data.confirmPassword) throw new Error("Senhas não conferem.");
                    if (data.password.length < 6) throw new Error("Senha muito fraca.");

                    // 2. Verificar duplicidade
                    const usersRef = window.dbRef(window.db, 'users');
                    const q = window.dbQuery(usersRef, window.dbOrderByChild('cpf'), window.dbEqualTo(data.cpf));
                    const check = await window.dbGet(q);
                    if (check.exists()) throw new Error("CPF já cadastrado.");

                    // 3. Criar estrutura
                    const newUserRef = window.dbPush(usersRef);
                    const uid = newUserRef.key;
                    
                    const newAccount = {
                        name: data.name,
                        cpf: data.cpf,
                        password: data.password, // Em RP simples, texto plano. Em real, NUNCA.
                        email: data.email,
                        balance: 1000.00, // Bônus inicial RP
                        accountNumber: Utils.generateAccountNum(),
                        agency: '0001',
                        role: 'user', // user, admin, owner
                        status: 'active',
                        createdAt: Date.now(),
                        pixKeys: [data.cpf], // Chave padrão
                        settings: {
                            darkMode: false,
                            notifications: true
                        }
                    };

                    await window.dbSet(newUserRef, newAccount);
                    
                    // Log criação
                    LogService.add('ACCOUNT_CREATED', `Nova conta: ${newAccount.accountNumber}`, uid);

                    UI.toast("Conta criada com sucesso! Faça login.", 'success');
                    Navigation.navigate('login');

                } catch (e) {
                    UI.toast(e.message, 'error');
                } finally {
                    UI.hideLoader();
                }
            }

            static logout() {
                state.user = null;
                state.authId = null;
                document.getElementById('ia-container').classList.add('hidden');
                Navigation.navigate('login');
                UI.toast("Sessão finalizada.", 'info');
            }
        }

        class BankingService {
            static async sendPix(key, amount, description) {
                if (amount <= 0) throw new Error("Valor inválido.");
                if (amount > state.user.balance) throw new Error("Saldo insuficiente.");

                // Antifraude Básico
                if (amount > 10000 && state.user.role === 'user') {
                    LogService.add('ANTIFRAUD', `Bloqueio Pix Alto Valor: ${amount} de ${state.user.cpf}`, state.authId);
                    throw new Error("Operação bloqueada: Valor excede limite de segurança. Contate o suporte.");
                }

                // Buscar Destino (Por CPF ou Email que são chaves)
                // Simplificação: Assume que a chave é o CPF
                const usersRef = window.dbRef(window.db, 'users');
                const q = window.dbQuery(usersRef, window.dbOrderByChild('cpf'), window.dbEqualTo(key));
                const snap = await window.dbGet(q);

                if (!snap.exists()) throw new Error("Chave PIX não encontrada.");

                let destUser = null;
                let destUid = null;
                snap.forEach(c => { destUser = c.val(); destUid = c.key; });

                if (destUid === state.authId) throw new Error("Não pode transferir para si mesmo.");

                // Transação Atômica (Simulada via Updates simultâneos)
                const updates = {};
                
                // Débito
                updates[`/users/${state.authId}/balance`] = state.user.balance - parseFloat(amount);
                // Crédito
                updates[`/users/${destUid}/balance`] = destUser.balance + parseFloat(amount);

                // Logs de Transação
                const txId = Date.now();
                const txDataSender = {
                    type: 'PIX_OUT',
                    amount: parseFloat(amount),
                    destName: destUser.name,
                    destCpf: destUser.cpf,
                    date: Date.now(),
                    desc: description
                };
                const txDataReceiver = {
                    type: 'PIX_IN',
                    amount: parseFloat(amount),
                    originName: state.user.name,
                    originCpf: state.user.cpf,
                    date: Date.now(),
                    desc: description
                };

                // Caminhos de log
                const logSenderRef = window.dbPush(window.dbRef(window.db, `transactions/${state.authId}`));
                const logReceiverRef = window.dbPush(window.dbRef(window.db, `transactions/${destUid}`));
                
                updates[`/transactions/${state.authId}/${logSenderRef.key}`] = txDataSender;
                updates[`/transactions/${destUid}/${logReceiverRef.key}`] = txDataReceiver;

                await window.dbUpdate(window.dbRef(window.db), updates);

                // Atualizar estado local
                state.user.balance -= parseFloat(amount);
                return true;
            }

            static async payBoleto(code) {
                // Lógica de boleto: busca no nó 'boletos', verifica status, deduz saldo, muda status
                const boletosRef = window.dbRef(window.db, 'boletos');
                const q = window.dbQuery(boletosRef, window.dbOrderByChild('code'), window.dbEqualTo(code));
                const snap = await window.dbGet(q);

                if(!snap.exists()) throw new Error("Boleto não encontrado.");
                
                let boleto = null;
                let boletoId = null;
                snap.forEach(c => { boleto = c.val(); boletoId = c.key; });

                if (boleto.status !== 'pending') throw new Error(`Boleto já consta como ${boleto.status}.`);
                if (state.user.balance < boleto.value) throw new Error("Saldo insuficiente.");

                // Pagar
                const updates = {};
                updates[`/users/${state.authId}/balance`] = state.user.balance - boleto.value;
                updates[`/boletos/${boletoId}/status`] = 'paid';
                updates[`/boletos/${boletoId}/paidBy`] = state.authId;
                updates[`/boletos/${boletoId}/paidAt`] = Date.now();

                // Log na conta do usuário
                const txRef = window.dbPush(window.dbRef(window.db, `transactions/${state.authId}`));
                updates[`/transactions/${state.authId}/${txRef.key}`] = {
                    type: 'BOLETO',
                    amount: boleto.value,
                    desc: boleto.description || 'Pagamento de Boleto',
                    date: Date.now()
                };

                await window.dbUpdate(window.dbRef(window.db), updates);
                state.user.balance -= boleto.value;
                return true;
            }
        }

        class AdminService {
            static async createBoleto(targetCpf, value, desc) {
                // Verificar permissão
                if (state.user.role !== 'admin' && state.user.role !== 'owner') {
                    LogService.add('SECURITY', `Tentativa não autorizada de criar boleto por ${state.authId}`, 'system');
                    throw new Error("Acesso Negado: Permissão insuficiente.");
                }

                const code = Date.now().toString() + Math.floor(Math.random()*1000);
                const boletoData = {
                    code: code,
                    value: parseFloat(value),
                    description: desc,
                    targetCpf: targetCpf || 'GLOBAL', // Global se vazio
                    status: 'pending',
                    createdAt: Date.now(),
                    createdBy: state.user.name
                };

                const newRef = window.dbPush(window.dbRef(window.db, 'boletos'));
                await window.dbSet(newRef, boletoData);
                return code;
            }

            static async getAllUsers() {
                 if (state.user.role !== 'admin' && state.user.role !== 'owner') return [];
                 const snap = await window.dbGet(window.dbRef(window.db, 'users'));
                 const users = [];
                 snap.forEach(c => users.push({id: c.key, ...c.val()}));
                 return users;
            }
        }

        class LogService {
            static add(type, msg, userId) {
                const logRef = window.dbPush(window.dbRef(window.db, 'logs'));
                window.dbSet(logRef, {
                    type, message: msg, userId: userId || 'anon', date: Date.now()
                });
            }
        }

        // --- SISTEMA DE NAVEGAÇÃO E RENDERING ---

        const Navigation = {
            navigate: (viewName) => {
                state.view = viewName;
                const root = document.getElementById('app-root');
                
                switch(viewName) {
                    case 'login':
                        root.innerHTML = Templates.login();
                        break;
                    case 'register':
                        root.innerHTML = Templates.register();
                        break;
                    case 'dashboard':
                        if(!state.user) { Navigation.navigate('login'); return; }
                        root.innerHTML = Templates.dashboard();
                        document.getElementById('ia-container').classList.remove('hidden');
                        Navigation.loadDashboardData();
                        break;
                    case 'admin':
                        if(!state.user || (state.user.role !== 'admin' && state.user.role !== 'owner')) {
                            UI.toast("Acesso Negado", 'error');
                            Navigation.navigate('dashboard');
                            return;
                        }
                        root.innerHTML = Templates.admin();
                        Navigation.loadAdminData();
                        break;
                }
            },

            loadDashboardData: () => {
                // Listener em tempo real do saldo e transações
                const userRef = window.dbRef(window.db, `users/${state.authId}`);
                window.dbOnValue(userRef, (snap) => {
                    const data = snap.val();
                    if(data) {
                        state.user = data; // Atualiza estado local
                        const balEl = document.getElementById('user-balance');
                        if(balEl) balEl.innerText = Utils.formatCurrency(data.balance);
                    }
                });

                // Transações
                const txRef = window.dbRef(window.db, `transactions/${state.authId}`);
                const q = window.dbQuery(txRef, window.dbOrderByChild('date')); // limitToLast(10)
                
                window.dbOnValue(q, (snap) => {
                    const list = document.getElementById('tx-list');
                    if(!list) return;
                    list.innerHTML = '';
                    const txs = [];
                    snap.forEach(c => txs.unshift(c.val())); // Reverse order
                    
                    if(txs.length === 0) {
                        list.innerHTML = '<div class="text-center" style="padding:20px; color:#999">Nenhuma transação recente.</div>';
                    } else {
                        txs.forEach(tx => {
                            const isOut = ['PIX_OUT', 'BOLETO', 'INVEST_LOSS'].includes(tx.type);
                            const icon = isOut ? 'arrow-up' : 'arrow-down';
                            const colorClass = isOut ? 'tx-out' : 'tx-in';
                            const signal = isOut ? '-' : '+';
                            
                            const html = `
                                <div class="transaction-item" tabindex="0" aria-label="${tx.desc}, valor ${Utils.formatCurrency(tx.amount)}">
                                    <div class="flex items-center">
                                        <div class="tx-icon ${colorClass}"><i class="fas fa-${icon}"></i></div>
                                        <div>
                                            <div class="font-bold">${tx.desc || tx.type}</div>
                                            <div class="text-sm text-secondary">${Utils.formatDate(tx.date)}</div>
                                        </div>
                                    </div>
                                    <div class="font-bold ${isOut ? 'text-error' : 'text-success'}">
                                        ${signal} ${Utils.formatCurrency(tx.amount)}
                                    </div>
                                </div>
                            `;
                            list.innerHTML += html;
                        });
                    }
                });
            },

            loadAdminData: async () => {
                // Carregar logs recentes e total de usuários
                const users = await AdminService.getAllUsers();
                document.getElementById('total-users').innerText = users.length;
                
                const tableBody = document.getElementById('user-table-body');
                tableBody.innerHTML = '';
                users.slice(0, 20).forEach(u => {
                    tableBody.innerHTML += `
                        <tr style="border-bottom:1px solid #eee;">
                            <td style="padding:10px;">${u.name}</td>
                            <td>${u.cpf}</td>
                            <td>${Utils.formatCurrency(u.balance)}</td>
                            <td><span class="badge">${u.role}</span></td>
                        </tr>
                    `;
                });
            }
        };

        const Templates = {
            login: () => `
                <div id="auth-view">
                    <div class="auth-container card">
                        <div class="brand-logo"><i class="fas fa-crown"></i></div>
                        <h2 class="text-center text-primary" style="margin-bottom:24px;">Banco Imperial</h2>
                        
                        <form onsubmit="event.preventDefault(); window.doLogin();">
                            <div class="input-group">
                                <label for="login-cpf">CPF</label>
                                <input type="text" id="login-cpf" class="input-control" placeholder="000.000.000-00" required>
                            </div>
                            <div class="input-group">
                                <label for="login-pass">Senha</label>
                                <input type="password" id="login-pass" class="input-control" placeholder="••••••" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Entrar na Conta</button>
                        </form>
                        
                        <div class="text-center" style="margin-top:20px;">
                            <p class="text-sm">Ainda não é cliente Imperial?</p>
                            <button onclick="Navigation.navigate('register')" class="btn btn-secondary w-full" style="margin-top:8px;">Abrir Conta Gratuita</button>
                        </div>
                         <div class="text-center" style="margin-top:20px; font-size: 0.7em; color: #888;">
                            Simulação Enterprise - v1.0
                        </div>
                    </div>
                </div>
            `,
            register: () => `
                <div id="auth-view">
                    <div class="auth-container card">
                        <div class="flex items-center gap-2" style="margin-bottom:20px; cursor:pointer" onclick="Navigation.navigate('login')">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </div>
                        <h2 class="text-primary">Seja Imperial</h2>
                        <p style="margin-bottom:20px; color:var(--color-text-secondary)">Preencha seus dados para abrir sua conta.</p>
                        
                        <form onsubmit="event.preventDefault(); window.doRegister();">
                            <div class="input-group">
                                <label>Nome Completo</label>
                                <input type="text" id="reg-name" class="input-control" required>
                            </div>
                            <div class="input-group">
                                <label>CPF</label>
                                <input type="text" id="reg-cpf" class="input-control" placeholder="Apenas números" required>
                            </div>
                             <div class="input-group">
                                <label>Email</label>
                                <input type="email" id="reg-email" class="input-control" required>
                            </div>
                            <div class="flex gap-2">
                                <div class="input-group w-full">
                                    <label>Senha</label>
                                    <input type="password" id="reg-pass" class="input-control" required>
                                </div>
                                <div class="input-group w-full">
                                    <label>Confirmar</label>
                                    <input type="password" id="reg-confirm" class="input-control" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-full">Finalizar Cadastro</button>
                        </form>
                    </div>
                </div>
            `,
            dashboard: () => `
                <div id="dashboard-view">
                    <aside class="sidebar">
                        <div class="brand-logo" style="font-size:2rem; margin-bottom:40px; text-align:left;">
                            <i class="fas fa-crown"></i> Imperial
                        </div>
                        
                        <nav>
                            <a class="nav-item active"><i class="fas fa-home"></i> Início</a>
                            <a class="nav-item" onclick="window.modalPix()"><i class="fas fa-random"></i> Área Pix</a>
                            <a class="nav-item" onclick="window.modalInvest()"><i class="fas fa-chart-line"></i> Investimentos</a>
                            <a class="nav-item" onclick="window.modalCards()"><i class="fas fa-credit-card"></i> Cartões</a>
                            <a class="nav-item" onclick="window.modalBoleto()"><i class="fas fa-barcode"></i> Pagar Boleto</a>
                            
                            ${(state.user.role === 'admin' || state.user.role === 'owner') ? 
                                `<a class="nav-item" onclick="Navigation.navigate('admin')" style="color:var(--color-primary); font-weight:bold"><i class="fas fa-shield-alt"></i> Admin Panel</a>` 
                                : ''}
                        </nav>

                        <div style="margin-top:auto;">
                            <div class="card" style="padding:16px; background: #f0ebf8;">
                                <small>Gerente da Conta</small><br>
                                <strong>Imperial IA</strong>
                            </div>
                            <button onclick="AuthService.logout()" class="btn btn-secondary w-full" style="margin-top:16px;">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </button>
                        </div>
                    </aside>

                    <main class="main-content">
                        <header class="flex justify-between items-center" style="margin-bottom:32px;">
                            <div>
                                <h2>Olá, ${state.user.name.split(' ')[0]}</h2>
                                <p class="text-sm text-secondary">Agência: ${state.user.agency} | Conta: ${state.user.accountNumber}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary" aria-label="Notificações"><i class="fas fa-bell"></i></button>
                                <button class="btn btn-secondary" aria-label="Configurações"><i class="fas fa-cog"></i></button>
                            </div>
                        </header>

                        <section class="card" style="background: linear-gradient(135deg, #4a148c, #7c43bd); color:white; margin-bottom:32px;">
                            <div class="flex justify-between items-center">
                                <span>Saldo Disponível</span>
                                <i class="fas fa-eye" onclick="this.classList.toggle('fa-eye-slash'); document.getElementById('user-balance').classList.toggle('balance-hidden')" style="cursor:pointer"></i>
                            </div>
                            <div id="user-balance" class="balance-display" style="color:white;">R$ ...</div>
                            <div class="flex gap-2" style="margin-top:20px;">
                                <button onclick="window.modalPix()" class="btn" style="background:rgba(255,255,255,0.2); color:white; border:none;">
                                    <i class="fas fa-paper-plane"></i> Transferir
                                </button>
                                <button onclick="window.modalBoleto()" class="btn" style="background:rgba(255,255,255,0.2); color:white; border:none;">
                                    <i class="fas fa-barcode"></i> Pagar
                                </button>
                            </div>
                        </section>

                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:32px;">
                            <div class="card flex flex-col items-center justify-center" style="cursor:pointer;" onclick="window.modalPix()">
                                <i class="fas fa-qrcode" style="font-size:2rem; color:var(--color-primary); margin-bottom:10px;"></i>
                                <strong>Pix Copia e Cola</strong>
                            </div>
                            <div class="card flex flex-col items-center justify-center" style="cursor:pointer;" onclick="window.modalCards()">
                                <i class="fas fa-credit-card" style="font-size:2rem; color:var(--color-primary); margin-bottom:10px;"></i>
                                <strong>Cartão Virtual</strong>
                            </div>
                            <div class="card flex flex-col items-center justify-center" style="cursor:pointer;" onclick="window.modalInvest()">
                                <i class="fas fa-chart-pie" style="font-size:2rem; color:var(--color-primary); margin-bottom:10px;"></i>
                                <strong>Investimentos</strong>
                            </div>
                        </div>

                        <section>
                            <h3 style="margin-bottom:16px;">Últimas Movimentações</h3>
                            <div class="card" style="padding:0;">
                                <div id="tx-list">
                                    <div style="padding:20px;">Carregando extrato...</div>
                                </div>
                                <div style="padding:16px; text-align:center; border-top:1px solid var(--color-border);">
                                    <a href="#" class="text-primary font-bold">Ver extrato completo</a>
                                </div>
                            </div>
                        </section>
                    </main>
                </div>

                <div id="modal-container" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:flex; align-items:center; justify-content:center;">
                    <div id="modal-content" class="card" style="width:90%; max-width:500px; max-height:90vh; overflow-y:auto; animation: slideUp 0.3s ease-out;">
                        </div>
                </div>
            `,
            admin: () => `
                <div style="padding:32px;">
                    <div class="flex justify-between">
                        <h1><i class="fas fa-shield-alt"></i> Painel Imperial</h1>
                        <button onclick="Navigation.navigate('dashboard')" class="btn btn-secondary">Voltar ao Banco</button>
                    </div>

                    <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; margin:32px 0;">
                        <div class="card">
                            <h3>Total Usuários</h3>
                            <div id="total-users" class="balance-display" style="font-size:2rem;">...</div>
                        </div>
                        <div class="card">
                            <h3>Sistema</h3>
                            <div class="text-success"><i class="fas fa-check-circle"></i> Online e Seguro</div>
                        </div>
                        <div class="card" style="background: var(--color-primary); color:white; cursor:pointer" onclick="window.createGlobalBoleto()">
                            <h3><i class="fas fa-bullhorn"></i> Criar Boleto Global</h3>
                            <p>Enviar cobrança para todos (RP)</p>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Usuários Recentes</h3>
                        <table style="width:100%; border-collapse:collapse; margin-top:16px;">
                            <thead>
                                <tr style="text-align:left; border-bottom:2px solid #eee;">
                                    <th style="padding:10px;">Nome</th>
                                    <th>CPF</th>
                                    <th>Saldo</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody id="user-table-body"></tbody>
                        </table>
                    </div>
                </div>
            `
        };

        // --- EXPORTAÇÃO GLOBAL DE FUNÇÕES (PARA O HTML PODER CHAMAR) ---

        window.doLogin = () => {
            const cpf = document.getElementById('login-cpf').value;
            const pass = document.getElementById('login-pass').value;
            AuthService.login(cpf, pass);
        };

        window.doRegister = () => {
            const data = {
                name: document.getElementById('reg-name').value,
                cpf: document.getElementById('reg-cpf').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-pass').value,
                confirmPassword: document.getElementById('reg-confirm').value,
            };
            AuthService.register(data);
        };

        window.Navigation = Navigation;
        window.AuthService = AuthService;

        // --- FUNÇÕES DE MODAL E OPERAÇÕES BANCÁRIAS ---

        window.closeModal = () => {
            document.getElementById('modal-container').classList.add('hidden');
        };

        window.modalPix = () => {
            const modal = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            content.innerHTML = `
                <div class="card-header">
                    <h3>Área Pix</h3>
                    <button onclick="window.closeModal()" style="border:none; background:none; font-size:1.5rem;">&times;</button>
                </div>
                <form onsubmit="event.preventDefault(); window.submitPix();">
                    <div class="input-group">
                        <label>CPF da Chave Pix</label>
                        <input type="text" id="pix-key" class="input-control" required placeholder="000.000.000-00">
                    </div>
                    <div class="input-group">
                        <label>Valor (R$)</label>
                        <input type="number" id="pix-amount" class="input-control" required step="0.01" min="0.01">
                    </div>
                    <div class="input-group">
                        <label>Descrição (Opcional)</label>
                        <input type="text" id="pix-desc" class="input-control" placeholder="Ex: Aluguel">
                    </div>
                    <button type="submit" class="btn btn-primary w-full"><i class="fas fa-paper-plane"></i> Enviar Pix</button>
                </form>
            `;
        };

        window.submitPix = async () => {
            const key = document.getElementById('pix-key').value;
            const amount = document.getElementById('pix-amount').value;
            const desc = document.getElementById('pix-desc').value;
            
            window.closeModal();
            UI.showLoader("Processando Pix...");
            try {
                await BankingService.sendPix(key, amount, desc);
                UI.toast("Transferência realizada com sucesso!", 'success');
            } catch(e) {
                UI.toast("Erro no PIX: " + e.message, 'error');
            } finally {
                UI.hideLoader();
            }
        };

        window.modalBoleto = () => {
            const modal = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            content.innerHTML = `
                <div class="card-header">
                    <h3>Pagar Boleto</h3>
                    <button onclick="window.closeModal()" style="border:none; background:none; font-size:1.5rem;">&times;</button>
                </div>
                <form onsubmit="event.preventDefault(); window.submitBoleto();">
                    <div class="input-group">
                        <label>Código do Boleto</label>
                        <input type="text" id="boleto-code" class="input-control" required placeholder="Cole o código aqui">
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Processar Pagamento</button>
                </form>
            `;
        };

        window.submitBoleto = async () => {
            const code = document.getElementById('boleto-code').value;
            window.closeModal();
            UI.showLoader("Validando Boleto...");
            try {
                await BankingService.payBoleto(code);
                UI.toast("Boleto pago com sucesso!", 'success');
            } catch(e) {
                UI.toast("Erro: " + e.message, 'error');
            } finally {
                UI.hideLoader();
            }
        };

        window.modalInvest = () => {
             const modal = document.getElementById('modal-container');
             const content = document.getElementById('modal-content');
             modal.classList.remove('hidden');
             content.innerHTML = `
                <div class="card-header">
                    <h3>Imperial Invest</h3>
                    <button onclick="window.closeModal()" style="border:none; background:none; font-size:1.5rem;">&times;</button>
                </div>
                <div style="background:#fff3cd; color:#856404; padding:10px; border-radius:4px; margin-bottom:15px; font-size:0.9rem;">
                    <strong>ALTO RISCO:</strong> Este investimento tem 85% de chance de perda total e 15% de chance de dobrar o valor.
                </div>
                <form onsubmit="event.preventDefault(); window.submitInvest();">
                    <div class="input-group">
                        <label>Valor para Aplicar (R$)</label>
                        <input type="number" id="invest-amount" class="input-control" required step="1" min="10">
                    </div>
                    <button type="submit" class="btn btn-accent w-full" style="font-weight:bold;">APOS... INVESTIR</button>
                </form>
             `;
        };

        window.submitInvest = async () => {
            const amount = parseFloat(document.getElementById('invest-amount').value);
            if(amount > state.user.balance) {
                UI.toast("Saldo insuficiente", 'error');
                return;
            }
            
            window.closeModal();
            UI.showLoader("Operando na Bolsa...");
            await Utils.sleep(2000); // Suspense

            const win = Math.random() > 0.85; // 15% chance
            const updates = {};
            
            let resultMsg = "";
            let type = "";

            if (win) {
                const profit = amount * 2;
                updates[`/users/${state.authId}/balance`] = state.user.balance + amount; // Ganha o dobro (recupera + lucro)
                type = 'INVEST_WIN';
                resultMsg = `PARABÉNS! Você ganhou ${Utils.formatCurrency(amount)} de lucro!`;
                UI.toast(resultMsg, 'success');
            } else {
                updates[`/users/${state.authId}/balance`] = state.user.balance - amount;
                type = 'INVEST_LOSS';
                resultMsg = `O mercado oscilou. Você perdeu ${Utils.formatCurrency(amount)}.`;
                UI.toast(resultMsg, 'error');
            }

            // Log
            const txRef = window.dbPush(window.dbRef(window.db, `transactions/${state.authId}`));
            updates[`/transactions/${state.authId}/${txRef.key}`] = {
                type: type,
                amount: amount,
                desc: win ? 'Lucro Investimento Imperial' : 'Prejuízo Investimento Imperial',
                date: Date.now()
            };

            await window.dbUpdate(window.dbRef(window.db), updates);
            state.user.balance = win ? state.user.balance + amount : state.user.balance - amount;
            UI.hideLoader();
        };
        
        window.modalCards = () => {
            const modal = document.getElementById('modal-container');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            // Simulação de dados do cartão
            const cardNum = "5500 **** **** " + state.user.accountNumber.substring(0,4);
            content.innerHTML = `
                <div class="card-header">
                    <h3>Meus Cartões</h3>
                    <button onclick="window.closeModal()" style="border:none; background:none; font-size:1.5rem;">&times;</button>
                </div>
                
                <div style="background: linear-gradient(135deg, #111, #333); color:white; padding:20px; border-radius:12px; margin-bottom:20px; position:relative; overflow:hidden;">
                    <div style="position:absolute; top:-20px; right:-20px; width:100px; height:100px; background:rgba(255,215,0,0.2); border-radius:50%;"></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
                        <i>Imperial Black</i>
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div style="font-family:monospace; font-size:1.4rem; letter-spacing:2px; margin-bottom:20px;">
                        ${cardNum}
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                        <div>
                            <div style="font-size:0.7rem; opacity:0.7;">TITULAR</div>
                            <div>${state.user.name.toUpperCase()}</div>
                        </div>
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2a/Mastercard-logo.svg/1280px-Mastercard-logo.svg.png" style="height:30px;">
                    </div>
                </div>

                <div class="flex gap-2">
                    <button class="btn btn-secondary w-full"><i class="fas fa-lock"></i> Bloquear</button>
                    <button class="btn btn-secondary w-full"><i class="fas fa-eye"></i> Ver CVV</button>
                </div>
            `;
        };

        window.createGlobalBoleto = async () => {
            const val = prompt("Valor do Boleto Global:");
            const desc = prompt("Descrição:");
            if(val && desc) {
                try {
                    const code = await AdminService.createBoleto('GLOBAL', val, desc);
                    alert(`Boleto Global Criado!\nCódigo: ${code}`);
                } catch(e) {
                    alert(e.message);
                }
            }
        };

        // --- CHAT IA ---
        
        window.toggleChat = () => {
            document.getElementById('chat-widget').classList.toggle('chat-collapsed');
        };

        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            const chatBody = document.getElementById('chat-messages');
            
            // User msg
            chatBody.innerHTML += `<div class="msg user">${text}</div>`;
            input.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;

            // Simular "Digitando..."
            await Utils.sleep(600 + Math.random() * 1000);

            // Respostas Regra-Based (Simulação IA)
            let response = "Desculpe, não entendi. Pode reformular?";
            const lowText = text.toLowerCase();

            if(lowText.includes('pix')) response = "Para fazer um Pix, clique em 'Área Pix' no menu ou nos atalhos rápidos. Você precisará do CPF do destinatário.";
            else if(lowText.includes('saldo') || lowText.includes('dinheiro')) response = `Seu saldo atual é de ${Utils.formatCurrency(state.user.balance)}.`;
            else if(lowText.includes('investimento') || lowText.includes('risco')) response = "Nosso investimento tem alto risco (85% chance de perda). Recomendamos cautela.";
            else if(lowText.includes('admin') || lowText.includes('dono')) response = "Contas administrativas são geridas apenas pelo Dono do Banco (Ryan).";
            else if(lowText.includes('ajuda') || lowText.includes('suporte')) response = "Estou aqui para ajudar! Tente perguntar sobre 'como transferir', 'cartão' ou 'investimentos'.";
            else if(lowText.includes('olá') || lowText.includes('oi')) response = `Olá, ${state.user.name.split(' ')[0]}! Como posso auxiliar suas finanças hoje?`;

            chatBody.innerHTML += `<div class="msg bot">${response}</div>`;
            chatBody.scrollTop = chatBody.scrollHeight;
        };


        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            UI.hideLoader();
            Navigation.navigate('login');
            
            // Easter egg Debug
            console.log("%c BANCO IMPERIAL ENTERPRISE ", "background: #4a148c; color: #ffd700; font-size: 20px; padding: 10px; border-radius: 5px;");
        };

    </script>
</body>
</html>
